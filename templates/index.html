<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="google-client-id" content="{{ GOOGLE_CLIENT_ID }}">
  <meta name="google-api-key" content="{{ GOOGLE_API_KEY }}">
  <meta name="spreadsheet-id" content="{{ SPREADSHEET_ID }}">

  <title>ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v1.4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
    }

    .gemini-output {
      background-color: #f0f9ff;
      border-left: 4px solid #0284c7;
      padding: 8px;
      font-size: 0.875rem;
      line-height: 1.5;
      color: #0c4a6e;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">

  <header class="bg-white shadow-md sticky top-0 z-40">
    <nav class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
      <h1 class="text-xl sm:text-2xl font-bold text-gray-800">ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  âœ¨</h1>
      <div class="hidden md:flex items-center space-x-4">
        <button id="nav-casting"
          class="nav-btn text-blue-600 border-b-2 border-blue-600 font-medium px-2 py-1">ã‚­ãƒ£ã‚¹ãƒˆã‚’æ¢ã™</button>
        <button id="nav-status"
          class="nav-btn text-gray-600 hover:text-blue-600 font-medium px-2 py-1">ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°çŠ¶æ³</button>
        <button id="nav-management"
          class="nav-btn text-gray-600 hover:text-blue-600 font-medium px-2 py-1">ç®¡ç†ç”»é¢</button>
        <button id="nav-cart" class="relative text-gray-600 hover:text-blue-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span id="cart-count"
            class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
        </button>
      </div>
      <div id="auth-container" class="hidden md:flex items-center">
        <span id="user-name" class="hidden text-sm text-gray-700 mr-4"></span>
        <button id="authorize_button"
          class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
        <button id="signout_button"
          class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </nav>
  </header>

  <main class="container mx-auto p-4 sm:p-6">
    <div id="loader" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
      <p class="text-white text-lg ml-4">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
    <div id="message-box"
      class="hidden fixed top-20 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50"></div>

    <div id="casting-view" class="view">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit">
          <h2 class="text-2xl font-bold mb-4">1. æ—¥ä»˜ã‚’é¸æŠ</h2>
          <div id="calendar-container">
            <div class="flex justify-between items-center mb-4">
              <button id="prev-month" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&lt;</button>
              <h3 id="current-month-year" class="text-lg font-semibold"></h3>
              <button id="next-month" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&gt;</button>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm"></div>
          </div>

          <hr class="my-6">
          <h2 class="text-2xl font-bold mb-4">2. æ’®å½±ã‚’é¸æŠ</h2>
          <div id="shooting-list-container" class="space-y-2 max-h-[60vh] overflow-y-auto">
            <p class="text-gray-500 text-sm">æ—¥ä»˜ã‚’é¸æŠã™ã‚‹ã¨ã€å€™è£œã®æ’®å½±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
          </div>
        </div>

        <div class="lg:col-span-3">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-2xl font-bold">3. ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠ</h2>
            <div class="inline-flex rounded-lg border text-xs overflow-hidden">
              <button id="view-mode-comfort" class="px-3 py-1 min-w-[3rem] text-center">3åˆ—</button>
              <button id="view-mode-dense" class="px-3 py-1 min-w-[3rem] text-center">5åˆ—</button>
            </div>
          </div>

          <!-- New Filters Area -->
          <!-- Existing Shootings (Additional Casting) -->
          <div id="shooting-list-container" class="mb-4 hidden"></div>

          <div id="cast-filters-container" class="bg-gray-50 p-4 rounded-lg mb-4 flex flex-wrap gap-4 items-end">
            <!-- Filters will be injected here -->
          </div>

          <p id="selected-period-display" class="text-gray-600 mb-4">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
          <div id="cast-list"
            class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 max-h-[75vh] overflow-y-auto p-2"></div>
        </div>
      </div>
    </div>

    <div id="status-view" class="view">
      <h2 class="text-3xl font-bold mb-4">ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°çŠ¶æ³</h2>
    </div>

    <div id="management-view" class="view">
      <div id="main-view">
        <!-- content will be injected here -->
      </div>
    </div>
  </main>

  <div id="cart-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop"></div>
  <div id="confirmation-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop"></div>
  <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop"></div>
  <div id="status-quick-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop"></div>
  <div id="new-external-cast-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
  </div>
  <div id="shoot-mail-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop"></div>

  <!-- No Shooting Selection Popup -->
  <div id="no-shooting-popup"
    class="hidden fixed inset-0 z-[70] flex items-center justify-center modal-backdrop bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
      <h3 class="text-lg font-bold text-gray-800 mb-4">æ’®å½±æ¡ˆä»¶ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
      <div class="flex flex-col gap-3">
        <button id="btn-order-external"
          class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">å¤–éƒ¨æ¡ˆä»¶ã¨ã—ã¦ã‚ªãƒ¼ãƒ€ãƒ¼ã™ã‚‹</button>
        <button id="btn-order-internal"
          class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">ç¤¾å†…ã‚¤ãƒ™ãƒ³ãƒˆç”¨ã«ã‚ªãƒ¼ãƒ€ãƒ¼ã™ã‚‹</button>
        <button id="btn-popup-back"
          class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">æ’®å½±é¸æŠã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Special Order Modal -->
  <div id="special-order-modal"
    class="hidden fixed inset-0 z-[80] flex items-center justify-center modal-backdrop bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
      <h3 id="special-order-title" class="text-xl font-bold text-gray-800 mb-4">ç‰¹åˆ¥ã‚ªãƒ¼ãƒ€ãƒ¼</h3>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¿ã‚¤ãƒˆãƒ« (æ¡ˆä»¶/ã‚¤ãƒ™ãƒ³ãƒˆå†…å®¹)</label>
        <input type="text" id="special-order-name" class="w-full border rounded px-3 py-2"
          placeholder="ä¾‹: ã€‡ã€‡CMæ’®å½±ã€ã€‡ã€‡ã‚¤ãƒ™ãƒ³ãƒˆ">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">é¸æŠä¸­ã®æ—¥ä»˜</label>
        <div id="special-order-date-list" class="text-sm text-gray-600 bg-gray-50 p-2 rounded max-h-24 overflow-y-auto">
        </div>
        <input type="hidden" id="special-order-dates-json">
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ™‚é–“</label>
          <input type="time" id="special-order-start" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">çµ‚äº†æ™‚é–“</label>
          <input type="time" id="special-order-end" class="w-full border rounded px-3 py-2">
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">é¸æŠä¸­ã®ã‚­ãƒ£ã‚¹ãƒˆ</label>
        <div id="special-order-cast-list" class="text-sm text-gray-600 bg-gray-50 p-2 rounded"></div>
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button id="btn-special-cancel" class="px-4 py-2 border rounded hover:bg-gray-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="btn-special-submit"
          class="px-6 py-2 bg-indigo-600 text-white font-bold rounded hover:bg-indigo-700">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <div id="progress-modal"
    class="hidden fixed inset-0 z-[60] flex items-center justify-center modal-backdrop bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
      <h3 id="progress-title" class="text-lg font-bold text-gray-800 mb-2">å‡¦ç†ä¸­...</h3>
      <p id="progress-message" class="text-sm text-gray-600 mb-4">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>

      <div class="w-full bg-gray-200 rounded-full h-4 mb-2 overflow-hidden">
        <div id="progress-bar-fill" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%">
        </div>
      </div>
      <div id="progress-percent" class="text-xs font-bold text-blue-600">0%</div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ========= Config =========
      const CLIENT_ID = document.querySelector('meta[name="google-client-id"]')?.content || '';
      const SPREADSHEET_ID = document.querySelector('meta[name="spreadsheet-id"]')?.content || '';
      const API_KEY = document.querySelector('meta[name="google-api-key"]')?.content || '';
      const DISCOVERY_DOCS = [
        "https://sheets.googleapis.com/$discovery/rest?version=v4",
        "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
        "https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest"
      ];
      const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/documents';

      // ========= State =========
      let tokenClient, gapiInited = false, gisInited = false;
      let currentUser = null, isAdmin = false;
      let castData = [], castingData = [], adminUsers = [];
      let shootingScheduleData = new Map(); // Map<castId, Set<dateString>>
      let cart = {}; // { [castId]: { cast, dates: string[], roleName?: string } }
      let cartMeta = {
        account: '',
        notionUrl: '',
        projectNames: ['', '', ''],
        combinedProjectNames: []
      };
      let cartStep = 1; // 1: STEP1ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å…¥åŠ›ï¼‰, 2: STEP2ï¼ˆã‚­ãƒ£ã‚¹ãƒˆç´ä»˜ã‘ï¼‰
      let selectedDates = [];
      let calendarDate = new Date();
      let statusMonth = loadStatusMonth() || new Date();
      let showPast = false;
      let statusOrderWaitOnly = false;
      const ORDER_WAIT_STATUSES = ['ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡', 'ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡ï¼ˆä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼‰'];
      let viewMode = 'comfort'; // 'comfort' or 'dense'
      let isAdditionalOrderMode = false;
      let additionalOrderContext = null;
      let shootingContactRows = [];
      let INTERNAL_HOLD_CALENDAR_ID = '';

      const loader = document.getElementById('loader');

      // ========= Helpers =========
      const groupBy = (array, key) => {
        return array.reduce((result, currentValue) => {
          (result[key(currentValue)] = result[key(currentValue)] || []).push(currentValue);
          return result;
        }, {});
      };

      const pad2 = n => String(n).padStart(2, '0');
      const d2str = d => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
      const TODAY_STR = d2str(new Date());
      const TODAY_EPOCH = toEpochDay(TODAY_STR);

      async function loadConfig() {
        try {
          const res = await fetch('/config');
          if (!res.ok) return;
          const conf = await res.json();
          INTERNAL_HOLD_CALENDAR_ID = conf.calendar_id_internal_hold || '';
        } catch (e) {
          console.warn('Failed to load config', e);
        }
      }

      function showLoader(show) { if (loader) loader.style.display = show ? 'flex' : 'none'; }
      function showMessage(message, type = 'success') {
        const box = document.getElementById('message-box'); if (!box) return;
        box.textContent = message;
        box.className = 'fixed top-20 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50';
        box.classList.add(type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500'));
        box.style.display = 'block'; setTimeout(() => { box.style.display = 'none'; }, 3000);
      }
      function updateCartCount() { const el = document.getElementById('cart-count'); if (el) el.textContent = Object.keys(cart).length; }

      function normalizeDateString(input) {
        if (!input) return null; if (typeof input !== 'string') input = String(input);

        // New: Handle MM/DD format
        const md = input.match(/^(\d{1,2})\/(\d{1,2})$/);
        if (md) {
          const year = new Date().getFullYear();
          return `${year}-${pad2(md[1])}-${pad2(md[2])}`;
        }

        const m = input.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})(?:[T\s].*)?$/);
        if (m) return `${m[1]}-${pad2(m[2])}-${pad2(m[3])}`;
        const n = Number(input);
        if (!Number.isNaN(n) && n > 20000 && n < 60000) {
          const epoch = new Date(Date.UTC(1899, 11, 30)); const d = new Date(epoch.getTime() + n * 86400000);
          return d2str(new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())));
        }
        const t = Date.parse(input); if (!Number.isNaN(t)) { const d = new Date(t); return d2str(d); }
        return null;
      }
      function toEpochDay(ymd) {
        if (!ymd) return null;
        const [y, m, d] = ymd.split('-').map(x => parseInt(x, 10));
        return Date.UTC(y, m - 1, d) / 86400000;
      }
      function groupDatesIntoRanges(dates) {
        if (!dates || dates.length === 0) return [];
        const arr = dates.map(normalizeDateString).filter(Boolean).sort();
        const res = []; let start = arr[0], prev = arr[0];
        const next = (s) => { const [y, m, d] = s.split('-').map(n => parseInt(n, 10)); const dt = new Date(Date.UTC(y, m - 1, d) + 86400000); return d2str(new Date(Date.UTC(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate()))); };
        for (let i = 1; i < arr.length; i++) { if (arr[i] !== next(prev)) { res.push({ start, end: prev }); start = arr[i]; } prev = arr[i]; }
        res.push({ start, end: prev }); return res;
      }
      function overlaps(aStart, aEnd, bStart, bEnd) {
        const as = toEpochDay(aStart), ae = toEpochDay(aEnd), bs = toEpochDay(bStart), be = toEpochDay(bEnd);
        if (as == null || ae == null || bs == null || be == null) return false;
        return !(ae < bs || be < as);
      }
      function saveStatusMonth(d) { localStorage.setItem('status_month', `${d.getFullYear()}-${pad2(d.getMonth() + 1)}`); }
      function loadStatusMonth() {
        const s = localStorage.getItem('status_month'); if (!s) return null;
        const m = s.match(/^(\d{4})[-/](\d{2})$/); if (!m) return null;
        return new Date(parseInt(m[1]), parseInt(m[2]) - 1, 1);
      }

      function calculateAge(dateString) {
        if (!dateString) return null;
        const bd = new Date(dateString), today = new Date();
        let age = today.getFullYear() - bd.getFullYear();
        const mm = today.getMonth() - bd.getMonth();
        if (mm < 0 || (mm === 0 && today.getDate() < bd.getDate())) age--;
        return age;
      }

      function extractNotionPageId(url) {
        if (!url) return "";
        const m = String(url).match(/[0-9a-f]{32}/i);
        if (!m) return "";
        const s = m[0].toLowerCase();
        return `${s.substring(0, 8)}-${s.substring(8, 12)}-${s.substring(12, 16)}-${s.substring(16, 20)}-${s.substring(20)}`;
      }

      function findExistingThreadForOrder(accountName, projectId, dateRanges) {
        // projectId ãŒç©ºã®å ´åˆã¯ã€åˆ¥æ¡ˆä»¶ã¨ã¿ãªã—ã¦ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å†åˆ©ç”¨ã—ãªã„
        if (!projectId) return null;

        // projectId ã¨ accountName ãŒä¸€è‡´ã—ã€ã‹ã¤ slackThreadTs ã‚’æŒã¤ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã™
        // æ—¥ä»˜ã®é‡ãªã‚Šã¯ãƒã‚§ãƒƒã‚¯ã›ãšã€æ¡ˆä»¶å˜ä½ã§ã–ã£ãã‚Šæ¢ã™
        const cand = castingData.find(c =>
          c.accountName === accountName &&
          c.projectId === projectId &&
          c.slackThreadTs
        );
        return cand || null;
      }

      function switchView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId)?.classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => {
          b.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
          if (b.id.includes(viewId.split('-')[0])) b.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        });
      }
      function updateSelectedPeriodDisplay() {
        const el = document.getElementById('selected-period-display'); if (!el) return;
        if (selectedDates.length === 0) el.textContent = 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„';
        else if (selectedDates.length === 1) el.textContent = `é¸æŠä¸­ã®æ—¥ä»˜: ${selectedDates[0]}`;
        else el.textContent = `é¸æŠä¸­ã®æœŸé–“: ${selectedDates[0]} ~ ${selectedDates[selectedDates.length - 1]} (${selectedDates.length}æ—¥é–“)`;
      }

      // ========= Auth State =========
      let codeClient;     // â†è¿½åŠ : Code Flowç”¨

      // ========= Auth Functions =========
      function gapiLoaded() { gapi.load('client', initializeGapiClient); }
      async function initializeGapiClient() {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
        gapiInited = true;
        maybeCheckSession(); // ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
      }

      function gisLoaded() {
        // â˜…å¤‰æ›´: initCodeClient ã‚’ä½¿ç”¨
        codeClient = google.accounts.oauth2.initCodeClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          ux_mode: 'popup',
          callback: async (response) => {
            if (response.code) {
              // 1. ã‚µãƒ¼ãƒãƒ¼ã«ã‚³ãƒ¼ãƒ‰ã‚’é€ã‚Šã€Cookie(Refresh Token)ã‚’ã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚‰ã†
              showLoader(true);
              try {
                const res = await fetch('/api/auth/login', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ code: response.code })
                });

                if (res.ok) {
                  const data = await res.json();
                  // 2. è¿”ã£ã¦ããŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’gapiã«ã‚»ãƒƒãƒˆ
                  gapi.client.setToken({ access_token: data.access_token });
                  updateUI(true);
                  showMessage('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¾ã—ãŸ');
                } else {
                  throw new Error('Server login failed');
                }
              } catch (e) {
                console.error(e);
                showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                updateUI(false);
              } finally {
                showLoader(false);
              }
            }
          },
        });
        gisInited = true;
        maybeCheckSession();
      }

      // â˜…è¿½åŠ : ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚µãƒ¼ãƒãƒ¼ã®Cookieã‚’ä½¿ã£ã¦ãƒˆãƒ¼ã‚¯ãƒ³å†ç™ºè¡Œã‚’è©¦ã¿ã‚‹
      async function maybeCheckSession() {
        if (!gapiInited || !gisInited) return;

        // ã™ã§ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹ãªã‚‰ä½•ã‚‚ã—ãªã„
        if (gapi.client.getToken()) return;

        console.log("Checking session...");
        try {
          const res = await fetch('/api/auth/refresh');
          if (res.ok) {
            const data = await res.json();
            if (data.access_token) {
              console.log("Session restored!");
              gapi.client.setToken({ access_token: data.access_token });
              updateUI(true);
              return;
            }
          }
        } catch (e) {
          console.warn("Session check failed", e);
        }
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã‘ã‚Œã°æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹
        updateUI(false);
      }

      function handleAuthClick() {
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å‡ºã—ã¦èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        codeClient.requestCode();
      }

      async function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          gapi.client.setToken('');
        }
        // ã‚µãƒ¼ãƒãƒ¼å´ã®Cookieå‰Šé™¤
        try { await fetch('/api/auth/logout', { method: 'POST' }); } catch (e) { }

        updateUI(false);
        showMessage('ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'info');
      }

      // APIã‚³ãƒ¼ãƒ«ã®å‰ã«ç¢ºå®Ÿã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
      async function ensureAuth() {
        const token = gapi.client.getToken();
        if (token && token.access_token) return true;

        // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã€è£ã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’è©¦ã¿ã‚‹
        try {
          const res = await fetch('/api/auth/refresh');
          if (res.ok) {
            const data = await res.json();
            gapi.client.setToken({ access_token: data.access_token });
            return true;
          }
        } catch (e) {
          console.error(e);
        }
        return false;
      }

      async function updateUI(isAuthorized) {
        const auth = document.getElementById('authorize_button'), out = document.getElementById('signout_button');
        if (auth) auth.style.display = isAuthorized ? 'none' : 'block';
        if (out) out.style.display = isAuthorized ? 'block' : 'none';

        if (isAuthorized) {
          try {
            await getUserProfile();
            await loadConfig();
            await loadAllData();

            // 9. ç®¡ç†è€…ã®ã¿æ“ä½œå¯èƒ½ã«ã™ã‚‹
            if (isAdmin) {
              document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            }

            switchView('casting-view');
          } catch (err) {
            console.error('Auth/Data failed', err);
            const msg = err.result?.error?.message || err.message || JSON.stringify(err);
            alert(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ${msg}\n\nOKã‚’æŠ¼ã™ã¨ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚`);
            handleSignoutClick();
          }
        } else {
          currentUser = null; isAdmin = false;
          document.getElementById('user-name')?.classList.add('hidden');
          document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
          document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
          showMessage('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã€ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚', 'info');
          showLoader(false);
        }
      }
      async function getUserProfile() {
        const res = await gapi.client.oauth2.userinfo.get(); currentUser = res.result;
        const el = document.getElementById('user-name'); if (el) { el.textContent = `ã‚ˆã†ã“ã ${currentUser.name} ã•ã‚“`; el.classList.remove('hidden'); }
      }

      // ========= Data =========
      async function loadAllData() {
        showLoader(true);
        try {
          const res = await gapi.client.sheets.spreadsheets.values.batchGet({
            spreadsheetId: SPREADSHEET_ID,
            ranges: [
              'ã‚­ãƒ£ã‚¹ãƒˆãƒªã‚¹ãƒˆ!A2:N',
              'ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!A2:T',
              'æ¨©é™ç®¡ç†ãƒªã‚¹ãƒˆ!A2:B',
              'æ’®å½±ã‚¹ã‚±_ã‚­ãƒ£ã‚¹ãƒˆ!A2:Z', // ä¿®æ­£: ç¯„å›²ã‚’åºƒã‚ã«ç¢ºä¿
              'æ–°é¦™ç›¤æ’®å½±ãƒªã‚¹ãƒˆ!A2:F',
              'å†…éƒ¨ã‚­ãƒ£ã‚¹ãƒˆDB!A2:E'
            ],
          });
          const vr = res.result.valueRanges;

          if (!vr || vr.length < 3) throw new Error('å¿…è¦ãªã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');

          // Casts (No change needed here, reusing existing logic below)
          const castValues = vr[0].values || [];
          castData = castValues
            .filter(r => r && (r[1]?.trim() || r[0]?.trim()))
            .map((row, idx) => {
              const id = row[0]?.trim() || `cast_${idx + 1}`;
              const name = row[1]?.trim() || `æœªç™»éŒ²ã‚­ãƒ£ã‚¹ãƒˆ${idx + 1}`;
              const gender = row[2]?.trim() || '';
              const dob = row[3]?.trim() || '';
              const agency = row[4]?.trim() || 'ãƒ•ãƒªãƒ¼';
              let imageUrl = row[5]?.trim() || '';
              if (imageUrl && !imageUrl.toLowerCase().startsWith('http')) {
                imageUrl = '';
              }
              const appearance = Number.parseInt(row[6], 10);
              const email = row[7]?.trim() || '';
              const notes = row[8]?.trim() || '';
              const castType = row[9]?.trim() || '';

              const isInternal = castType === 'å†…éƒ¨';
              const slackMentionId = row[10]?.trim() || '';

              const snsX = row[11]?.trim() || '';
              const snsInsta = row[12]?.trim() || '';
              const snsTiktok = row[13]?.trim() || '';

              return {
                castId: id, name, gender, dateOfBirth: dob, age: dob ? calculateAge(dob) : null,
                agency, imageUrl, appearanceCount: Number.isFinite(appearance) ? appearance : 0, email, notes,
                castType,
                isInternal,
                internalType: castType,
                slackMentionId,
                snsX, snsInsta, snsTiktok
              };
            });

          // Casting
          const castMap = new Map(castData.map(c => [c.castId, c]));
          const castingValues = vr[1].values || [];

          castingData = castingValues.map(row => {
            const start = normalizeDateString(row?.[6] || '');
            const end = normalizeDateString(row?.[7] || '');
            const castId = row?.[4] || '';
            const base = castMap.get(castId);
            const isInternal = base?.isInternal ?? false;

            let slackThreadTs = row?.[11] || '';
            const slackPermalink = row?.[12] || '';
            if ((!slackThreadTs || /^\d{10}$/.test(slackThreadTs)) && slackPermalink) {
              const m = slackPermalink.match(/p(\d{16})/);
              if (m) {
                const raw = m[1];
                slackThreadTs = raw.slice(0, 10) + "." + raw.slice(10);
              }
            }

            return {
              castingId: row?.[0] || '',
              accountName: row?.[1] || '',
              projectName: row?.[2] || '',
              roleName: row?.[3] || '',
              castId: castId,
              castName: row?.[5] || '',
              startDate: start, endDate: end,
              startDay: toEpochDay(start), endDay: toEpochDay(end),
              rank: row?.[8] || '',
              status: row?.[9] || '',
              note: row?.[10] || '',
              slackThreadTs: slackThreadTs,
              slackPermalink: slackPermalink,
              mainSub: row?.[13] || 'ãã®ä»–',
              calendarEventId: row?.[14] || '',
              projectId: row?.[15] || '',
              lastUpdated: row?.[16] || '',
              updatedBy: row?.[17] || '',
              castPriority: Number.parseInt(row?.[18], 10),
              isInternal,
              castType: row?.[19] || (isInternal ? 'å†…éƒ¨' : 'å¤–éƒ¨'),
              email: row?.[20] || '',
              cost: row?.[21] || '',
              structureData: row?.[22] ? JSON.parse(row[22]) : null
            };
          });

          // Roles
          const perm = vr[2].values || [];
          const roleByEmail = new Map();
          for (const row of (perm || [])) {
            const email = (row?.[0] || '').trim().toLowerCase();
            const role = (row?.[1] || '').trim().toLowerCase() || 'viewer';
            if (email) roleByEmail.set(email, role);
          }
          const myEmail = (currentUser?.email || '').toLowerCase();
          isAdmin = (roleByEmail.get(myEmail) === 'admin');

          // 4. Shooting Schedule (æ’®å½±ã‚¹ã‚±_ã‚­ãƒ£ã‚¹ãƒˆ) ã®å¾©æ—§
          // 4. Shooting Schedule (æ’®å½±ã‚¹ã‚±_ã‚­ãƒ£ã‚¹ãƒˆ) ã®ä¿®æ­£
          if (vr.length > 3 && vr[3].values) {
            const scheduleValues = vr[3].values || [];

            // â˜…ä¿®æ­£: Aåˆ—=ã‚­ãƒ£ã‚¹ãƒˆå, Båˆ—ä»¥é™=æ—¥ä»˜
            shootingScheduleData.clear(); // Map<castId, Set<dateString>>

            scheduleValues.forEach(row => {
              const castName = row[0]?.trim(); // Aåˆ—: ã‚­ãƒ£ã‚¹ãƒˆå
              if (!castName) return;

              // åå‰ã‹ã‚‰ã‚­ãƒ£ã‚¹ãƒˆIDã‚’é€†å¼•ã
              const cast = castData.find(c => c.name === castName);
              if (cast) {
                if (!shootingScheduleData.has(cast.castId)) {
                  shootingScheduleData.set(cast.castId, new Set());
                }

                // Båˆ—(ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1)ä»¥é™ã‚’ã™ã¹ã¦æ—¥ä»˜ã¨ã—ã¦ãƒã‚§ãƒƒã‚¯
                for (let i = 1; i < row.length; i++) {
                  const dateRaw = row[i];
                  if (!dateRaw) continue;

                  const date = normalizeDateString(dateRaw);
                  if (date) {
                    shootingScheduleData.get(cast.castId).add(date);
                  }
                }
              }
            });
            console.log("Shooting Schedule Loaded:", shootingScheduleData.size, "casts active.");
          }

          // New Shooting List (æ–°é¦™ç›¤æ’®å½±ãƒªã‚¹ãƒˆ)
          if (vr.length > 4 && vr[4].values) {
            const slValues = vr[4].values || [];
            window.shootingListData = slValues.map(row => ({
              pageId: row[0] || '',
              title: row[1] || '',
              date: normalizeDateString(row[2]),
              team: row[3] || '',
              cd: row[4] || '',
              fd: row[5] || ''
            })).filter(item => item.date);
          } else {
            window.shootingListData = [];
          }

          // Internal Cast DB
          window.internalCastMap = new Map();
          if (vr.length > 5 && vr[5].values) {
            const icValues = vr[5].values || [];
            icValues.forEach(row => {
              const name = row[0]?.trim();
              const uid = row[4]?.trim();
              if (name && uid) {
                window.internalCastMap.set(name, uid);
              }
            });
          }

          renderCalendar();
          renderFilters();
          renderShootingList();
          displayAvailableCasts();

        } catch (err) {
          console.error('Data loading error:', err);
          showMessage('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ‰±ã„ã«ã™ã‚‹
          handleSignoutClick();
        } finally { showLoader(false); }
      }

      // ã‚·ãƒ¼ãƒˆã€Œã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆã€ã‹ã‚‰æœ€æ–°ã‚’å†å–å¾—
      async function fetchCastingDataFromSheet() {
        const getRes = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!A2:W' // A-Wåˆ—ã¾ã§å–å¾— (U:Email, V:Cost, W:Structure)
        });
        const rows = getRes.result.values || [];

        const castMap = new Map(castData.map(c => [c.castId, c])); // ãƒãƒƒãƒ—å†ä½œæˆ

        castingData = rows.map(row => {
          const start = normalizeDateString(row?.[6] || '');
          const end = normalizeDateString(row?.[7] || '');
          const priority = Number.parseInt(row?.[17], 10);
          const castId = row?.[4] || '';

          // â˜…ä¿®æ­£: isInternal ã®åˆ¤å®š
          const base = castMap.get(castId);
          const isInternal = base?.isInternal ?? false;

          let slackThreadTs = row?.[11] || '';
          const slackPermalink = row?.[12] || '';

          // ã‚‚ã— thread_ts ãŒç©º or 10æ¡ã®æ•´æ•°ã£ã½ã„å ´åˆã¯ã€permalink ã‹ã‚‰å¾©å…ƒã‚’è©¦ã¿ã‚‹
          if ((!slackThreadTs || /^\d{10}$/.test(slackThreadTs)) && slackPermalink) {
            // ä¾‹: https://.../p1763537866119239 ã‹ã‚‰ 1763537866.119239 ã‚’å¾©å…ƒ
            // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã£ã¦ã‚‚ãƒãƒƒãƒã™ã‚‹ã‚ˆã†ã« $ ã‚’å‰Šé™¤
            const m = slackPermalink.match(/p(\d{16})/);
            if (m) {
              const raw = m[1]; // "1763537866119239"
              slackThreadTs = raw.slice(0, 10) + "." + raw.slice(10); // "1763537866.119239"
            }
          }

          // JSONãƒ‘ãƒ¼ã‚¹ (Wåˆ—)
          let structureData = [];
          try {
            if (row?.[22]) {
              structureData = JSON.parse(row[22]);
            }
          } catch (e) {
            console.warn("Failed to parse structureData", e);
          }

          return {
            castingId: row?.[0] || '',
            accountName: row?.[1] || '',
            projectName: row?.[2] || '',
            roleName: row?.[3] || '',
            castId: castId,
            castName: row?.[5] || '',
            startDate: start,
            endDate: end,
            startDay: toEpochDay(start),
            endDay: toEpochDay(end),
            rank: row?.[8] || '',
            status: row?.[9] || '',
            note: row?.[10] || '',
            slackThreadTs,
            slackPermalink,
            mainSub: row?.[13] || 'ãã®ä»–',     // Nåˆ—
            calendarEventId: row?.[14] || '', // Oåˆ—
            projectId: row?.[15] || '',       // Påˆ—
            lastUpdated: row?.[16] || '',     // æ—§15 -> 16 (Qåˆ—)
            updatedBy: row?.[17] || '',       // æ—§16 -> 17 (Råˆ—)
            castPriority: Number.parseInt(row?.[18], 10), // æ—§17 -> 18 (Såˆ—)
            // Tåˆ—(19) is unused or reserved?
            email: row?.[20] || '',           // Uåˆ—: Email
            cost: row?.[21] || '',            // Våˆ—: Cost
            structureData: structureData,     // Wåˆ—: Structure
            isInternal,
          };
        });
      }

      // ========= Casting view =========
      // ä¿®æ­£: ãƒãƒ¼ãƒ åã‚’è¿”ã™ã‚ˆã†ã«å¤‰æ›´
      function getCastStatusForDates(castId, dates) {
        if (!dates || dates.length === 0) return {
          isProvisional: false, isConfirmed: false, isShooting: false, isNG: false,
          holdingTeams: []
        };

        const targetDates = dates.map(normalizeDateString).filter(v => v != null);
        const targetEpochs = targetDates.map(toEpochDay);

        let isProv = false, isConf = false, isShooting = false, isNG = false;
        let is1st = false, is2nd = false;
        const holdingTeams = new Set(); // ä»®æŠ¼ã•ãˆã—ã¦ã„ã‚‹ãƒãƒ¼ãƒ å

        const CONFIRM_STATUS = ['æ±ºå®š', 'OK'];
        const NG_STATUS = ['NG'];
        const PROV_STATUS = [
          'ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°', 'ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡', 'ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡ï¼ˆä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼‰',
          'æ‰“è¨ºä¸­', 'æ¡ä»¶ã¤ãOK'
        ];

        const bookings = castingData.filter(c => c.castId === castId && c.startDay != null && c.endDay != null);

        for (const day of targetEpochs) {
          if (isConf) break; // æ±ºå®šæ¸ˆã¿ãªã‚‰ãƒ«ãƒ¼ãƒ—çµ‚äº†

          for (const b of bookings) {
            if (day >= b.startDay && day <= b.endDay) {
              if (CONFIRM_STATUS.includes(b.status)) {
                isConf = true;
              } else if (NG_STATUS.includes(b.status)) {
                isNG = true;
              } else if (PROV_STATUS.includes(b.status)) {
                isProv = true;
                // ãƒãƒ¼ãƒ åï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆåï¼‰ã‚’è¨˜éŒ²
                if (b.accountName) {
                  holdingTeams.add(b.accountName);
                }
              }

              // é †ä½ãƒã‚§ãƒƒã‚¯
              if (b.status.includes('ç¬¬1å€™è£œ')) is1st = true;
              if (b.status.includes('ç¬¬2å€™è£œ')) is2nd = true;
            }
          }
        }

        // æ’®å½±ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒã‚§ãƒƒã‚¯
        if (!isConf) {
          const schedule = shootingScheduleData.get(castId);
          if (schedule) {
            for (const d of targetDates) {
              if (schedule.has(d)) {
                isShooting = true;
                break;
              }
            }
          }
        }

        return {
          isProvisional: isProv,
          isConfirmed: isConf,
          isShooting: isShooting,
          isNG: isNG,
          is1st, is2nd,
          holdingTeams: Array.from(holdingTeams) // é…åˆ—ã«ã—ã¦è¿”ã™
        };
      }

      // ä¿®æ­£: ãƒãƒ¼ãƒ åã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ãƒãƒƒã‚¸ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’å¤‰æ›´
      function displayAvailableCasts() {
        const list = document.getElementById('cast-list'); if (!list) return;
        list.innerHTML = '';

        // D-2: viewMode ã«å¿œã˜ã¦ CSS ã‚¯ãƒ©ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
        if (viewMode === 'comfort') {
          list.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 max-h-[75vh] overflow-y-auto p-2';
        } else { // dense
          list.className = 'grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-4 max-h-[75vh] overflow-y-auto p-2';
        }

        // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
        const comfortBtn = document.getElementById('view-mode-comfort');
        const denseBtn = document.getElementById('view-mode-dense');
        if (comfortBtn && denseBtn) {
          if (viewMode === 'comfort') {
            comfortBtn.classList.add('bg-blue-500', 'text-white');
            comfortBtn.classList.remove('bg-white', 'text-gray-700');
            denseBtn.classList.add('bg-white', 'text-gray-700');
            denseBtn.classList.remove('bg-blue-500', 'text-white');
          } else {
            denseBtn.classList.add('bg-blue-500', 'text-white');
            denseBtn.classList.remove('bg-white', 'text-gray-700');
            comfortBtn.classList.add('bg-white', 'text-gray-700');
            comfortBtn.classList.remove('bg-blue-500', 'text-white');
          }
        }

        if (selectedDates.length === 0) {
          list.innerHTML = `<p class="col-span-full text-center text-gray-500 pt-10">æ—¥ä»˜ã‚’é¸æŠã™ã‚‹ã¨ã€ã‚­ãƒ£ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>`;
          return;
        }

        const filtered = getFilteredCasts();

        // C-1: ã€Œï¼‹æ–°è¦å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã€ã‚«ãƒ¼ãƒ‰ã‚’å¸¸é§
        if (selectedDates.length > 0) {
          const newCard = document.createElement('div');
          newCard.className = 'bg-white rounded-lg shadow-md flex flex-col items-center justify-center border-2 border-dashed border-blue-400 cursor-pointer hover:bg-blue-50';
          newCard.innerHTML = `
        <div class="p-6 flex flex-col items-center justify-center">
          <div class="w-12 h-12 rounded-full border-2 border-blue-400 flex items-center justify-center mb-3">
            <span class="text-2xl text-blue-500">ï¼‹</span>
          </div>
          <p class="font-semibold text-blue-600">æ–°è¦å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ </p>
          <p class="text-xs text-gray-500 mt-1 text-center">DBã«å­˜åœ¨ã—ãªã„å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ã‹ã‚‰ã‚ªãƒ¼ãƒ€ãƒ¼</p>
        </div>`;
          newCard.addEventListener('click', () => {
            openNewExternalCastModal();
          });
          list.appendChild(newCard);
        }

        if (filtered.length === 0) {
          list.innerHTML += `<p class="col-span-full text-center text-gray-500 pt-10">æ¡ä»¶ã«åˆã†ã‚­ãƒ£ã‚¹ãƒˆãŒã„ã¾ã›ã‚“ã€‚</p>`;
          return;
        }

        filtered.forEach(cast => {
          const stat = getCastStatusForDates(cast.castId, selectedDates);
          const inCart = !!cart[cast.castId];

          let badges = [];
          let solid = false;

          if (stat.isConfirmed) {
            solid = true;
            badges.push(`<span class="bg-red-500 text-white text-xs font-semibold px-2 py-1 rounded-full">æ±ºå®š</span>`);
          } else if (stat.isNG) {
            solid = true;
            badges.push(`<span class="bg-gray-600 text-white text-xs font-semibold px-2 py-1 rounded-full">NG</span>`);
          } else {
            // ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã®å ´åˆã€ãƒãƒ¼ãƒ åã‚’è¡¨ç¤º
            if (stat.isProvisional) {
              if (stat.holdingTeams.length > 0) {
                // ä¾‹: "TeamA ä»®ã‚­ãƒ£ã‚¹ä¸­"
                stat.holdingTeams.forEach(team => {
                  badges.push(`<span class="bg-yellow-400 text-yellow-900 text-xs font-semibold px-2 py-1 rounded-full shadow-sm border border-yellow-500">${team} ä»®æŠ¼ã•ãˆ</span>`);
                });
              } else {
                badges.push(`<span class="bg-yellow-400 text-yellow-800 text-xs font-semibold px-2 py-1 rounded-full">ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ä¸­</span>`);
              }
            }
            if (stat.isShooting) {
              badges.push(`<span class="bg-cyan-400 text-cyan-900 text-xs font-semibold px-2 py-1 rounded-full border border-cyan-500">æ’®å½±ç¨¼åƒã‚ã‚Š</span>`);
            }
          }

          const badgeHtml = badges.length > 0 ? `<div class="absolute top-2 right-2 flex flex-col gap-1 items-end z-10">${badges.join('')}</div>` : '';

          const disabled = solid || inCart;
          const buttonLabel = stat.isConfirmed ? 'ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ä¸å¯' : (stat.isNG ? 'NG' : (inCart ? 'è¿½åŠ æ¸ˆã¿' : 'ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°'));

          const meta = []; if (cast.gender) meta.push(cast.gender); if (Number.isFinite(cast.age)) meta.push(`${cast.age}æ­³`); meta.push(`å‡ºæ¼”: ${cast.appearanceCount}å›`);

          // Helper to format Drive URL for embedding
          function formatDriveUrl(url) {
            if (!url) return "";
            if (url.includes("drive.google.com")) {
              let id = "";
              const idMatch = url.match(/id=([^&]+)/);
              const fileMatch = url.match(/\/file\/d\/([^/]+)/);
              if (idMatch) id = idMatch[1];
              else if (fileMatch) id = fileMatch[1];
              if (id) {
                return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
              }
            }
            return url;
          }

          const card = document.createElement('div');
          card.className = `bg-white rounded-lg shadow-md overflow-hidden flex flex-col relative ${(solid || inCart) ? 'opacity-50' : ''} cursor-pointer hover:shadow-lg transition-shadow group`;

          card.addEventListener('click', (e) => {
            if (e.target.closest('.add-to-cart-btn')) return;
            openCastDetailModal(cast.castId);
          });

          const displayUrl = cast.imageUrl ? formatDriveUrl(cast.imageUrl) : '';

          card.innerHTML = `
        ${displayUrl ? `<img src="${displayUrl}" alt="${cast.name}" class="w-full h-48 object-cover" referrerpolicy="no-referrer">`
              : `<div class="w-full h-48 bg-gray-300 flex items-center justify-center">
                              <svg class="w-12 h-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            </div>`}
        ${badgeHtml}
        <div class="p-4 flex-grow flex flex-col">
          <h3 class="text-lg font-bold">${cast.name}</h3>
          <p class="text-sm text-gray-600">${(cast.agency?.trim()) || 'ãƒ•ãƒªãƒ¼'}</p>
          <div class="mt-2 text-xs text-gray-500">${meta.join(' / ')}</div>
        </div>
        <div class="p-4 pt-0 mt-auto">
          <button data-cast-id="${cast.castId}" class="add-to-cart-btn w-full ${disabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'} text-white font-bold py-2 px-4 rounded-lg transition" ${disabled ? 'disabled' : ''}>${buttonLabel}</button>
          ${(!solid && stat.isShooting) ? '<p class="mt-2 text-xs text-cyan-700 font-bold">â€»åˆ¥ä»¶ã®æ’®å½±ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚</p>' : ''}
          ${(!solid && stat.isProvisional) ? '<p class="mt-2 text-xs text-amber-700 font-bold">â€»ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚</p>' : ''}
        </div>`;
          list.appendChild(card);
        });
      }

      function getFilteredCasts() {
        const kw = document.getElementById('filter-keyword')?.value?.trim()?.toLowerCase() || '';
        const m = document.getElementById('filter-gender-male')?.checked;
        const f = document.getElementById('filter-gender-female')?.checked;
        const minApp = parseInt(document.getElementById('filter-appearance')?.value, 10) || 0;
        const avail = document.getElementById('filter-available-only')?.checked;
        const agencies = Array.from(document.querySelectorAll('#agency-filter-dropdown input[type="checkbox"]:checked')).map(el => el.value);

        const filtered = castData.filter(c => {
          if (kw) {
            const hay = `${c.name || ''}\n${c.agency || ''}\n${c.notes || ''}`.toLowerCase();
            if (!hay.includes(kw)) return false;
          }
          if (m || f) {
            if (m && c.gender === 'ç”·æ€§') {/* ok */ }
            else if (f && c.gender === 'å¥³æ€§') {/* ok */ }
            else return false;
          }
          if (agencies.length > 0 && !agencies.includes(c.agency || 'ãƒ•ãƒªãƒ¼')) return false;
          if (c.appearanceCount < minApp) return false;
          if (avail && selectedDates.length > 0) {
            const s = getCastStatusForDates(c.castId, selectedDates);
            if (s.isProvisional || s.isConfirmed) return false;
          }
          return true;
        });

        const byApp = document.getElementById('sort-appearance')?.checked;
        const byKana = document.getElementById('sort-kana')?.checked;
        if (byApp) filtered.sort((a, b) => (b.appearanceCount ?? 0) - (a.appearanceCount ?? 0));
        else if (byKana) filtered.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja', { sensitivity: 'base' }));
        return filtered;
      }

      // ========= Status view =========
      // refresh=true: æç”»å‰ã«å¿…ãšã‚·ãƒ¼ãƒˆã‹ã‚‰å†å–å¾—
      window.currentStatusTab = 'casting'; // 'casting' (é€šå¸¸) | 'special' (å¤–éƒ¨/ç¤¾å†…)

      async function renderCastingStatusView(refresh = false) {
        const view = document.getElementById('status-view');
        if (!view) return;

        // Expose to window for onclick handlers
        window.renderCastingStatusView = renderCastingStatusView;

        if (refresh) {
          try { showLoader(true); await fetchCastingDataFromSheet(); }
          catch (e) { console.error(e); showMessage('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å†å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
          finally { showLoader(false); }
        }

        const y = statusMonth.getFullYear(), m = statusMonth.getMonth();
        const monthStart = new Date(y, m, 1), monthEnd = new Date(y, m + 1, 0);

        const header = `
          <div class="flex space-x-1 border-b mb-4">
            <button class="px-4 py-2 font-medium text-sm rounded-t-lg border-b-2 transition-colors ${window.currentStatusTab === 'casting' ? 'border-blue-500 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700'}"
              onclick="window.currentStatusTab = 'casting'; renderCastingStatusView(false);">
              ğŸ¬ é€šå¸¸ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°
            </button>
            <button class="px-4 py-2 font-medium text-sm rounded-t-lg border-b-2 transition-colors ${window.currentStatusTab === 'special' ? 'border-blue-500 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700'}"
              onclick="window.currentStatusTab = 'special'; renderCastingStatusView(false);">
              ğŸ¢ å¤–éƒ¨æ¡ˆä»¶ãƒ»ç¤¾å†…ã‚¤ãƒ™ãƒ³ãƒˆ
            </button>
          </div>
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <button id="status-prev-month" class="px-2 py-1 rounded border bg-white">&lt;</button>
              <div class="font-semibold">${y}å¹´${m + 1}æœˆ</div>
              <button id="status-next-month" class="px-2 py-1 rounded border bg-white">&gt;</button>
            </div>
            <div class="flex items-center gap-3">
              <label class="inline-flex items-center gap-1 text-sm">
                <input id="status-show-order-wait" type="checkbox" ${statusOrderWaitOnly ? 'checked' : ''} />
                <span>ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡ã®ã¿</span>
              </label>
              <label class="inline-flex items-center gap-1 text-sm">
                <input id="status-show-past" type="checkbox" ${showPast ? 'checked' : ''} />
                <span>éå»ã‚’è¡¨ç¤º</span>
              </label>
              <button id="status-reload" class="px-2 py-1 rounded border bg-white text-sm">å†èª­è¾¼</button>
            </div>
          </div>`;

        // const ORDER_WAIT_STATUSES = ['ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡', 'ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡ï¼ˆä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼‰']; // Moved to global scope

        const grouped = new Map();
        for (const c of castingData) {
          if (!c.startDate || !c.endDate) continue;
          const from = new Date(c.startDate);
          const to = new Date(c.endDate);
          let d = new Date(Math.max(from, monthStart));
          const lastDayInScope = new Date(Math.min(to, monthEnd));

          while (d <= lastDayInScope) {
            const dateKey = d2str(d);
            const epoch = toEpochDay(dateKey);
            if (!showPast && epoch < TODAY_EPOCH) {
              d.setDate(d.getDate() + 1);
              continue;
            }
            if (!grouped.has(dateKey)) grouped.set(dateKey, new Map());
            const dateGroup = grouped.get(dateKey);
            const accountName = c.accountName || 'N/A';
            if (!dateGroup.has(accountName)) dateGroup.set(accountName, new Map());
            const accountGroup = dateGroup.get(accountName);

            // Expand structureData if available
            if (c.structureData && Array.isArray(c.structureData) && c.structureData.length > 0) {
              c.structureData.forEach(item => {
                const pName = item.project || 'æœªå®š';
                if (!accountGroup.has(pName)) accountGroup.set(pName, []);
                // Create a virtual record for display
                accountGroup.get(pName).push({
                  ...c,
                  projectName: pName,
                  roleName: item.role || c.roleName,
                  rank: item.rank || c.rank,
                  mainSub: item.type || c.mainSub,
                  note: item.note || c.note
                });
              });
            } else {
              // Fallback for old data (merged)
              const projectName = c.projectName || 'N/A';
              if (!accountGroup.has(projectName)) accountGroup.set(projectName, []);
              accountGroup.get(projectName).push(c);
            }

            d.setDate(d.getDate() + 1);
          }
        }

        const sortedDates = Array.from(grouped.keys()).sort();
        let html = header;
        const SPECIAL_ACCOUNTS = ['å¤–éƒ¨æ¡ˆä»¶', 'ç¤¾å†…ã‚¤ãƒ™ãƒ³ãƒˆ'];

        if (sortedDates.length === 0) {
          html += `<p class="text-gray-600">è©²å½“æœˆã®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ç™»éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
        } else {
          for (const date of sortedDates) {
            const dateGroup = grouped.get(date);
            let allRecordsInDate = Array.from(dateGroup.values()).flatMap(acc => Array.from(acc.values()).flat());
            const hasOrderWait = allRecordsInDate.some(it => ORDER_WAIT_STATUSES.includes(it.status));
            if (statusOrderWaitOnly && !hasOrderWait) continue;

            // â˜…ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°åˆ¤å®š (æ—¥ä»˜å˜ä½ã§è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹ã¯ã€ãã®æ—¥ä»˜ã«å«ã¾ã‚Œã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãƒ•ã‚£ãƒ«ã‚¿ã«åˆè‡´ã™ã‚‹ã‹ã§æ±ºã‚ã‚‹ï¼Ÿ
            // ã„ã‚„ã€æ—¥ä»˜ãƒ–ãƒ­ãƒƒã‚¯ã¯è¡¨ç¤ºã—ã¦ã€ãã®ä¸­ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã¹ãã‹ï¼Ÿ
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›: "è¡¨ç¤ºåˆ†ã‘ï¼ˆã‚¿ãƒ–åŒ–ï¼‰" -> ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã§è¡¨ç¤ºå†…å®¹ãŒå¤‰ã‚ã‚‹ã€‚
            // æ—¥ä»˜ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã”ã¨ã®ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚‹æ§‹é€ ã€‚
            // ãªã®ã§ã€æ—¥ä»˜ãƒ–ãƒ­ãƒƒã‚¯è‡ªä½“ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹ã¯ã€"ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒ1ã¤ã§ã‚‚ã‚ã‚‹ã‹" ã§æ±ºã‚ã‚‹ã¹ãã€‚

            const sortedAccounts = Array.from(dateGroup.keys()).sort();
            const visibleAccounts = sortedAccounts.filter(acc => {
              const isSpecial = SPECIAL_ACCOUNTS.includes(acc);

              if (window.currentStatusTab === 'special') {
                // ç‰¹åˆ¥ã‚¿ãƒ–: ç‰¹åˆ¥æ¡ˆä»¶ã ã‘ã‚’è¡¨ç¤º
                return isSpecial;
              } else {
                // é€šå¸¸ã‚¿ãƒ–: ç‰¹åˆ¥æ¡ˆä»¶ä»¥å¤–ã‚’è¡¨ç¤º
                return !isSpecial;
              }
            });

            if (visibleAccounts.length === 0) continue; // è¡¨ç¤ºã™ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãªã‘ã‚Œã°æ¬¡ã®æ—¥ä»˜ã¸

            html += `
          <div class="mt-6 border rounded-lg overflow-hidden status-date-group" data-date-block="${date}">
            <div class="flex items-center justify-between p-2 cursor-pointer date-header ${hasOrderWait ? 'bg-orange-50' : 'bg-gray-200'}" data-date-header="${date}">
              <h3 class="text-xl font-bold">${date}</h3>
              <button type="button" class="toggle-day flex items-center text-sm text-gray-700" data-toggle-date="${date}">
                <span class="toggle-icon mr-1">â–¼</span>
                <span>è©³ç´°</span>
              </button>
            </div>
            <div class="date-body p-2 bg-white" data-date-body="${date}">`;

            // â˜…è¿½åŠ ç¢ºèª: accountHtmlç”Ÿæˆæ™‚ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
            for (const account of visibleAccounts) {
              const accountGroup = dateGroup.get(account);

              // ç‰¹åˆ¥ã‚ªãƒ¼ãƒ€ãƒ¼ã®å ´åˆã€projectåã¯1ã¤ã—ã‹ãªã„ã“ã¨ãŒå¤šã„ãŒå¿µã®ç‚ºãƒ«ãƒ¼ãƒ—
              const sortedProjects = Array.from(accountGroup.keys()).sort();

              // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æœ‰ç„¡ãƒã‚§ãƒƒã‚¯
              let hasRecordsInAccount = false;

              // ä»®ã®HTMLãƒãƒƒãƒ•ã‚¡
              let tempAccountHtml = `<div class="ml-2 border-l-2 border-gray-300 pl-4 py-2">
                  <div class="flex items-center justify-between mb-1">
                    <h4 class="text-lg font-semibold text-gray-800">${account}</h4>
                  </div>`;

              for (const project of sortedProjects) {
                let records = accountGroup.get(project);

                // ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡ãƒ•ã‚£ãƒ«ã‚¿
                if (statusOrderWaitOnly) {
                  records = records.filter(it => ORDER_WAIT_STATUSES.includes(it.status));
                }

                if (records.length === 0) continue;
                hasRecordsInAccount = true;

                // â˜…è¿½åŠ : æ›´æ–°è€…ã®è¡¨ç¤º
                const updaters = [...new Set(records.map(r => r.updatedBy).filter(Boolean))];
                const updaterLabel = updaters.length > 0
                  ? `<span class="ml-2 text-xs text-gray-500 font-normal">by ${updaters.join(', ')}</span>`
                  : '';

                tempAccountHtml += `<div class="ml-4 mt-2">
                    <h5 class="font-medium text-gray-700 mb-1">${project}${updaterLabel}</h5>`;

                const tableRows = records.map(it => {
                  const cast = castData.find(c => c.castId === it.castId);
                  const castName = cast?.name || it.castId;
                  const [badgeClass, rowMutedClass] = (() => {
                    const s = it.status;
                    if (s === 'æ±ºå®š') return ['bg-red-100 text-red-700', ''];
                    if (s === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«') return ['bg-gray-200 text-gray-700', ''];
                    if (s === 'æ‰“è¨ºä¸­') return ['bg-blue-100 text-blue-700', ''];
                    if (s === 'æ¡ä»¶ã¤ãOK') return ['bg-emerald-100 text-emerald-700', ''];
                    if (s === 'NG') return ['bg-gray-300 text-gray-800', 'opacity-50'];
                    if (ORDER_WAIT_STATUSES.includes(s)) return ['bg-amber-100 text-amber-800', ''];
                    return ['bg-yellow-100 text-yellow-800', ''];
                  })();

                  // Order Wait ã®å ´åˆã¯é‡‘é¡ç·¨é›†å¯èƒ½ã«
                  let costDisplay = it.cost ? 'Â¥' + Number(it.cost).toLocaleString() : '-';
                  let actionCol = '';

                  if (ORDER_WAIT_STATUSES.includes(it.status)) {
                    costDisplay = `
                      <input type="text" class="status-cost-input border rounded px-1 py-0.5 text-xs w-20 text-right bg-gray-50 focus:bg-white focus:ring-1 focus:ring-blue-300" 
                             value="${it.cost || ''}" placeholder="Â¥">
                    `;
                    actionCol = `
                      <button class="px-2 py-1 bg-emerald-600 text-white rounded text-xs hover:bg-emerald-700 shadow-sm whitespace-nowrap"
                          onclick="saveCastingCost('${it.castingId}', '${it.status}', this)">
                          ä¿å­˜
                      </button>
                    `;
                  }

                  return `
                <tr class="border-b hover:bg-gray-50 casting-row ${rowMutedClass}" data-casting-id="${it.castingId}">
                  <td class="py-2 px-2">${it.roleName || '-'}</td>
                  <td class="py-2 px-2 text-center">${it.rank || '-'}</td>
                  <td class="py-2 px-2 text-center">${it.mainSub || '-'}</td>
                  <td class="py-2 px-2">${castName}</td>
                  <td class="py-2 px-2"><span class="inline-block text-xs px-2 py-1 rounded-full ${badgeClass}">${it.status || '-'}</span></td>
                  <td class="py-2 px-2 text-right">${costDisplay}</td>
                  <td class="py-2 px-2 text-xs text-gray-600">${it.note || ''}</td>
                  <td class="py-2 px-2 text-center">${actionCol}</td>
                </tr>`;
                }).join('');

                tempAccountHtml += `
              <div class="overflow-x-auto bg-white rounded-lg shadow-sm">
                <table class="min-w-full text-sm table-fixed">
                  <thead class="bg-gray-100">
                    <tr>
                      <th class="text-left py-2 px-2 w-24">å½¹å</th>
                      <th class="text-center py-2 px-2 w-12">å½¹å€™è£œ</th>
                      <th class="text-center py-2 px-2 w-16">åŒºåˆ†</th>
                      <th class="text-left py-2 px-2 w-32">ã‚­ãƒ£ã‚¹ãƒˆ</th>
                      <th class="text-left py-2 px-2 w-40">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                      <th class="text-right py-2 px-2 w-24">é‡‘é¡</th>
                      <th class="text-left py-2 px-2">å‚™è€ƒ</th>
                      <th class="text-center py-2 px-2 w-16">ä¿å­˜</th>
                    </tr>
                  </thead>
                  <tbody>${tableRows}</tbody>
                </table>
              </div></div>`;
              }

              tempAccountHtml += `</div>`;

              // ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒ1ã¤ã§ã‚‚ã‚ã‚Œã°HTMLã«è¿½åŠ 
              if (hasRecordsInAccount) {
                html += tempAccountHtml;
              }
            }
            html += `</div></div>`;
          }
        }

        view.innerHTML = html;

        view.querySelector('#status-prev-month')?.addEventListener('click', async () => { statusMonth.setMonth(statusMonth.getMonth() - 1); saveStatusMonth(statusMonth); await renderCastingStatusView(true); });
        view.querySelector('#status-next-month')?.addEventListener('click', async () => { statusMonth.setMonth(statusMonth.getMonth() + 1); saveStatusMonth(statusMonth); await renderCastingStatusView(true); });
        view.querySelector('#status-show-past')?.addEventListener('change', async e => { showPast = !!e.target.checked; await renderCastingStatusView(false); });
        view.querySelector('#status-show-order-wait')?.addEventListener('change', async e => { statusOrderWaitOnly = !!e.target.checked; await renderCastingStatusView(false); });
        view.querySelector('#status-reload')?.addEventListener('click', async () => { await renderCastingStatusView(true); });

        view.querySelectorAll('.date-header, .toggle-day').forEach(el => {
          el.addEventListener('click', (e) => {
            if (e.target.closest('button, a, input, select, textarea')) {
              if (e.target.closest('.toggle-day')) { } else { return; }
            }
            const date = el.getAttribute('data-date-header') || el.getAttribute('data-toggle-date');
            if (!date) return;
            const body = view.querySelector(`.date-body[data-date-body="${date}"]`);
            const icon = view.querySelector(`.toggle-day[data-toggle-date="${date}"] .toggle-icon`);
            if (!body) return;
            body.classList.toggle('hidden');
            if (icon) icon.textContent = body.classList.contains('hidden') ? 'â–¶' : 'â–¼';
          });
        });

        if (isAdmin) {
          view.querySelectorAll('.casting-row').forEach(row => {
            row.addEventListener('click', e => {
              if (e.target.closest('button, input')) return;
              const id = row.getAttribute('data-casting-id');
              if (id) handleCastingRowClick(id);
            });
          });
          view.querySelectorAll('[data-add-order="1"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const ds = e.currentTarget.dataset;
              // Rename startAdditionalOrder to openAdditionalOrderModal
              startAdditionalOrder({
                date: ds.date,
                accountName: ds.account,
                projectId: ds.projectId,
                slackThreadTs: ds.threadTs,
                slackPermalink: ds.permalink,
              });
            });
          });
        }
      }

      // ==== Admin: status change & edit ====

      // 2-3. postStatusUpdateToSlack ã®ä¿®æ­£
      async function postStatusUpdateToSlack(rec, newStatus, extraMessage) {
        try {
          // å†…éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã¯Slacké€šçŸ¥ã—ãªã„ãŒã€Notioné€£æºã®ãŸã‚ã«APIã¯å©ã
          // if (rec.isInternal) return; // Removed to allow Notion sync

          const payload = {
            castingId: rec.castingId,
            newStatus,
            castName: rec.castName || rec.castId || "",
            slackThreadTs: rec.slackThreadTs,
            slackPermalink: rec.slackPermalink || "",
            extraMessage: extraMessage || "",
            isInternal: !!rec.isInternal,
            projectId: rec.projectId || "", // Notion Page ID
            mainSub: rec.mainSub || "ãã®ä»–", // Cast Type
            orderDetails: rec.structureData || [] // â˜…è¿½åŠ : Wåˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹
          };

          const res = await fetch("/api/notify/status_update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            console.error("Slack status update notify failed", err);
            showMessage("Slackã¸ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é€šçŸ¥ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "error");
            return;
          }

        } catch (e) {
          console.error("Slack status update notify exception", e);
          showMessage("Slackã¸ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
        }
      }
      // â˜… å·®ã—æ›¿ãˆï¼šchangeCastingStatus å…¨ä½“
      async function changeCastingStatus(castingId, newStatus, extraArg = "") {
        if (!isAdmin) {
          showMessage('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
          return;
        }

        const rec = castingData.find(c => c.castingId === castingId);
        if (!rec) {
          showMessage('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
          return;
        }

        // â˜… ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ1: å¼•æ•°ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆï¼ˆã‚¯ã‚¤ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼‰ã¨æ–‡å­—åˆ—ã®å ´åˆã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º
        let finalExtraMessage = "";
        let options = {}; // Define options to avoid ReferenceError

        if (typeof extraArg === 'object' && extraArg !== null) {
          finalExtraMessage = extraArg.extraMessage || "";
          options = extraArg; // Assign extraArg to options
        } else {
          finalExtraMessage = extraArg || "";
        }

        // å¤‰æ›´å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿æŒ
        const prevStatus = rec.status;

        showLoader(true);
        try {
          // è¡Œç•ªå·å–å¾—
          const getRes = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: 'ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!A2:R'
          });
          const rows = getRes.result.values || [];
          let rowIdx = -1;
          for (let i = 0; i < rows.length; i++) {
            if (rows[i]?.[0] === castingId) {
              rowIdx = i;
              break;
            }
          }
          if (rowIdx === -1) {
            showMessage('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
            return;
          }
          const targetRow = rowIdx + 2;

          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹(Jåˆ—) ã¨ é‡‘é¡(Våˆ—) ã‚’æ›´æ–°
          const updates = [
            {
              range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!J${targetRow}`,
              values: [[newStatus]]
            }
          ];

          // options.cost ãŒã‚ã‚Œã° Våˆ—ã‚‚æ›´æ–°
          if (options && options.cost !== undefined) {
            updates.push({
              range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!V${targetRow}`,
              values: [[options.cost]]
            });
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚æ›´æ–°
            rec.cost = options.cost;
          }

          await gapi.client.sheets.spreadsheets.values.batchUpdate({
            spreadsheetId: SPREADSHEET_ID,
            resource: {
              valueInputOption: 'USER_ENTERED',
              data: updates
            }
          });

          // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
          rec.status = newStatus;

          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å´ã‚‚åŒæœŸ
          await updateCalendarEventOnStatusChange(rec, newStatus, targetRow);

          // ===== Slack é€šçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ =====
          // å†…éƒ¨/å¤–éƒ¨ãƒ•ãƒ©ã‚°ï¼ˆrec.isInternal ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ï¼‰
          const isInternalCast = rec.isInternal;
          const isExternal = !isInternalCast;

          const isFromDashing = (prevStatus === 'æ‰“è¨ºä¸­');
          const isFinal = ['æ±ºå®š', 'NG', 'æ¡ä»¶ã¤ãOK'].includes(newStatus);

          // å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã‹ã¤ã€ã€Œæ‰“è¨ºä¸­ã€â†’ã€Œæœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã¸ã®å¤‰æ›´æ™‚ã®ã¿é€šçŸ¥
          if (isExternal && isFromDashing && isFinal && rec.slackThreadTs) {
            const statusForSlack = newStatus === 'æ±ºå®š' ? 'OK' : newStatus;
            await postStatusUpdateToSlack(rec, statusForSlack, finalExtraMessage);
          }

          // ã€Œæ±ºå®šã€ã®æ™‚ã ã‘æ’®å½±é€£çµ¡DBã¸è¿½åŠ ï¼ˆå¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã®ã¿ï¼‰
          if (rec.isInternal) {
          }
          if ((newStatus === "æ±ºå®š" || newStatus === "OK") && !rec.isInternal) {
            const updaterEmail = currentUser?.email || '';

            // é¦™ç›¤DBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
            const scheduleKey = `${rec.castId}_${rec.startDate}`;
            const scheduleInfo = shootingScheduleData.get(scheduleKey) || {};

            try {
              const addRes = await fetch("/api/shooting_contact/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  castingId: rec.castingId,
                  account: rec.accountName,
                  projectName: rec.projectName,
                  notionId: rec.projectId, // Use original Project ID (Notion Page ID)
                  roleName: rec.roleName,
                  castName: rec.castName,
                  castType: rec.isInternal ? "å†…éƒ¨" : "å¤–éƒ¨",
                  shootDate: rec.startDate,
                  note: rec.note || "",
                  updatedBy: updaterEmail,
                  updatedAt: new Date().toISOString(),
                  mainSub: rec.mainSub || "ãã®ä»–",
                  cost: rec.cost || "" // â˜…è¿½åŠ : é‡‘é¡
                })
              });
              if (!addRes.ok) {
                console.error("Failed to add to shooting contact DB", await addRes.text());
              } else {
              }
            } catch (err) {
              console.error("Exception calling shooting_contact/add", err);
            }
          }

          showMessage('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
          await renderCastingStatusView(false);
          displayAvailableCasts();
        } catch (e) {
          console.error(e);
          showMessage('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        } finally {
          showLoader(false);
        }
      }
      async function openEditModal(castingId) {
        if (!isAdmin) { showMessage('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error'); return; }
        const rec = castingData.find(c => c.castingId === castingId);
        if (!rec) { showMessage('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error'); return; }

        const modal = document.getElementById('edit-modal'); if (!modal) return;
        modal.innerHTML = `
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-bold">ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ç·¨é›†</h3>
          <button id="edit-close" class="text-gray-600 hover:text-gray-800">&times;</button>
        </div>
        <div class="space-y-3">
          <div>
            <label class="text-sm text-gray-700">ä½œå“å</label>
            <input id="edit-project" type="text" class="mt-1 w-full p-2 border rounded-md" value="${rec.projectName || ''}">
          </div>
          <div>
            <label class="text-sm text-gray-700">å½¹å</label>
            <input id="edit-role" type="text" class="mt-1 w-full p-2 border rounded-md" value="${rec.roleName || ''}">
          </div>
          <div>
            <label class="text-sm text-gray-700">åŒºåˆ†</label>
            <select id="edit-mainsub" class="mt-1 w-full p-2 border rounded-md">
              <option value="ãã®ä»–" ${rec.mainSub === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option>
              <option value="ãƒ¡ã‚¤ãƒ³" ${rec.mainSub === 'ãƒ¡ã‚¤ãƒ³' ? 'selected' : ''}>ãƒ¡ã‚¤ãƒ³</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-gray-700">ã‚­ãƒ£ã‚¹å„ªå…ˆåº¦</label>
            <input id="edit-priority" type="number" min="1" class="mt-1 w-full p-2 border rounded-md" value="${rec.castPriority || ''}">
          </div>
          <div>
            <label class="text-sm text-gray-700">æ‹…å½“è€…</label>
            <input id="edit-bookedby" type="text" class="mt-1 w-full p-2 border rounded-md" value="${rec.updatedBy || currentUser?.email || ''}">
          </div>
          <div>
            <label class="text-sm text-gray-700">é‡‘é¡</label>
            <input id="edit-cost" type="text" class="mt-1 w-full p-2 border rounded-md" value="${rec.cost || ''}" placeholder="é‡‘é¡ã‚’å…¥åŠ›">
          </div>
          <div>
            <label class="text-sm text-gray-700">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="edit-status" class="mt-1 w-full p-2 border rounded-md">
              ${[
            'ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡',
            'æ‰“è¨ºä¸­',
            'æ±ºå®š',
            'NG',
            'æ¡ä»¶ã¤ãOK',
            'ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°',
          ].map(s => `<option value="${s}" ${rec.status === s ? 'selected' : ''}>${s}</option>`).join('')}
            </select>
             <p class="text-xs text-gray-500 mt-1">
              â€»ã€Œæ¡ä»¶ã¤ãOKã€ã‚’é¸ã‚“ã å ´åˆã€ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚‚å…¥åŠ›ã§ãã¾ã™ã€‚
            </p>
          </div>
          <div id="edit-status-comment-wrap" class="mt-2 ${rec.status === 'æ¡ä»¶ã¤ãOK' ? '' : 'hidden'}">
            <label class="text-sm text-gray-700">æ¡ä»¶ã¤ãOKã‚³ãƒ¡ãƒ³ãƒˆ</label>
            <textarea id="edit-status-comment" class="mt-1 w-full p-2 border rounded-md" rows="3"
              placeholder="æ¡ä»¶ã‚„æ³¨æ„äº‹é …ãªã©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
          </div>
        </div>
        <div class="mt-4 flex justify-end gap-3">
          <button id="edit-cancel" class="px-4 py-2 rounded-md border border-gray-300">é–‰ã˜ã‚‹</button>
          <button id="edit-save" class="px-4 py-2 rounded-md bg-blue-600 text-white font-semibold">ä¿å­˜</button>
        </div>
      </div>`;
        modal.classList.remove('hidden');

        const statusSelect = modal.querySelector('#edit-status');
        const commentWrap = modal.querySelector('#edit-status-comment-wrap');
        if (statusSelect && commentWrap) {
          statusSelect.addEventListener('change', () => {
            if (statusSelect.value === 'æ¡ä»¶ã¤ãOK') {
              commentWrap.classList.remove('hidden');
            } else {
              commentWrap.classList.add('hidden');
            }
          });
        }

        modal.querySelector('#edit-close')?.addEventListener('click', closeEditModal);
        modal.querySelector('#edit-cancel')?.addEventListener('click', closeEditModal);
        modal.querySelector('#edit-save')?.addEventListener('click', async () => {
          await saveEdit(castingId);
        });
      }
      function closeEditModal() { const modal = document.getElementById('edit-modal'); if (!modal) return; modal.classList.add('hidden'); modal.innerHTML = ''; }

      function startAdditionalOrder(context) {
        const { date, accountName, projectId, slackThreadTs, slackPermalink } = context;
        if (!slackThreadTs) {
          showMessage('è¿½åŠ ã‚ªãƒ¼ãƒ€ãƒ¼ã®å…ƒã¨ãªã‚‹æœ‰åŠ¹ãªã‚ªãƒ¼ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
          return;
        }

        // ä»£è¡¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåãªã©ã‚’å–å¾—
        const rec = castingData.find(c => c.accountName === accountName && c.projectId === projectId && c.slackThreadTs === slackThreadTs);
        if (!rec) {
          showMessage('è¿½åŠ ã‚ªãƒ¼ãƒ€ãƒ¼ã®å…ƒã¨ãªã‚‹ä»£è¡¨ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
          return;
        }

        // â˜…è¿½åŠ : å‰å›ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã‚¯ãƒªã‚¢
        if (cartMeta && cartMeta.pdfFiles) delete cartMeta.pdfFiles;

        isAdditionalOrderMode = true;
        additionalOrderContext = {
          accountName: accountName,
          projectName: rec.projectName, // ä»£è¡¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ä½¿ã†
          projectId: projectId,
          slackThreadTs: slackThreadTs,
          slackPermalink: slackPermalink,
          startDate: date, // ã“ã®æ—¥ã®ã‚ªãƒ¼ãƒ€ãƒ¼
          endDate: date,
        };

        // cart = {}; // Do NOT clear cart (User might have selected casts)
        const projectNames = rec.projectName.split('/');
        const notionPageId = projectId.replace(/-/g, '');
        cartMeta = {
          account: accountName,
          notionUrl: notionPageId ? `https://www.notion.so/${notionPageId}` : '',
          projectNames: [projectNames[0] || '', projectNames[1] || '', projectNames[2] || ''],
          combinedProjectNames: rec.projectName.includes('/') ? [rec.projectName] : []
        };

        // Populate cartProjects with inherited project name
        // If cartProjects is empty (or default), replace it?
        // Or just add?
        // "ãã®ä½œå“å...ã‚’å¼•ãç¶™ã„ã§" -> likely we want to start with that project.
        cartProjects = [{
          id: 'proj_' + Date.now(),
          title: rec.projectName, // Inherit Project Name
          roles: []
        }];
        // Add default roles
        for (let i = 0; i < 3; i++) {
          cartProjects[0].roles.push({
            id: 'role_' + Date.now() + '_' + i,
            name: '',
            type: 'ãã®ä»–',
            note: '',
            castIds: []
          });
        }

        updateCartCount();

        selectedDates = [date];

        switchView('casting-view');

        renderCalendar();
        updateSelectedPeriodDisplay();
        displayAvailableCasts();

        showMessage(`è¿½åŠ ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼š${accountName} / ${date}`, 'info');
      }

      function handleCastingRowClick(castingId) {
        const rec = castingData.find(c => c.castingId === castingId);
        if (!rec) return;

        // å†…éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã¯å¸¸ã«ã€Œç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã€ã‚’é–‹ãï¼ˆä»Šã¾ã§é€šã‚Šï¼‰
        if (rec.isInternal) {
          openStatusQuickModal(castingId);
          return;
        }

        // å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆ ï¼‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡ã€ã®ã¨ãã ã‘
        // 1å›ç›®ã®ã‚¯ãƒªãƒƒã‚¯ã§ã€Œæ‰“è¨ºãƒ¡ãƒ¼ãƒ«ä½œæˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã€ã‚’é–‹ã
        if (rec.status === "ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡") {
          openShootMailModal(castingId); // Use the new unified mail modal
          return;
        }

        // å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆ ï¼‹ ã€Œæ‰“è¨ºä¸­ / æ±ºå®š / NG / æ¡ä»¶ã¤ãOK ãªã©ã€
        // â†’ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ç”¨ã®ã‚¯ã‚¤ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        openStatusQuickModal(castingId);
      }
      function openExternalOrderMailModal(rec) {
        const modal = document.getElementById('edit-modal');
        modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
      <h3 class="text-xl font-bold mb-4">å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆï¼šæ‰“è¨ºãƒ¡ãƒ¼ãƒ«ä½œæˆ</h3>

      <textarea id="external-mail-body" class="w-full h-48 p-2 border rounded-md text-sm leading-relaxed">
${buildExternalMailBody(rec)}
      </textarea>

      <div class="mt-6 flex justify-end gap-3">
        <button id="external-mail-cancel" class="px-4 py-2 rounded-md border border-gray-300">é–‰ã˜ã‚‹</button>
        <button id="external-mail-send" class="px-4 py-2 rounded-md bg-blue-600 text-white font-semibold">æ‰“è¨ºãƒ¡ãƒ¼ãƒ«é€ä¿¡æ¸ˆã¿ã«ã™ã‚‹</button>
      </div>
    </div>
  `;
        modal.classList.remove("hidden");

        document.getElementById("external-mail-cancel")?.addEventListener("click", closeEditModal);
        document.getElementById("external-mail-send")?.addEventListener("click", async () => {
          await changeCastingStatus(rec.castingId, "æ‰“è¨ºä¸­");
          closeEditModal();
        });
      }

      function buildExternalMailBody(rec) {
        return `
â—¯â—¯äº‹å‹™æ‰€ å¾¡ä¸­

ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
æ ªå¼ä¼šç¤¾GOKKO ã® ${rec.updatedBy || "æ‹…å½“è€…"} ã§ã™ã€‚

ä»¥ä¸‹ã®å†…å®¹ã§ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã®ã”ç›¸è«‡ãŒã”ã–ã„ã¾ã™ã€‚

â– ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
${rec.accountName}

â– ä½œå“å
${rec.projectName}

â– å½¹åï¼å€™è£œã‚­ãƒ£ã‚¹ãƒˆ
${rec.roleName}ï¼š${rec.castName}

â– æ’®å½±æ—¥
${rec.startDate}${rec.startDate !== rec.endDate ? ` ï½ ${rec.endDate}` : ""}

â– å‚™è€ƒ
${rec.note || "ãªã—"}

ã”ç¢ºèªã®ã»ã©ã€ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
  `.trim();
      }

      async function updateCalendarEventOnStatusChange(rec, newStatus, rowNumber) {
        try {
          if (!INTERNAL_HOLD_CALENDAR_ID) return;
          if (!rec.calendarEventId) return;

          // ---- NG ã®å ´åˆã¯äºˆå®šã‚’å‰Šé™¤ã™ã‚‹ -------------------------
          if (newStatus === 'NG') {
            try {
              await gapi.client.calendar.events.delete({
                calendarId: INTERNAL_HOLD_CALENDAR_ID,
                eventId: rec.calendarEventId,
              });
            } catch (e) {
              // 404ï¼ˆã™ã§ã«å‰Šé™¤æ¸ˆã¿ï¼‰ã®å ´åˆã¯ç„¡è¦–ã€ãã‚Œä»¥å¤–ã¯ãƒ­ã‚°ã ã‘æ®‹ã™
              if (!(e && e.status === 404)) {
                console.error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šå‰Šé™¤ã«å¤±æ•—:', e);
              }
            }

            // ã‚·ãƒ¼ãƒˆã® Nåˆ—(calendarEventId)ã‚’ç©ºã«ã™ã‚‹
            if (rowNumber) {
              try {
                await gapi.client.sheets.spreadsheets.values.batchUpdate({
                  spreadsheetId: SPREADSHEET_ID,
                  resource: {
                    valueInputOption: 'USER_ENTERED',
                    data: [
                      {
                        range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!N${rowNumber}`,
                        values: [['']],
                      },
                    ],
                  },
                });
              } catch (e) {
                console.error('calendarEventId ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—:', e);
              }
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢
            rec.calendarEventId = '';
            return; // ã“ã“ã§çµ‚äº†ï¼ˆæ±ºå®šã‚¿ã‚¤ãƒˆãƒ«ãªã©ã®æ›´æ–°ã¯è¡Œã‚ãªã„ï¼‰
          }

          // ---- ãã‚Œä»¥å¤–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯æ—¢å­˜é€šã‚Šã€Œæ›´æ–°ã€ãƒ­ã‚¸ãƒƒã‚¯ ----

          // ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—
          const getRes = await gapi.client.calendar.events.get({
            calendarId: INTERNAL_HOLD_CALENDAR_ID,
            eventId: rec.calendarEventId,
          });
          const event = getRes.result;

          // ã‚µãƒãƒªãƒ¼ï¼šæ±ºå®šã®ã¨ãã ã‘ç‰¹åˆ¥ãªæ–‡è¨€
          const summary =
            newStatus === 'æ±ºå®š'
              ? `${rec.accountName || 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœªè¨­å®š'}_æ±ºå®šã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°`
              : (event.summary ||
                `${rec.accountName || 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœªè¨­å®š'}_${rec.rank || ''}å€™è£œ_${newStatus}`);

          // èª¬æ˜æ–‡ã®ã€Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€è¡Œã‚’å·®ã—æ›¿ãˆ
          let description = event.description || '';
          const statusLineRe = /ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: .*/;
          if (statusLineRe.test(description)) {
            description = description.replace(statusLineRe, `ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${newStatus}`);
          } else {
            description += (description ? '\n' : '') + `ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${newStatus}`;
          }

          await gapi.client.calendar.events.patch({
            calendarId: INTERNAL_HOLD_CALENDAR_ID,
            eventId: rec.calendarEventId,
            resource: {
              summary,
              description,
            },
          });
        } catch (e) {
          console.error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šæ›´æ–°ã«å¤±æ•—:', e);
          // UIå´ã®æŒ™å‹•ã¯ç¶™ç¶šã•ã›ãŸã„ã®ã§ã€ã“ã“ã§ã¯ä¾‹å¤–ã‚’æŠ•ã’ãšãƒ­ã‚°ã®ã¿ã«ã™ã‚‹
        }
      }

      async function saveEdit(castingId) {
        if (!isAdmin) { showMessage('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error'); return; }
        const rec = castingData.find(c => c.castingId === castingId); if (!rec) { showMessage('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error'); return; }
        const prevStatus = rec.status; // å¤‰æ›´å‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿æŒ

        const modal = document.getElementById('edit-modal');
        const newProject = modal.querySelector('#edit-project')?.value?.trim() || '';
        const newRole = modal.querySelector('#edit-role')?.value?.trim() || '';
        const newMainSub = modal.querySelector('#edit-mainsub')?.value || 'ãã®ä»–';
        const newPriorityRaw = modal.querySelector('#edit-priority')?.value;
        const newPriority = Number.isFinite(parseInt(newPriorityRaw, 10)) ? parseInt(newPriorityRaw, 10) : '';
        const newCost = modal.querySelector('#edit-cost')?.value?.trim() || ''; // Cost
        const newBooked = modal.querySelector('#edit-bookedby')?.value?.trim() || ''; // This is now 'updater'
        const newStatus = modal.querySelector('#edit-status')?.value || rec.status;
        const commentEl = modal.querySelector('#edit-status-comment');
        const commentText = commentEl ? (commentEl.value || '') : '';

        showLoader(true);
        try {
          // è¡Œç•ªå·æ¢ç´¢
          const getRes = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID, range: 'ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!A2:R'
          });
          const rows = getRes.result.values || [];
          let rowIdx = -1; for (let i = 0; i < rows.length; i++) { if (rows[i]?.[0] === castingId) { rowIdx = i; break; } }
          if (rowIdx === -1) { showMessage('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error'); return; }
          const targetRow = rowIdx + 2;

          const updates = [
            { range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!C${targetRow}`, values: [[newProject]] },
            { range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!D${targetRow}`, values: [[newRole]] },
            { range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!J${targetRow}`, values: [[newStatus]] },
            { range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!N${targetRow}`, values: [[newMainSub]] }, // Nåˆ—: mainSub
            { range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!Q${targetRow}`, values: [[newBooked]] }, // Updater
            { range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!R${targetRow}`, values: [[newPriority]] }, // Cast Priority
            { range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!V${targetRow}`, values: [[newCost]] }, // Våˆ—: Cost
          ];

          await gapi.client.sheets.spreadsheets.values.batchUpdate({
            spreadsheetId: SPREADSHEET_ID,
            resource: { valueInputOption: 'USER_ENTERED', data: updates }
          });

          // ãƒ­ãƒ¼ã‚«ãƒ«åæ˜ 
          rec.projectName = newProject; rec.roleName = newRole; rec.updatedBy = newBooked; rec.status = newStatus; rec.castPriority = newPriority; rec.mainSub = newMainSub; rec.cost = newCost;

          // Slack é€šçŸ¥ã¯å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã‹ã¤ã€Œæ‰“è¨ºä¸­ â†’ æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã¸ã®é·ç§»ã ã‘
          const isExternal = !rec.isInternal;
          const isFromDashing = (prevStatus === "æ‰“è¨ºä¸­");
          const isFinal = ["æ±ºå®š", "NG", "æ¡ä»¶ã¤ãOK"].includes(newStatus);

          if (isExternal && isFromDashing && isFinal) {
            const statusForSlack = newStatus === 'æ±ºå®š' ? 'OK' : newStatus;
            await postStatusUpdateToSlack(rec, statusForSlack, commentText);
          }

          await updateCalendarEventOnStatusChange(rec, newStatus, targetRow);

          closeEditModal();
          showMessage('æ›´æ–°ã—ã¾ã—ãŸã€‚');
          await renderCastingStatusView(false); // Do not force reload, just re-render
          displayAvailableCasts();
        } catch (e) {
          console.error(e); showMessage('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        } finally { showLoader(false); }
      }


      function openStatusQuickModal(castingId) {
        if (!isAdmin) { showMessage('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error'); return; }
        const rec = castingData.find(c => c.castingId === castingId);
        if (!rec) { showMessage('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error'); return; }

        const modal = document.getElementById('status-quick-modal');
        if (!modal) return;

        const cast = castData.find(c => c.castId === rec.castId);
        const castName = cast?.name || rec.castName || rec.castId || '';
        const currentStatus = rec.status || '';

        // â˜…ä¿®æ­£: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹å½¢å¼ã®HTMLã«å·®ã—æ›¿ãˆ
        modal.innerHTML = `
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-bold">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°</h3>
          <button id="status-quick-close" class="text-gray-600 hover:text-gray-800">&times;</button>
        </div>
        
        <div class="text-sm text-gray-700 mb-4 border-b pb-3">
          <div>ä½œå“ï¼š${rec.projectName || '-'}</div>
          <div>å½¹åï¼š${rec.roleName || '-'}</div>
          <div>æ°åï¼š${castName}</div>
          <div class="mt-1 text-xs text-gray-500">ç¾åœ¨ï¼š${currentStatus}</div>
        </div>

        <div class="space-y-3 text-sm">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">
              ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            </label>
            <select
              id="status-edit-status"
              class="w-full border rounded px-2 py-1 text-sm"
            >
              <option value="æ±ºå®š" ${currentStatus === 'æ±ºå®š' || currentStatus === 'OK' ? 'selected' : ''}>OKï¼ˆæ±ºå®šï¼‰</option>
              <option value="NG" ${currentStatus === 'NG' ? 'selected' : ''}>NG</option>
              <option value="æ¡ä»¶ã¤ãOK" ${currentStatus === 'æ¡ä»¶ã¤ãOK' ? 'selected' : ''}>æ¡ä»¶ã¤ãOK</option>
              <option value="ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡" ${currentStatus === 'ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡' ? 'selected' : ''}>ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡</option>
              <option value="æ‰“è¨ºä¸­" ${currentStatus === 'æ‰“è¨ºä¸­' ? 'selected' : ''}>æ‰“è¨ºä¸­</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">
              é‡‘é¡
            </label>
            <input
              type="text"
              id="status-edit-cost"
              class="w-full border rounded px-2 py-1 text-sm text-right"
              placeholder="Â¥"
              value="${rec.cost || ''}"
            >
          </div>

          <div
            id="status-edit-extra-message-wrapper"
            class="space-y-1 ${currentStatus === "æ¡ä»¶ã¤ãOK" ? "" : "hidden"}"
          >
            <label class="block text-xs font-medium text-gray-600">
              æ¡ä»¶ãƒ¡ãƒ¢ï¼ˆSlackã«ä¸€ç·’ã«é€ä¿¡ã•ã‚Œã¾ã™ï¼‰
            </label>
            <textarea
              id="status-edit-extra-message"
              rows="3"
              class="w-full border rounded px-2 py-1 text-xs"
              placeholder="ä¾‹ï¼‰ãƒ»æ¡ä»¶ï¼šâ—¯â—¯ã¯NGã€â–³â–³ã®å ´åˆã®ã¿å‡ºæ¼”å¯èƒ½ ãªã©"
            ></textarea>
          </div>
        </div>

        <div class="mt-6 flex justify-end gap-3">
          <button id="status-quick-cancel" class="px-4 py-2 rounded-md border border-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="status-quick-save" class="px-4 py-2 rounded-md bg-blue-600 text-white font-semibold">æ›´æ–°</button>
        </div>
      </div>`;

        modal.classList.remove('hidden');

        // â˜…ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        const statusSelect = modal.querySelector("#status-edit-status");
        const costInput = modal.querySelector("#status-edit-cost");
        const extraMessageWrapper = modal.querySelector("#status-edit-extra-message-wrapper");
        const extraMessageInput = modal.querySelector("#status-edit-extra-message");

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        statusSelect.addEventListener("change", () => {
          if (statusSelect.value === "æ¡ä»¶ã¤ãOK") {
            extraMessageWrapper.classList.remove("hidden");
          } else {
            extraMessageWrapper.classList.add("hidden");
          }
        });

        // é–‰ã˜ã‚‹ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
        modal.querySelector('#status-quick-close')?.addEventListener('click', closeStatusQuickModal);
        modal.querySelector('#status-quick-cancel')?.addEventListener('click', closeStatusQuickModal);

        // æ›´æ–°ãƒœã‚¿ãƒ³ï¼ˆã‚·ãƒ³ãƒ—ãƒ«åŒ–ã—ãŸå–å¾—ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        modal.querySelector('#status-quick-save')?.addEventListener('click', async () => {
          const newStatus = statusSelect.value;
          const newCost = costInput.value.trim();
          const extraMessage = extraMessageInput.value || "";

          // APIå‘¼ã³å‡ºã—
          // changeCastingStatus needs to support cost update.
          // Currently it calls /api/notify/status_update AND updates sheet.
          // But changeCastingStatus implementation (lines 1200+) might not handle Cost update to sheet.
          // Let's check changeCastingStatus.
          // If it doesn't, we might need to call saveEdit logic or update changeCastingStatus.
          // For now, let's pass cost to changeCastingStatus and ensure it handles it.
          await changeCastingStatus(rec.castingId, newStatus, {
            quick: true,
            extraMessage: extraMessage,
            cost: newCost
          });

          closeStatusQuickModal();
        });
      }

      function closeStatusQuickModal() {
        const modal = document.getElementById('status-quick-modal');
        if (!modal) return;
        modal.classList.add('hidden');
        modal.innerHTML = '';
      }

      // ========= Calendar (today red) =========
      function renderCalendar() {
        const monthYearEl = document.getElementById('current-month-year');
        const grid = document.getElementById('calendar-grid');
        if (!monthYearEl || !grid) return;

        // header
        monthYearEl.textContent = `${calendarDate.getFullYear()}å¹´${calendarDate.getMonth() + 1}æœˆ`;

        // clear & rebuild
        grid.innerHTML = '';
        const frag = document.createDocumentFragment();

        // weekday header
        ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(d => {
          const h = document.createElement('div');
          h.textContent = d; h.className = 'font-bold text-gray-600';
          frag.appendChild(h);
        });

        const y = calendarDate.getFullYear(), m = calendarDate.getMonth();
        const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);

        // leading blanks
        for (let i = 0; i < first.getDay(); i++) {
          const blank = document.createElement('div'); blank.className = 'p-2';
          frag.appendChild(blank);
        }

        // days
        for (let day = 1; day <= last.getDate(); day++) {
          const d = new Date(y, m, day);
          const ymd = d2str(d);
          const cell = document.createElement('div');
          const isToday = (ymd === TODAY_STR);
          const isSelected = selectedDates.includes(ymd);
          const isPast = toEpochDay(ymd) < TODAY_EPOCH;

          cell.dataset.date = ymd;
          cell.textContent = String(day);

          if (isPast) {
            cell.className = 'p-2 rounded-md text-gray-400 cursor-not-allowed';
          } else {
            cell.className = 'p-2 rounded-md cursor-pointer hover:bg-blue-200 calendar-day';
            if (isSelected) { cell.classList.add('bg-blue-500', 'text-white'); }
            else if (isToday) { cell.classList.add('text-red-600', 'font-semibold'); }
          }
          frag.appendChild(cell);
        }
        grid.appendChild(frag);
      }

      // ========= Additional Casting List =========
      function renderShootingList() {
        const container = document.getElementById('shooting-list-container');
        if (!container) return;

        if (selectedDates.length !== 1) {
          container.innerHTML = '';
          container.classList.add('hidden');
          return;
        }

        const date = selectedDates[0];
        // Find existing shootings for this date
        // Group by Account + Project Name
        const shootings = castingData.filter(c => c.startDate === date && c.slackThreadTs);

        if (shootings.length === 0) {
          container.innerHTML = '';
          container.classList.add('hidden');
          return;
        }

        const uniqueShootings = new Map();
        shootings.forEach(s => {
          const key = `${s.accountName}__${s.projectName}`;
          if (!uniqueShootings.has(key)) {
            uniqueShootings.set(key, s);
          }
        });

        container.classList.remove('hidden');
        container.innerHTML = `
          <div class="text-sm font-bold text-gray-700 mb-2">ã“ã®æ—¥ã®æ—¢å­˜æ’®å½±ï¼ˆè¿½åŠ ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼‰:</div>
          <div class="flex flex-wrap gap-2">
            ${Array.from(uniqueShootings.values()).map(s => `
              <button onclick="startAdditionalOrder({
                date: '${s.startDate}',
                accountName: '${s.accountName}',
                projectId: '${s.projectId}',
                slackThreadTs: '${s.slackThreadTs}',
                slackPermalink: '${s.slackPermalink}'
              })" class="px-3 py-2 bg-blue-100 text-blue-800 rounded hover:bg-blue-200 text-sm font-semibold flex items-center gap-2">
                <span>${s.accountName} / ${s.projectName}</span>
                <span class="text-xs bg-white px-1 rounded border">è¿½åŠ </span>
              </button>
            `).join('')}
          </div>
        `;
      }

      // ========= Filters =========
      function renderFilters() {
        const container = document.getElementById('cast-filters-container'); if (!container) return;

        // Horizontal Layout: Gender | Agency | Keyword | AvailableOnly | Sort
        container.innerHTML = `
    <!-- Gender -->
    <div class="flex flex-col">
      <span class="text-xs font-bold text-gray-500 mb-1">æ€§åˆ¥</span>
      <div class="flex items-center space-x-3 bg-white border rounded px-3 py-2 h-10">
        <label class="inline-flex items-center space-x-1 cursor-pointer">
          <input id="filter-gender-male" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
          <span class="text-sm">ç”·æ€§</span>
        </label>
        <label class="inline-flex items-center space-x-1 cursor-pointer">
          <input id="filter-gender-female" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
          <span class="text-sm">å¥³æ€§</span>
        </label>
      </div>
    </div>

    <!-- Agency -->
    <div class="flex flex-col relative w-48">
      <label class="text-xs font-bold text-gray-500 mb-1">äº‹å‹™æ‰€</label>
      <button id="agency-filter-btn" class="w-full px-3 py-2 border rounded bg-white text-left text-sm flex justify-between items-center h-10">
        <span class="truncate">é¸æŠ...</span>
        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
      </button>
      <div id="agency-filter-dropdown" class="hidden absolute top-full left-0 w-full mt-1 bg-white border rounded shadow-lg z-20 max-h-60 overflow-y-auto"></div>
    </div>

    <!-- Keyword -->
    <div class="flex flex-col flex-grow min-w-[200px]">
      <label for="filter-keyword" class="text-xs font-bold text-gray-500 mb-1">ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
      <input id="filter-keyword" type="text" placeholder="åå‰ãƒ»äº‹å‹™æ‰€ãƒ»ãƒ¡ãƒ¢" class="w-full px-3 py-2 border rounded text-sm h-10">
    </div>

    <!-- Extra Options (Available Only / Appearance) -->
    <div class="flex flex-col justify-end pb-1 gap-2">
       <div class="flex items-center">
          <input id="filter-available-only" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
          <label for="filter-available-only" class="ml-2 text-sm text-gray-700 cursor-pointer">æœªä»®ã‚­ãƒ£ã‚¹ã®ã¿</label>
       </div>
    </div>
    
    <!-- Sort (Compact) -->
    <div class="flex flex-col justify-end pb-1 gap-2 ml-auto">
       <div class="flex items-center space-x-3 text-sm">
          <label class="inline-flex items-center space-x-1 cursor-pointer">
            <input id="sort-appearance" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
            <span>å‡ºæ¼”å›æ•°é †</span>
          </label>
          <label class="inline-flex items-center space-x-1 cursor-pointer">
            <input id="sort-kana" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
            <span>50éŸ³é †</span>
          </label>
       </div>
    </div>
  `;

        renderAgencyFilter();

        // dropdown
        const btn = document.getElementById('agency-filter-btn');
        const dd = document.getElementById('agency-filter-dropdown');
        btn?.addEventListener('click', e => { e.stopPropagation(); dd?.classList.toggle('hidden'); });
        document.addEventListener('click', e => { if (!dd || dd.classList.contains('hidden')) return; if (!dd.contains(e.target) && e.target !== btn) dd.classList.add('hidden'); });

        // sort exclusive
        const sA = document.getElementById('sort-appearance');
        const sK = document.getElementById('sort-kana');
        sA?.addEventListener('change', () => { if (sA.checked) sK.checked = false; displayAvailableCasts(); });
        sK?.addEventListener('change', () => { if (sK.checked) sA.checked = false; displayAvailableCasts(); });

        // Add listeners for new inputs
        document.getElementById('filter-keyword')?.addEventListener('input', displayAvailableCasts);
        document.getElementById('filter-gender-male')?.addEventListener('change', displayAvailableCasts);
        document.getElementById('filter-gender-female')?.addEventListener('change', displayAvailableCasts);

        document.getElementById('filter-available-only')?.addEventListener('change', displayAvailableCasts);
      }
      function renderAgencyFilter() {
        const dd = document.getElementById('agency-filter-dropdown'); if (!dd) return;
        const agencies = [...new Set(castData.map(c => c.agency?.trim() || 'ãƒ•ãƒªãƒ¼'))].sort((a, b) => a.localeCompare(b, 'ja'));

        dd.innerHTML = agencies.map(a => `
          <label class="flex items-center px-3 py-2 hover:bg-gray-100 cursor-pointer">
            <input type="checkbox" value="${a}" class="h-4 w-4 text-blue-600 border-gray-300 rounded mr-2" onchange="updateAgencyButton(); displayAvailableCasts();">
            <span class="text-sm text-gray-700">${a}</span>
          </label>
        `).join('');
      }

      function updateAgencyButton() {
        const btn = document.getElementById('agency-filter-btn');
        if (!btn) return;
        const checked = document.querySelectorAll('#agency-filter-dropdown input[type="checkbox"]:checked');
        if (checked.length === 0) {
          btn.firstElementChild.textContent = 'é¸æŠ...';
        } else if (checked.length === 1) {
          btn.firstElementChild.textContent = checked[0].value;
        } else {
          btn.firstElementChild.textContent = `é¸æŠä¸­ (${checked.length})`;
        }
      }

      // ========= Shooting List (Area 2) =========
      let selectedShooting = null; // { pageId, title, date }

      function renderShootingList() {
        const container = document.getElementById('shooting-list-container');
        if (!container) return;

        container.innerHTML = '';

        if (selectedDates.length === 0) {
          container.innerHTML = `<p class="text-gray-500 text-sm">æ—¥ä»˜ã‚’é¸æŠã™ã‚‹ã¨ã€å€™è£œã®æ’®å½±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>`;
          selectedShooting = null;
          updateCartFromShooting();
          return;
        }

        // Filter shootingListData by selectedDates
        // shootingListData has { pageId, title, date, team, cd, fd }
        // We want to show titles that match ANY of the selected dates?
        // User said: "1ã§é¸ã°ã‚ŒãŸæ’®å½±æ—¥ã«å¯¾ã—ã¦ã€è©²å½“ã™ã‚‹æ’®å½±ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’2ã®å ´æ‰€ã«è¡¨ç¤º"
        // "è¤‡æ•°æ—¥é¸æŠã•ã‚ŒãŸå ´åˆã¯ã€å…¨ã¦ã«å¼•ã£ã‹ã‹ã£ã¦ã„ã‚‹ã‚‚ã®ã§ã¯ãªãã€å¼•ã£ã‹ã‹ã£ãŸæ’®å½±æ—¥å…¨ã¦ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å‡ºåŠ›ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸"
        // So union of shootings on selected dates.

        const matchedShootings = (window.shootingListData || []).filter(item => selectedDates.includes(item.date));

        if (matchedShootings.length === 0) {
          container.innerHTML = `<p class="text-gray-500 text-sm">é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®æ’®å½±äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
          selectedShooting = null;
          updateCartFromShooting();
          return;
        }

        // Deduplicate by PageID or Title?
        // User said "PageID ã‚¿ã‚¤ãƒˆãƒ«...". Let's assume PageID is unique.
        // If same title appears on multiple dates, do we show it once or multiple times?
        // "å¼•ã£ã‹ã‹ã£ãŸæ’®å½±æ—¥å…¨ã¦ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å‡ºåŠ›ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸" -> List all occurrences or unique titles?
        // Usually you select a specific "Shooting Day" which is bound to a date.
        // If I select Dec 1 and Dec 2, and Project A shoots on both, maybe I want to select "Project A (Dec 1)"?
        // But the cart input is "Project Name" and "Notion URL".
        // If I select a shooting, I probably want to set the Project Name and Notion URL for the order.
        // Let's list all items found.

        matchedShootings.forEach(item => {
          const btn = document.createElement('div');
          // Style: Card-like button
          const isSelected = selectedShooting && selectedShooting.pageId === item.pageId && selectedShooting.date === item.date;

          btn.className = `p-3 border rounded-md cursor-pointer transition flex flex-col gap-1 ${isSelected ? 'bg-blue-100 border-blue-500 ring-1 ring-blue-500' : 'bg-white hover:bg-gray-50 border-gray-200'}`;

          btn.innerHTML = `
            <div class="font-bold text-sm text-gray-800">${item.title}</div>
            <div class="text-xs text-gray-500 flex justify-between">
              <span>${item.date}</span>
              <span>${item.team || ''}</span>
            </div>
          `;

          btn.addEventListener('click', () => {
            if (isSelected) {
              // Deselect
              selectedShooting = null;
            } else {
              selectedShooting = item;
            }
            renderShootingList(); // Re-render to update selection state
            updateCartFromShooting();
          });

          container.appendChild(btn);
        });
      }

      function updateCartFromShooting() {
        // Update global cartMeta or similar if needed?
        // The user said: "å–å¾—ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ã€ã‚«ãƒ¼ãƒˆå†…ã®STEP1ã§å…¥åŠ›ã—ã¦ã„ãŸã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã€NotionIDã«ãªã‚Šã¾ã™ã€‚"
        // "ä¸€æ—¦ã“ã“ã¾ã§ã§ããŸã‚‰ã€ã‚«ãƒ¼ãƒˆã®å¤‰æ›´ã‚’ä¼ãˆã¾ã™ã€‚"
        // So for now, I just need to store it in `selectedShooting`.
        // I will log it for debug.
      }

      // ========= Cart =========
      async function submitNewOrder() {
        // 1. Auth Check (Auto-Login)
        const isAuth = await ensureAuth();
        if (!isAuth) {
          alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã®ãŸã‚é€ä¿¡ã§ãã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
          handleAuthClick();
          return;
        }

        if (Object.keys(cart).length === 0) {
          showMessage('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™ã€‚', 'info');
          return;
        }

        // Show Custom Confirmation Modal instead of native confirm
        const modal = document.getElementById('special-confirmation-modal');
        if (modal) {
          modal.classList.remove('hidden');

          // Reset checkboxes
          document.getElementById('confirm-intimacy').checked = false;
          document.getElementById('confirm-child').checked = false;

          // Setup one-time event listener for OK button
          const okBtn = document.getElementById('special-confirm-ok');
          // Clone button to remove old listeners
          const newOkBtn = okBtn.cloneNode(true);
          okBtn.parentNode.replaceChild(newOkBtn, okBtn);

          newOkBtn.addEventListener('click', async () => {
            modal.classList.add('hidden');

            // Handle Intimacy Check
            const isIntimacy = document.getElementById('confirm-intimacy').checked;
            if (isIntimacy) {
              // Append to note for all items in cart
              for (const key in cart) {
                if (cart[key].note) {
                  cart[key].note += "\nã€ã‚¤ãƒ³ãƒ†ã‚£ãƒã‚·ãƒ¼ã‚·ãƒ¼ãƒ³ã‚ã‚Šã€‘";
                } else {
                  cart[key].note = "ã€ã‚¤ãƒ³ãƒ†ã‚£ãƒã‚·ãƒ¼ã‚·ãƒ¼ãƒ³ã‚ã‚Šã€‘";
                }
              }
            }

            // Call submission
            await confirmProvisionalBookings();
          });
        } else {
          // Fallback if modal missing
          if (!confirm('ã“ã®å†…å®¹ã§ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) return;
          await confirmProvisionalBookings();
        }
      }



      // Make handleAddToCart global
      window.handleAddToCart = function (castId) {
        addToCart(castId);
        const modal = document.getElementById('cast-detail-modal');
        if (modal) modal.remove();
      };

      function addToCart(castId) {
        if (!castId) return;
        if (selectedDates.length === 0) {
          showMessage('ã¾ãšæ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'info');
          return;
        }
        const cast = castData.find(c => c.castId === castId);
        if (!cast) return;

        const existing = cart[castId] || {};
        const baseTitles = (cartMeta.projectNames || []).map(t => t.trim()).filter(t => t);

        cart[castId] = {
          cast,
          dates: [...selectedDates],
          roleName: existing.roleName || '',
          rank: existing.rank || 1,
          dates: [...selectedDates],
          roleName: existing.roleName || '',
          rank: existing.rank || 1,
          mainSub: existing.mainSub || 'ãã®ä»–', // Default to 'ãã®ä»–'
          note: existing.note || '',
          projectName: existing.projectName || baseTitles[0] || '',
          note: existing.note || '',
          projectName: existing.projectName || baseTitles[0] || '',
        };

        updateCartCount();
        showMessage(`${cast.name} ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼ˆ${selectedDates.length}æ—¥ï¼‰ã€‚`);
        displayAvailableCasts();
      }

      function getNextCastPriority(castId, rangeStart, rangeEnd, tempAssignments) {
        let maxPriority = 0;
        const STATUS_BLOCK = ['æ±ºå®š', 'ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°', 'ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡', 'æ‰“è¨ºä¸­', 'ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡ï¼ˆä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼‰', 'æ¡ä»¶ã¤ãOK'];
        for (const c of castingData) {
          if (c.castId !== castId || !STATUS_BLOCK.includes(c.status) || !overlaps(rangeStart, rangeEnd, c.startDate, c.endDate)) continue;
          const p = parseInt(c.castPriority, 10);
          if (Number.isFinite(p) && p > maxPriority) maxPriority = p;
        }
        for (const key in tempAssignments) {
          if (key.startsWith(castId + '_')) {
            const [_, tempStart, tempEnd] = key.split('_');
            if (overlaps(rangeStart, rangeEnd, tempStart, tempEnd)) {
              if (tempAssignments[key] > maxPriority) maxPriority = tempAssignments[key];
            }
          }
        }
        return maxPriority + 1;
      }

      async function confirmProvisionalBookings(confirmationData) {
        const items = Object.values(cart); if (items.length === 0) { showMessage('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™ã€‚', 'info'); return; }

        // â˜…è¿½åŠ : ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã§å¾…æ©Ÿã—ã¦ã„ã‚‹é–“ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚å†ãƒã‚§ãƒƒã‚¯
        const isAuth = await ensureAuth();
        if (!isAuth) {
          alert("èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
          handleAuthClick();
          return;
        }

        const accountName = cartMeta.account || '';
        const notionUrl = cartMeta.notionUrl || '';
        const projectNames = cartMeta.projectNames || [];
        const updaterEmail = currentUser?.email || '';
        const projectId = extractNotionPageId(notionUrl);

        if (!accountName) { showMessage('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error'); return; }
        if (!projectNames[0]) { showMessage('ä½œå“å1ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error'); return; }
        if (!updaterEmail) { showMessage('æ›´æ–°è€…æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'error'); return; }

        showLoader(true);
        const internalEvents = [];

        try {
          // ã€é‡è¦ã€‘é€ä¿¡ç›´å‰ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶å–å¾—ï¼ˆæ’ä»–åˆ¶å¾¡ã®ãŸã‚ï¼‰
          await fetchCastingDataFromSheet();

          // ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒã‚§ãƒƒã‚¯
          const errors = [];
          for (const it of items) {
            const workTitle = it.projectName || projectNames[0];
            const duplicate = castingData.find(c =>
              c.projectName === workTitle &&
              c.castId === it.cast.castId &&
              !['ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'NG'].includes(c.status)
            );
            if (duplicate) {
              errors.push(`ãƒ»${it.cast.name} ã¯ã€ä½œå“ã€Œ${workTitle}ã€ã§æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${duplicate.status} / æ‹…å½“: ${duplicate.updatedBy || 'ä¸æ˜'}ï¼‰`);
            }
          }

          if (errors.length > 0) {
            showLoader(false);
            alert("ã€ã‚¨ãƒ©ãƒ¼ï¼šé‡è¤‡ã‚ªãƒ¼ãƒ€ãƒ¼ã€‘\nä»¥ä¸‹ã®ã‚­ãƒ£ã‚¹ãƒˆã¯ã€ã‚¿ãƒƒãƒã®å·®ã§æ—¢ã«åŒä½œå“ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚\n\n" + errors.join("\n"));
            return;
          }

          const values = []; const nowISO = new Date().toISOString();
          const castingIdPrefix = `pc_${Date.now()}`; let seq = 1;
          const ordersForSlack = [];
          const allDateRanges = new Set();
          const tempAssignments = {};
          const allTitlesSet = new Set(); // Slackè¡¨ç¤ºç”¨ã«ä½œå“åã‚’åé›†

          for (const it of items) {
            const ranges = groupDatesIntoRanges(it.dates);
            const workTitle = it.projectName || projectNames[0];

            // ä½œå“åãƒªã‚¹ãƒˆä½œæˆï¼ˆSlackè¡¨ç¤ºç”¨ï¼‰
            if (!allTitlesSet.has(workTitle)) {
              allTitlesSet.add(workTitle);
            }

            // ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ï¼ˆå†…éƒ¨/å¤–éƒ¨ãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»Slackãƒ¡ãƒ³ã‚·ãƒ§ãƒ³IDï¼‰
            const castFull = castData.find(c => c.castId === it.cast.castId) || null;
            const internalType = castFull?.internalType || '';
            const internalLabel =
              internalType === 'å†…éƒ¨' ? 'å†…éƒ¨' :
                internalType === 'å¤–éƒ¨' ? 'å¤–éƒ¨' :
                  '';
            const emailForRow = internalType === 'å†…éƒ¨' ? (castFull?.email || '') : '';
            const slackMentionId = internalType === 'å†…éƒ¨' ? (castFull?.slackMentionId || '') : '';
            const isInternal = internalType === 'å†…éƒ¨';

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆæœŸå€¤
            const statusValue = isInternal
              ? 'ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°'
              : 'ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡';

            // Slack é€šçŸ¥ç”¨ã®æ³¨æ–‡æƒ…å ±
            // â˜…è¿½åŠ : ç«¶åˆãƒã‚§ãƒƒã‚¯ (Conflict Check)
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ç«¶åˆãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã®å¼·åŒ– â˜…â˜…â˜…
            let conflictMsg = null;

            // it.dates ã¯ ['2025-01-01', '2025-01-02'...] ã®å½¢å¼
            for (const d of it.dates) {
              // æ¯”è¼ƒå¯¾è±¡ã®æ—¥ä»˜ Epoch
              const targetEpoch = toEpochDay(d);

              const conflict = castingData.find(c => {
                // è‡ªåˆ†è‡ªèº«ã®ã‚«ãƒ¼ãƒˆå†…ã®é‡è¤‡ã¯é™¤å¤–ï¼ˆåŒã˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®è¿½åŠ ãªã©ã¯OKã¨ã™ã‚‹å ´åˆï¼‰
                if (c.projectName === workTitle) return false;

                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚„NGã¯ç«¶åˆã¨ã¿ãªã•ãªã„
                if (['ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'NG', 'ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°å®Œäº†'].includes(c.status)) return false;

                // ã‚­ãƒ£ã‚¹ãƒˆIDä¸€è‡´
                if (c.castId !== it.cast.castId) return false;

                // æ—¥ä»˜é‡è¤‡ãƒã‚§ãƒƒã‚¯ (Epochå¤‰æ›ã—ã¦æ¯”è¼ƒ)
                // c.startDate / c.endDate ã¯ "YYYY-MM-DD"
                const startEpoch = toEpochDay(c.startDate);
                const endEpoch = toEpochDay(c.endDate);

                if (startEpoch === null || endEpoch === null || targetEpoch === null) return false;

                // ç¯„å›²ãŒé‡ãªã‚‹ã‹ check
                return (targetEpoch >= startEpoch && targetEpoch <= endEpoch);
              });

              if (conflict) {
                const holder = conflict.accountName || 'ä»–ãƒãƒ¼ãƒ ';
                conflictMsg = `â€»å…ˆã«ã€${holder}ã€‘ãŒã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ã„ã¾ã™ï¼ˆ${conflict.status}ï¼‰ã€‚`;
                console.log("Conflict found:", conflictMsg, conflict); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
                break;
              }
            }
            // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

            ordersForSlack.push({
              castingId: `${castingIdPrefix}_${seq}`,
              roleName: it.roleName || '',
              castName: it.cast.name,
              rank: it.rank,
              mainSub: it.mainSub,
              note: it.note || '',
              projectName: workTitle,
              slack_user_id: slackMentionId || null,
              conflictInfo: conflictMsg // â˜…è¿½åŠ 
            });

            for (const rg of ranges) {
              const castingId = `${castingIdPrefix}_${seq++}`;
              allDateRanges.add(`${rg.start}ã€œ${rg.end}`);

              const castPriority = getNextCastPriority(it.cast.castId, rg.start, rg.end, tempAssignments);
              tempAssignments[`${it.cast.castId}_${rg.start}_${rg.end}`] = castPriority;

              // ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ 1 è¡Œåˆ†
              // A: castingId (0)
              // B: accountName (1)
              // C: projectName (2)
              // D: roleName (3)
              // E: castId (4)
              // F: castName (5)
              // G: startDate (6)
              // H: endDate (7)
              // I: rank (8)
              // J: status (9)
              // K: note (10)
              // L: slackThreadTs (11)
              // M: slackPermalink (12)
              // N: mainSub (13)
              // O: calendarEventId (14)
              // P: projectId (15)
              // Q: lastUpdated (16)
              // R: updatedBy (17)
              // S: castPriority (18)
              values.push([
                castingId,         // A (0)
                accountName,       // B (1)
                workTitle,         // C (2)
                it.roleName || '', // D (3)
                it.cast.castId,    // E (4)
                it.cast.name,      // F (5)
                rg.start,          // G (6)
                rg.end,            // H (7)
                it.rank,           // I (8)
                statusValue,       // J (9)
                it.note || '',     // K (10)
                "",                // L (11) slackThreadTs (ã‚ã¨ã§ã¾ã¨ã‚ã¦æ›´æ–°)
                "",                // M (12) slackPermalink (ã‚ã¨ã§ã¾ã¨ã‚ã¦æ›´æ–°)
                it.mainSub || 'ãã®ä»–', // N (13) mainSub
                "",                // O (14) calendarEventId (ã‚ã¨ã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆæ™‚ã«æ›´æ–°)
                projectId,         // P (15)
                nowISO,            // Q (16)
                updaterEmail,      // R (17)
                castPriority,      // S (18)
                isInternal ? 'å†…éƒ¨' : 'å¤–éƒ¨', // T (19) internalType
              ]);

              // å†…éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã®ã¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä»®ãƒ›ãƒ¼ãƒ«ãƒ‰å¯¾è±¡ã«ã™ã‚‹
              if (isInternal) {
                internalEvents.push({
                  castingId,
                  cast: it.cast,
                  roleName: it.roleName || '',
                  rank: it.rank,
                  mainSub: it.mainSub,
                  accountName,
                  projectName: workTitle,
                  start: rg.start,
                  end: rg.end,
                  castPriority,
                  email: emailForRow,   // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‹›å¾…ç”¨
                  status: statusValue,  // ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç”¨
                  rowNumber: null,      // å¾Œã§åŸ‹ã‚ã‚‹
                });
              }
            }
          }
          if (values.length === 0) { showMessage('è¿½åŠ å¯¾è±¡ã®æ—¥ä»˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'info'); return; }

          const appendResult = await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID, range: 'ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!A2',
            valueInputOption: 'USER_ENTERED', insertDataOption: 'INSERT_ROWS',
            resource: { values }
          });

          // B-2 -> A-2: åˆå›ã‚ªãƒ¼ãƒ€ãƒ¼ã‹è¿½åŠ ã‚ªãƒ¼ãƒ€ãƒ¼ã‹ã‚’åˆ¤å®š
          const isAdditionalOrder = isAdditionalOrderMode;
          const finalContext = isAdditionalOrder ? additionalOrderContext : null;

          let slackTs = "", slackLink = "";

          if (!isAdditionalOrder) {
            // --- åˆå›ã‚ªãƒ¼ãƒ€ãƒ¼ï¼šä»Šã¾ã§é€šã‚Š /api/notify/order_created ã‚’å‘¼ã¶ ---
            const existingThread = findExistingThreadForOrder(accountName, projectId, Array.from(allDateRanges));
            if (existingThread) {
              // æ—¢å­˜ã‚¹ãƒ¬ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯ã€è¿½åŠ ã‚ªãƒ¼ãƒ€ãƒ¼ã¨ã—ã¦æ‰±ã†
              slackTs = existingThread.slackThreadTs;
              slackLink = existingThread.slackPermalink;
              // é€šçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ã¯å¾Œç¶šã® status_update ã«ä»»ã›ã‚‹
            } else {
              try {
                const payload = {
                  accountName: cartMeta.account,
                  projectName: "è¤‡æ•°ã®ã‚ªãƒ¼ãƒ€ãƒ¼",
                  projectId: extractNotionPageId(cartMeta.notionUrl) || "00000000-0000-0000-0000-000000000000",
                  dateRanges: Array.from(allDateRanges),
                  orders: ordersForSlack,
                  orderType: "test" // Default
                };

                // Use FormData to send file and payload
                const formData = new FormData();
                formData.append('payload_str', JSON.stringify(payload));
                if (cartMeta.pdfFiles && cartMeta.pdfFiles.length > 0) {
                  for (let i = 0; i < cartMeta.pdfFiles.length; i++) {
                    formData.append('files', cartMeta.pdfFiles[i]);
                  }
                }

                try {
                  const res = await fetch('/api/notify/order_created', {
                    method: 'POST',
                    body: formData // Content-Type header is set automatically
                  });
                  if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'é€ä¿¡ã‚¨ãƒ©ãƒ¼');
                  }
                  const data = await res.json();
                  if (data.upload_error) {
                    showMessage(`ã‚ªãƒ¼ãƒ€ãƒ¼ã¯é€ä¿¡ã•ã‚Œã¾ã—ãŸãŒã€PDFã®æ·»ä»˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.upload_error}`, 'error');
                  } else {
                    showMessage('ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼');
                  }

                  // Set Slack info for sheet update
                  slackTs = data.ts;
                  slackLink = data.permalink;
                  cart = {};
                  cartMeta = { account: '', notionUrl: '', projectNames: ['', '', ''], combinedProjectNames: [] };
                  cartStep = 1;
                  updateCartCount();
                  closeCartModal();
                  closeConfirmationModal();
                  displayAvailableCasts();

                  // Reload data to reflect new status
                  setTimeout(() => {
                    loadAllData();
                  }, 2000);

                } catch (e) {
                  console.error(e);
                  showMessage(`é€ä¿¡å¤±æ•—: ${e.message}`, 'error');
                } finally {
                  showLoader(false);
                }
              } catch (e) {
                console.error("Slack notification failed:", e);
                showMessage('Slacké€šçŸ¥APIã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
              }
            }
          } else {
            // --- è¿½åŠ ã‚ªãƒ¼ãƒ€ãƒ¼ï¼šæ—¢å­˜ thread ã« status_update ã‚’é£›ã°ã™ ---
            const threadTs = finalContext.slackThreadTs;
            if (threadTs) {
              const blockLines = items.map(item => {
                const workTitle = item.projectName || finalContext.projectName;
                const roleName = item.roleName || 'å½¹åæœªå®š';
                return `${workTitle}
${roleName}ï¼š${item.cast.name}`;
              });
              const extraMessage = blockLines.join("\n");

              const mockRec = {
                castingId: values[0]?.[0] || '',
                castName: items.map(it => it.cast.name).join(', '),
                slackThreadTs: threadTs,
                slackPermalink: finalContext.slackPermalink,
                isInternal: false,
              };

              await postStatusUpdateToSlack(mockRec, 'è¿½åŠ ã‚ªãƒ¼ãƒ€ãƒ¼', extraMessage);

              // Set slackTs and slackLink for the new rows
              slackTs = finalContext.slackThreadTs;
              slackLink = finalContext.slackPermalink;
            }
          }

          if (slackTs && slackLink) {
            const updatedRange = appendResult.result.updates.updatedRange;
            const match = updatedRange.match(/!A(\d+):/);
            if (match) {
              const startRow = parseInt(match[1], 10);

              // 1) castingId ã”ã¨ã®ã‚·ãƒ¼ãƒˆè¡Œç•ªå·ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
              const rowNumberByCastingId = new Map();
              for (let i = 0; i < values.length; i++) {
                const castingId = values[i][0]; // Aåˆ—
                const rowNum = startRow + i;
                if (castingId) {
                  rowNumberByCastingId.set(castingId, rowNum);
                }
              }

              // 2) Slack ã® L/M åˆ—æ›´æ–°
              const updates = [];
              for (let i = 0; i < values.length; i++) {
                const rowNum = startRow + i;
                // å…ˆé ­ã« ' ã‚’ä»˜ã‘ã¦ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ä¿å­˜ï¼ˆå°æ•°ç‚¹ä»¥ä¸‹ã‚’ä¿æŒã™ã‚‹ãŸã‚ï¼‰
                updates.push({
                  range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!L${rowNum}`,
                  values: [[`'${slackTs}`]],
                });
                updates.push({
                  range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!M${rowNum}`,
                  values: [[slackLink]],
                });
              }

              await gapi.client.sheets.spreadsheets.values.batchUpdate({
                spreadsheetId: SPREADSHEET_ID,
                resource: { valueInputOption: 'USER_ENTERED', data: updates }
              });

              // 3) internalEvents ã«è¡Œç•ªå·ã‚’åŸ‹ã‚ã‚‹
              internalEvents.forEach(ev => {
                ev.rowNumber = rowNumberByCastingId.get(ev.castingId) || null;
              });
            }
          }

          values.forEach(r => {
            const s = normalizeDateString(r[6]), e = normalizeDateString(r[7]);
            if (!castingData.find(c => c.castingId === r[0])) {
              castingData.push({
                castingId: r[0], accountName: r[1], projectName: r[2], roleName: r[3],
                castId: r[4], castName: r[5], startDate: s, endDate: e, startDay: toEpochDay(s), endDay: toEpochDay(e),
                rank: r[8], status: r[9], note: r[10], slackThreadTs: slackTs, slackPermalink: slackLink,
                mainSub: r[13], calendarEventId: r[14], projectId: r[15], lastUpdated: r[16], updatedBy: r[17],
                castPriority: r[18]
              });
            }
          });

          await createInternalHoldEvents(internalEvents);

          cart = {}; cartMeta = { account: '', notionUrl: '', projectNames: ['', '', ''], combinedProjectNames: [] }; cartStep = 1;
          updateCartCount(); closeCartModal(); closeConfirmationModal(); displayAvailableCasts();
          await renderCastingStatusView(true);
          showMessage('ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚’ç™»éŒ²ã—ã€Slackã«é€šçŸ¥ã—ã¾ã—ãŸã€‚');

          // A-2: è¿½åŠ ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
          if (isAdditionalOrderMode) {
            isAdditionalOrderMode = false;
            additionalOrderContext = null;
          }
        } catch (e) {
          console.error(e);
          showMessage('ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã®ç™»éŒ²ã¾ãŸã¯Slacké€šçŸ¥ã®é€£æºã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        } finally {
          showLoader(false);
        }
      }

      async function createInternalHoldEvents(events) {
        if (!events || events.length === 0) return;
        if (!INTERNAL_HOLD_CALENDAR_ID) {
          console.warn('INTERNAL_HOLD_CALENDAR_ID ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ä»®ãƒ›ãƒ¼ãƒ«ãƒ‰ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚');
          return;
        }

        const calUpdates = [];

        for (const ev of events) {
          // ã‚µãƒãƒªãƒ¼ï¼ˆä»®ãƒ›ãƒ¼ãƒ«ãƒ‰æ™‚ç‚¹ï¼‰
          const summary = `${ev.accountName || 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœªè¨­å®š'}_${ev.rank || ''}å€™è£œ_ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°`;

          // èª¬æ˜æ–‡ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä»˜ãï¼‰
          const descriptionLines = [];
          descriptionLines.push('ã€ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ä»®ãƒ›ãƒ¼ãƒ«ãƒ‰ã€‘');
          descriptionLines.push('');
          descriptionLines.push(`ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: ${ev.accountName || 'æœªè¨­å®š'}`);
          descriptionLines.push(`ãƒ»ä½œå“å: ${ev.projectName || 'æœªè¨­å®š'}`);
          descriptionLines.push(`ãƒ»å½¹å: ${ev.roleName || 'æœªè¨­å®š'}`);
          descriptionLines.push(`ãƒ»åŒºåˆ†: ${ev.mainSub || 'ãã®ä»–'}`);
          descriptionLines.push(`ãƒ»ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ID: ${ev.castingId}`);
          descriptionLines.push(`ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${ev.status || 'ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°'}`);
          descriptionLines.push('');
          descriptionLines.push('ã“ã®äºˆå®šã¯ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰è‡ªå‹•ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚');
          descriptionLines.push('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã«ã¯ã‚·ã‚¹ãƒ†ãƒ å´ã§æ›´æ–°ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚');

          // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆç”¨ï¼ˆend ã¯ç¿Œæ—¥ï¼‰
          const startDateStr = ev.start;
          const endDateObj = new Date(ev.end);
          endDateObj.setDate(endDateObj.getDate() + 1);
          const endDateStr = d2str(endDateObj);

          const resource = {
            summary,
            description: descriptionLines.join('\n'),
            start: { date: startDateStr, timeZone: 'Asia/Tokyo' },
            end: { date: endDateStr, timeZone: 'Asia/Tokyo' },
          };

          // å†…éƒ¨ã‚­ãƒ£ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Œã°å‡ºå¸­è€…ã¨ã—ã¦æ‹›å¾…
          if (ev.email) {
            resource.attendees = [{ email: ev.email }];
          }

          try {
            const res = await gapi.client.calendar.events.insert({
              calendarId: INTERNAL_HOLD_CALENDAR_ID,
              resource,
            });

            const eventId = res.result.id;
            if (eventId && ev.rowNumber) {
              calUpdates.push({
                range: `ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!O${ev.rowNumber}`, // Oåˆ—: calendarEventId
                values: [[eventId]],
              });
            }
          } catch (e) {
            console.error('å†…éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã®ä»®ãƒ›ãƒ¼ãƒ«ãƒ‰ä½œæˆã«å¤±æ•—:', e);
            showMessage('å†…éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã®ä»®ãƒ›ãƒ¼ãƒ«ãƒ‰ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
          }
        }

        // ã¾ã¨ã‚ã¦ N åˆ—ã« eventId ã‚’æ›¸ãæˆ»ã—
        if (calUpdates.length) {
          try {
            await gapi.client.sheets.spreadsheets.values.batchUpdate({
              spreadsheetId: SPREADSHEET_ID,
              resource: {
                valueInputOption: 'USER_ENTERED',
                data: calUpdates,
              },
            });
          } catch (e) {
            console.error('calendarEventId ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—:', e);
          }
        }
      }




      // ========= Shooting Contact Page =========

      let currentContactTab = 'é¦™ç›¤é€£çµ¡å¾…ã¡'; // 'é¦™ç›¤é€£çµ¡å¾…ã¡' | 'ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡' | 'æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡'

      async function showShootContactPage() {
        const view = document.getElementById("main-view");
        if (!view) return;

        view.innerHTML = `
      <div class="p-4">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">æ’®å½±é€£çµ¡ç®¡ç†</h2>
        
        <div class="flex space-x-1 border-b mb-6 overflow-x-auto">
            <button class="contact-tab px-4 py-2 font-medium text-sm rounded-t-lg border-b-2 transition-colors whitespace-nowrap ${currentContactTab === 'é¦™ç›¤é€£çµ¡å¾…ã¡' ? 'border-blue-500 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}" data-tab="é¦™ç›¤é€£çµ¡å¾…ã¡">
                1. é¦™ç›¤é€£çµ¡å¾…ã¡
            </button>
            <button class="contact-tab px-4 py-2 font-medium text-sm rounded-t-lg border-b-2 transition-colors whitespace-nowrap ${currentContactTab === 'ç™ºæ³¨æ›¸é€ä¿¡å¾…ã¡' ? 'border-blue-500 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}" data-tab="ç™ºæ³¨æ›¸é€ä¿¡å¾…ã¡">
                2. ç™ºæ³¨æ›¸é€ä¿¡å¾…ã¡
            </button>
            <button class="contact-tab px-4 py-2 font-medium text-sm rounded-t-lg border-b-2 transition-colors whitespace-nowrap ${currentContactTab === 'ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡' ? 'border-blue-500 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}" data-tab="ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡">
                3. ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡
            </button>
            <button class="contact-tab px-4 py-2 font-medium text-sm rounded-t-lg border-b-2 transition-colors whitespace-nowrap ${currentContactTab === 'æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡' ? 'border-blue-500 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}" data-tab="æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡">
                4. æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡
            </button>
        </div>

        <div id="shoot-contact-loading" class="text-gray-500 mb-4 hidden">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="shoot-contact-container" class="overflow-x-auto"></div>
      </div>
    `;
        // Event Listeners
        view.querySelectorAll('.contact-tab').forEach(btn => {
          btn.addEventListener('click', () => {
            currentContactTab = btn.dataset.tab;
            showShootContactPage();
          });
        });

        await loadShootingContactPage();
      }

      async function loadShootingContactPage() {
        const loading = document.getElementById("shoot-contact-loading");
        const container = document.getElementById("shoot-contact-container");
        if (!loading || !container) return;

        try {
          loading.classList.remove('hidden');
          const res = await fetch("/api/shooting_contact/list");
          if (!res.ok) {
            container.innerHTML = `<p class="text-red-500">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (APIã‚¨ãƒ©ãƒ¼)</p>`;
            return;
          }

          const allItems = await res.json();
          window.shootingContactData = allItems; // Store globally

          // Filter by current tab
          const items = allItems.filter(item => item.status === currentContactTab);

          // Header with Sync Button (Dynamic based on tab)
          let syncBtnHtml = "";
          if (currentContactTab === 'é¦™ç›¤é€£çµ¡å¾…ã¡') {
            syncBtnHtml = `
            <button onclick="syncShootingSchedule(this, 'schedule')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2 shadow transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                é¦™ç›¤DBã¨åŒæœŸ
            </button>`;
          } else if (currentContactTab === 'ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡') {
            syncBtnHtml = `
            <button onclick="syncShootingSchedule(this, 'making')" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2 shadow transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                ãƒ¡ã‚¤ã‚­ãƒ³ã‚°DBã¨åŒæœŸ
            </button>`;
          } else if (currentContactTab === 'æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡') {
            syncBtnHtml = `
            <button onclick="syncShootingSchedule(this, 'post_date')" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2 shadow transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                æŠ•ç¨¿æ—¥DBã¨åŒæœŸ
            </button>`;
          }

          let headerHtml = `
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">æ’®å½±é€£çµ¡ç®¡ç†</h2>
            ${syncBtnHtml}
        </div>
      `;

          if (!items || items.length === 0) {
            container.innerHTML = headerHtml + `<div class="p-8 text-center text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300">
            <p class="text-lg">ã€Œ${currentContactTab}ã€ã®å¯¾è±¡ã¯ã‚ã‚Šã¾ã›ã‚“</p>
        </div>`;
            return;
          }

          // Grouping: Date -> Account+NotionID
          // We want to display Account Name / Project Name in the header.
          const grouped = {};
          items.forEach(item => {
            let dateKey = item.shootDate || "æœªå®š";
            if (currentContactTab === 'æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡') {
              dateKey = item.postDate || "æœªå®š";
            }

            const notionId = item.notionId || "NoID";
            const account = item.accountName || "æœªè¨­å®š";
            const project = item.projectName || "æœªè¨­å®š";

            if (!grouped[dateKey]) grouped[dateKey] = {};

            // Create a unique key for the group
            // If NotionID exists, use it. If not, use Project Name to avoid grouping unrelated "NoID" items.
            // Also include Account Name to prevent cross-account merging.
            const groupKey = `${account}_${notionId !== "NoID" ? notionId : project}`;

            if (!grouped[dateKey][groupKey]) {
              grouped[dateKey][groupKey] = {
                accountName: account,
                projectName: project,
                items: []
              };
            }
            grouped[dateKey][groupKey].items.push(item);
          });

          // Render Accordion
          let html = '<div class="space-y-2">';

          // Sort dates
          const dates = Object.keys(grouped).sort();

          dates.forEach(date => {
            const dateLabel = (currentContactTab === 'æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡') ? `ğŸ“® æŠ•ç¨¿æ—¥: ${date}` : `ğŸ“… æ’®å½±æ—¥: ${date}`;
            html += `
            <div class="border rounded-lg bg-white overflow-hidden">
                <button class="w-full px-4 py-3 bg-gray-100 text-left font-bold flex justify-between items-center hover:bg-gray-200 transition" onclick="toggleAccordion(this)">
                    <span>${dateLabel}</span>
                    <span class="text-xs text-gray-500">â–¼</span>
                </button>
                <div class="hidden border-t">
          `;

            // Sort projects within date (by Account then Project)
            const groupKeys = Object.keys(grouped[date]).sort((a, b) => {
              const groupA = grouped[date][a];
              const groupB = grouped[date][b];
              if (groupA.accountName !== groupB.accountName) {
                return groupA.accountName.localeCompare(groupB.accountName);
              }
              return groupA.projectName.localeCompare(groupB.projectName);
            });

            groupKeys.forEach(key => {
              const group = grouped[date][key];
              const projectItems = group.items;

              html += `
                <div class="border-b last:border-b-0">
                    <button class="w-full px-4 py-2 bg-white text-left font-medium text-sm flex justify-between items-center hover:bg-blue-50 transition pl-8" onclick="toggleAccordion(this)">
                        <span>ğŸ¢ ${group.accountName} / ğŸ¬ ${group.projectName} (${projectItems.length}å)</span>
                        <span class="text-xs text-gray-500">â–¼</span>
                    </button>
                    <div class="hidden border-t p-2 pl-8 bg-gray-50">
                        ${renderProjectTable(projectItems)}
                    </div>
                </div>
              `;
            });

            html += `</div></div>`;
          });

          html += '</div>';
          container.innerHTML = headerHtml + html;

        } catch (err) {
          console.error(err);
          container.innerHTML = `<p class="text-red-500">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>`;
        } finally {
          loading.classList.add('hidden');
        }
      }

      // Helper for Accordion
      window.toggleAccordion = function (btn) {
        const content = btn.nextElementSibling;
        content.classList.toggle('hidden');
        const icon = btn.querySelector('span:last-child');
        if (icon) icon.textContent = content.classList.contains('hidden') ? 'â–¼' : 'â–²';
      };

      function renderProjectTable(items) {
        // Dynamic Columns based on Tab
        let extraHeader = "";
        let costHeader = ""; // é‡‘é¡ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨

        if (currentContactTab === 'é¦™ç›¤é€£çµ¡å¾…ã¡') {
          extraHeader = '<th class="px-2 py-2 text-left w-64">æ™‚é–“/å ´æ‰€</th>';
          costHeader = '<th class="px-2 py-2 text-left w-24">é‡‘é¡</th>';
        } else if (currentContactTab === 'ç™ºæ³¨æ›¸é€ä¿¡å¾…ã¡') {
          // â˜…è¿½åŠ : ç™ºæ³¨æ›¸é€ä¿¡å¾…ã¡ç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé¦™ç›¤é€£çµ¡å¾…ã¡ã¨åŒæ§˜ã«è¦‹ã›ã‚‹ï¼‰
          extraHeader = '<th class="px-2 py-2 text-left w-64">æ™‚é–“/å ´æ‰€</th>';
          costHeader = '<th class="px-2 py-2 text-left w-24">é‡‘é¡</th>';
        } else if (currentContactTab === 'ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡') {
          extraHeader = '<th class="px-2 py-2 text-left w-24">ãƒ¡ã‚¤ã‚­ãƒ³ã‚°URL</th>';
        } else if (currentContactTab === 'æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡') {
          extraHeader = '<th class="px-2 py-2 text-left w-24">æŠ•ç¨¿æ—¥</th>';
        }

        let html = `
        <table class="min-w-full bg-white border rounded-lg overflow-hidden table-fixed">
          <thead class="bg-gray-100 text-xs text-gray-500 uppercase">
            <tr>
              <th class="px-2 py-2 text-left w-48">æ¡ˆä»¶å / å½¹å</th>
              <th class="px-2 py-2 text-left w-24">ã‚­ãƒ£ã‚¹ãƒˆ</th>
              <th class="px-2 py-2 text-left w-12">M/S</th>
              <th class="px-2 py-2 text-left w-24">æ—¥æ™‚/å ´æ‰€</th>
              ${costHeader ? '<th class="px-2 py-2 text-left w-12">é‡‘é¡</th>' : ''}
              ${!costHeader && extraHeader ? extraHeader : ''}
              <th class="px-2 py-2 text-center w-20">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
      `;

        items.forEach(item => {
          let extraCol = "";
          let costCol = "";
          let actionBtns = "";

          // ãƒ¡ãƒ¼ãƒ«ä½œæˆãƒœã‚¿ãƒ³ï¼ˆå…±é€šï¼‰
          const mailBtn = `
            <button class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 shadow-sm whitespace-nowrap w-full"
                onclick="openShootMailModal('${item.castingId}')">
                âœ‰ï¸ ä½œæˆ
            </button>`;

          if (currentContactTab === 'é¦™ç›¤é€£çµ¡å¾…ã¡') {
            // æ™‚é–“ãƒ»å ´æ‰€ã‚’ç·¨é›†å¯èƒ½ãª input ã«å¤‰æ›´
            extraCol = `
            <td class="px-2 py-2 align-top">
              <div class="flex flex-col gap-1">
                <div class="flex items-center gap-1">
                   <span class="text-xs text-gray-400 w-6">IN</span>
                   <input type="text" class="shoot-in border rounded px-1 py-0.5 text-xs w-full bg-gray-50 focus:bg-white focus:ring-1 focus:ring-blue-300" 
                          value="${item.inTime || ''}" placeholder="00:00">
                </div>
                <div class="flex items-center gap-1">
                   <span class="text-xs text-gray-400 w-6">OUT</span>
                   <input type="text" class="shoot-out border rounded px-1 py-0.5 text-xs w-full bg-gray-50 focus:bg-white focus:ring-1 focus:ring-blue-300" 
                          value="${item.outTime || ''}" placeholder="00:00">
                </div>
                <input type="text" class="shoot-location border rounded px-1 py-0.5 text-xs w-full mt-1 bg-gray-50 focus:bg-white focus:ring-1 focus:ring-blue-300" 
                       value="${item.location || ''}" placeholder="å ´æ‰€">
              </div>
            </td>`;

            // é‡‘é¡å…¥åŠ›æ¬„ (Påˆ—)
            costCol = `
            <td class="px-2 py-2 align-top">
              <input type="text" class="shoot-cost border rounded px-1 py-0.5 text-xs w-full text-right bg-gray-50 focus:bg-white focus:ring-1 focus:ring-blue-300" 
                     value="${item.cost || ''}" placeholder="Â¥">
            </td>`;

            // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            actionBtns = `
            <div class="flex flex-col gap-2 items-center">
                <button class="px-2 py-1 bg-emerald-600 text-white rounded text-xs hover:bg-emerald-700 shadow-sm whitespace-nowrap w-full"
                    onclick="saveShootingRow('${item.castingId}', this)">
                    ğŸ’¾ ä¿å­˜
                </button>
                ${mailBtn}
            </div>`;

          } else if (currentContactTab === 'ç™ºæ³¨æ›¸é€ä¿¡å¾…ã¡') {
            // â˜…è¿½åŠ : ç™ºæ³¨æ›¸é€ä¿¡å¾…ã¡ã®ãƒ­ã‚¸ãƒƒã‚¯
            // é¦™ç›¤é€£çµ¡å¾…ã¡ã¨åŒæ§˜ã«ç·¨é›†å¯èƒ½ã«ã™ã‚‹
            extraCol = `
            <td class="px-2 py-2 align-top">
              <div class="flex flex-col gap-1">
                <div class="flex items-center gap-1">
                   <span class="text-xs text-gray-400 w-6">IN</span>
                   <input type="text" class="shoot-in border rounded px-1 py-0.5 text-xs w-full bg-gray-50 focus:bg-white focus:ring-1 focus:ring-blue-300" 
                          value="${item.inTime || ''}" placeholder="00:00">
                </div>
                <div class="flex items-center gap-1">
                   <span class="text-xs text-gray-400 w-6">OUT</span>
                   <input type="text" class="shoot-out border rounded px-1 py-0.5 text-xs w-full bg-gray-50 focus:bg-white focus:ring-1 focus:ring-blue-300" 
                          value="${item.outTime || ''}" placeholder="00:00">
                </div>
                <input type="text" class="shoot-location border rounded px-1 py-0.5 text-xs w-full mt-1 bg-gray-50 focus:bg-white focus:ring-1 focus:ring-blue-300" 
                       value="${item.location || ''}" placeholder="å ´æ‰€">
              </div>
            </td>`;

            costCol = `
            <td class="px-2 py-2 align-top">
              <input type="text" class="shoot-cost border rounded px-1 py-0.5 text-xs w-full text-right bg-gray-50 focus:bg-white focus:ring-1 focus:ring-blue-300" 
                     value="${item.cost || ''}" placeholder="Â¥">
            </td>`;

            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³: ä¿å­˜ã€ç™ºæ³¨æ›¸ä½œæˆã€ãƒ¡ãƒ¼ãƒ«
            actionBtns = `
            <div class="flex flex-col gap-2 items-center">
                <button class="px-2 py-1 bg-emerald-600 text-white rounded text-xs hover:bg-emerald-700 shadow-sm whitespace-nowrap w-full"
                    onclick="saveShootingRow('${item.castingId}', this)">
                    ğŸ’¾ ä¿å­˜
                </button>
                <button class="px-2 py-1 bg-indigo-600 text-white rounded text-xs hover:bg-indigo-700 shadow-sm whitespace-nowrap w-full"
                    onclick="openOrderDocModal('${item.castingId}')">
                    ğŸ“„ ç™ºæ³¨æ›¸
                </button>
                ${mailBtn}
            </div>`;

          } else if (currentContactTab === 'ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡') {
            extraCol = `<td class="px-2 py-2 text-xs text-blue-600 truncate max-w-xs"><a href="${item.makingUrl}" target="_blank">${item.makingUrl || '-'}</a></td>`;
            costCol = `<td class="px-2 py-2 text-xs text-right">${item.cost || '-'}</td>`;
            actionBtns = mailBtn;
          } else if (currentContactTab === 'æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡') {
            extraCol = `<td class="px-2 py-2 text-xs">${item.postDate || '-'}</td>`;
            costCol = `<td class="px-2 py-2 text-xs text-right">${item.cost || '-'}</td>`;
            actionBtns = mailBtn;
          }

          html += `
            <tr class="hover:bg-gray-50">
              <td class="px-2 py-2 align-top">
                <div class="text-sm font-bold text-gray-900">${item.projectName}</div>
                <div class="text-xs text-gray-500">${item.roleName}</div>
              </td>
              <td class="px-2 py-2 align-top">
                <div class="text-sm text-gray-900">${item.castName}</div>
              </td>
              <td class="px-2 py-2 align-top">
                <div class="text-xs text-gray-500">${item.mainSub || '-'}</div>
              </td>
              ${extraCol ? extraCol : `<td class="px-2 py-2 align-top text-sm text-gray-500">${item.date}</td>`}
              ${costCol ? costCol : (costHeader ? `<td class="px-2 py-2 align-top text-sm text-gray-500">${item.cost || ''}</td>` : '')}
              ${!costHeader && extraHeader ? `<td class="px-2 py-2 align-top text-sm text-gray-500">${item.makingUrl || item.postDate || ''}</td>` : ''}
              <td class="px-2 py-2 align-top text-center">
                ${actionBtns}
              </td>
            </tr>
          `;
        });

        html += `</tbody></table>`;
        return html;
      }

      // Make functions global
      // è¡Œã”ã¨ã®ä¿å­˜å‡¦ç†
      window.saveCastingCost = async function (castingId, currentStatus, btn) {
        const row = btn.closest('tr');
        if (!row) return;
        const costInput = row.querySelector('.status-cost-input');
        if (!costInput) return;

        const newCost = costInput.value.trim();
        const originalText = btn.innerText;
        btn.innerText = '...';
        btn.disabled = true;

        try {
          // Reuse changeCastingStatus to update Cost (and Status, which is unchanged)
          await changeCastingStatus(castingId, currentStatus, {
            cost: newCost,
            quick: true // Suppress some UI feedback if needed, or just standard
          });
          // changeCastingStatus already shows message and re-renders if needed
          // But we might want to avoid full re-render if possible?
          // changeCastingStatus calls renderCastingStatusView(false) at the end.
        } catch (e) {
          console.error(e);
          showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      };

      window.saveShootingRow = async function (castingId, btn) {
        const row = btn.closest('tr');
        if (!row) return;

        const inTime = row.querySelector('.shoot-in')?.value || '';
        const outTime = row.querySelector('.shoot-out')?.value || '';
        const location = row.querySelector('.shoot-location')?.value || '';
        const cost = row.querySelector('.shoot-cost')?.value || '';

        // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
        const originalText = btn.innerHTML;
        btn.innerHTML = '...';
        btn.disabled = true;

        try {
          // updateShootingContactFields ã‚’å‘¼ã¶ (API: /api/shooting_contact/update)
          // æ—¢å­˜ã® updateShootingContactFields (æ±ç”¨) ã‚’ä½¿ã„ã¾ã™

          const res = await fetch("/api/shooting_contact/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              castingId: castingId,
              inTime: inTime,
              outTime: outTime,
              location: location,
              cost: cost  // æ–°è¦è¿½åŠ : Påˆ—
            })
          });

          if (res.ok) {
            showMessage('æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°ã—ã¦ãŠãï¼ˆå†èª­ã¿è¾¼ã¿ã¾ã§ã®è¡¨ç¤ºç”¨ï¼‰
            const item = (window.shootingContactData || []).find(i => i.castingId === castingId);
            if (item) {
              item.inTime = inTime;
              item.outTime = outTime;
              item.location = location;
              item.cost = cost;
            }
          } else {
            throw new Error('Update failed');
          }
        } catch (e) {
          console.error(e);
          showMessage('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        } finally {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      };

      // ========= Cast Detail Modal =========
      function openCastDetailModal(castId) {
        const cast = castData.find(c => c.castId === castId);
        if (!cast) return;

        const modal = document.getElementById('cart-modal'); // Reusing cart-modal container for simplicity or create new one?
        // Using a dedicated modal container is better to avoid conflict.
        // Let's use a new one dynamically or reuse 'new-external-cast-modal' structure?
        // Creating a new one in HTML structure is best, but I can inject it dynamically.

        let detailModal = document.getElementById('cast-detail-modal');
        if (!detailModal) {
          detailModal = document.createElement('div');
          detailModal.id = 'cast-detail-modal';
          detailModal.className = 'hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
          document.body.appendChild(detailModal);
        }

        const inCart = !!cart[cast.castId];
        const stat = getCastStatusForDates(cast.castId, selectedDates);
        const isNG = stat.isNG;
        const isConfirmed = stat.isConfirmed;
        const disabled = isNG || isConfirmed || inCart;
        const btnText = isConfirmed ? 'ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ä¸å¯' : (isNG ? 'NG' : (inCart ? 'è¿½åŠ æ¸ˆã¿' : 'ä»®ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆã«è¿½åŠ '));
        const btnClass = disabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700';

        // SNS Links
        const snsLinks = [];
        if (cast.snsX) {
          snsLinks.push(`<a href="${cast.snsX}" target="_blank" class="text-gray-500 hover:text-black"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>`);
        }
        if (cast.snsInsta) {
          snsLinks.push(`<a href="${cast.snsInsta}" target="_blank" class="text-gray-500 hover:text-pink-600"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></a>`);
        }
        if (cast.snsTiktok) {
          snsLinks.push(`<a href="${cast.snsTiktok}" target="_blank" class="text-gray-500 hover:text-black"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.35-1.17 1.09-1.07 1.93.03.58.01 1.16.44 1.57.89.97 2.55.88 3.4-.14.57-.71.79-1.6.78-2.49-.01-4.22.01-8.43.01-12.65-.02-.03-.03-.07-.05-.1z"/></svg></a>`);
        }

        // Helper to format Drive URL
        function formatDriveUrl(url) {
          if (!url) return "";
          if (url.includes("drive.google.com")) {
            let id = "";
            const idMatch = url.match(/id=([^&]+)/);
            const fileMatch = url.match(/\/file\/d\/([^/]+)/);
            if (idMatch) id = idMatch[1];
            else if (fileMatch) id = fileMatch[1];
            if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
          }
          return url;
        }
        const displayUrl = formatDriveUrl(cast.imageUrl);

        // Purchase Order Button Condition
        const relevantCasting = castingData.find(c => c.castId === castId && overlaps(selectedDates[0], selectedDates[selectedDates.length - 1], c.startDate, c.endDate));
        const canDownloadOrder = relevantCasting && ['OK', 'é¦™ç›¤é€£çµ¡å¾…ã¡', 'æ±ºå®š'].includes(relevantCasting.status);

        detailModal.innerHTML = `
          <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative flex flex-col md:flex-row">
             <button onclick="document.getElementById('cast-detail-modal').remove()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 z-10">
               <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
             </button>
             
             <!-- Left: Image -->
             <div class="w-full md:w-1/2 bg-gray-100 flex items-center justify-center p-4">
               ${cast.imageUrl ? `<img src="${formatDriveUrl(cast.imageUrl)}" class="max-w-full max-h-[70vh] object-contain rounded shadow-sm" referrerpolicy="no-referrer">`
            : `<div class="text-gray-400">No Image</div>`}
             </div>

             <!-- Right: Info -->
             <div class="w-full md:w-1/2 p-8 flex flex-col">
               <h2 class="text-3xl font-bold mb-2">${cast.name}</h2>
               <p class="text-lg text-gray-600 mb-4">${cast.agency || 'ãƒ•ãƒªãƒ¼'}</p>
               
               <div class="flex space-x-4 mb-6">
                 ${snsLinks.join('')}
               </div>

               <div class="space-y-3 text-sm text-gray-700 mb-8">
                 <div class="flex border-b pb-2">
                   <span class="w-24 font-bold text-gray-500">å¹´é½¢</span>
                   <span>${cast.age ? cast.age + 'æ­³' : '-'}</span>
                 </div>
                 <div class="flex border-b pb-2">
                   <span class="w-24 font-bold text-gray-500">æ€§åˆ¥</span>
                   <span>${cast.gender || '-'}</span>
                 </div>
                 <div class="flex border-b pb-2">
                   <span class="w-24 font-bold text-gray-500">é€£çµ¡å…ˆ</span>
                   <span class="break-all">${cast.email || '-'}</span>
                 </div>
                 <div class="flex border-b pb-2">
                   <span class="w-24 font-bold text-gray-500">å‚™è€ƒ</span>
                   <span class="whitespace-pre-wrap">${cast.notes || '-'}</span>
                 </div>
               </div>

               <div class="mt-auto">
                 <button onclick="handleAddToCart('${cast.castId}')" 
                   class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow transition ${disabled ? 'opacity-50 cursor-not-allowed' : ''}" ${disabled ? 'disabled' : ''}>
                   ${btnText}
                 </button>
               </div>
             </div>
          </div>
        `;

        detailModal.classList.remove('hidden');

        // Event Listeners
        detailModal.addEventListener('click', (e) => {
          if (e.target === detailModal) detailModal.classList.add('hidden');
        });
      }

      // ========== PDFç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (Google Docså»ƒæ­¢ç‰ˆ) ==========

      // æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼
      async function loadJapaneseFont(doc) {
        // ä»Šå›ã¯html2canvasæ–¹å¼ã®ãŸã‚ã€ã“ã®é–¢æ•°ã¯å®Ÿè³ªæœªä½¿ç”¨ã§ã™ãŒã€å°†æ¥ã®ãŸã‚ã«æ®‹ã—ã¾ã™
      }

      // ========== ç™ºæ³¨æ›¸ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« & PDFç”Ÿæˆ ==========

      // 1. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
      window.openOrderDocModal = function (castingId) {
        // ãƒ‡ãƒ¼ã‚¿å–å¾—
        let targetCasting = null;
        if (window.shootingContactData) {
          targetCasting = window.shootingContactData.find(item => item.castingId === castingId);
        }
        if (!targetCasting) {
          targetCasting = castingData.find(c => c.castingId === castingId);
        }
        if (!targetCasting) {
          showMessage('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
          return;
        }

        // åˆæœŸå€¤ã‚»ãƒƒãƒˆ
        const data = {
          date: new Date().toLocaleDateString(),
          castName: targetCasting.castName || targetCasting.name || '',
          project: targetCasting.projectName || '',
          role: targetCasting.roleName || '',
          shootDate: targetCasting.date || targetCasting.startDate || targetCasting.shootDate || '',
          cost: targetCasting.cost || '',
          note: targetCasting.note || ''
        };

        const modal = document.getElementById('edit-modal'); // æ—¢å­˜ã®æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æµç”¨
        if (!modal) return;

        modal.innerHTML = `
          <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold">ç™ºæ³¨æ›¸ä½œæˆï¼ˆç·¨é›†ï¼‰</h3>
              <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            
            <div class="space-y-3 text-sm">
              <p class="text-xs text-gray-500">PDFã«è¨˜è¼‰ã™ã‚‹å†…å®¹ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</p>
              
              <div>
                <label class="block font-bold text-gray-700">æ—¥ä»˜</label>
                <input type="text" id="pdf-date" class="w-full border rounded p-2" value="${data.date}">
              </div>
              <div>
                <label class="block font-bold text-gray-700">å®›åï¼ˆã‚­ãƒ£ã‚¹ãƒˆæ§˜ï¼‰</label>
                <input type="text" id="pdf-castname" class="w-full border rounded p-2" value="${data.castName}">
              </div>
              <div>
                <label class="block font-bold text-gray-700">æ¡ˆä»¶å</label>
                <input type="text" id="pdf-project" class="w-full border rounded p-2" value="${data.project}">
              </div>
              <div>
                <label class="block font-bold text-gray-700">å½¹å</label>
                <input type="text" id="pdf-role" class="w-full border rounded p-2" value="${data.role}">
              </div>
              <div>
                <label class="block font-bold text-gray-700">æ’®å½±æ—¥</label>
                <input type="text" id="pdf-shootdate" class="w-full border rounded p-2" value="${data.shootDate}">
              </div>
              <div>
                <label class="block font-bold text-gray-700">é‡‘é¡</label>
                <input type="text" id="pdf-cost" class="w-full border rounded p-2" value="${data.cost}" placeholder="æ•°å€¤ã®ã¿å…¥åŠ›ã™ã‚‹ã¨è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¾ã™">
              </div>
              <div>
                <label class="block font-bold text-gray-700">å‚™è€ƒ</label>
                <textarea id="pdf-note" class="w-full border rounded p-2" rows="3">${data.note}</textarea>
              </div>
            </div>

            <div class="mt-6 flex justify-end gap-3">
              <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="px-4 py-2 border rounded hover:bg-gray-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button id="btn-generate-pdf" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded hover:bg-indigo-700">
                PDFã‚’ä½œæˆ
              </button>
            </div>
          </div>
        `;

        modal.classList.remove('hidden');

        // ç”Ÿæˆãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('btn-generate-pdf').addEventListener('click', async () => {
          // UUIDç”Ÿæˆ (æ—¢å­˜ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ã€ãªã‘ã‚Œã°æ–°è¦ç”Ÿæˆ)
          const uuid = targetCasting.poUuid || crypto.randomUUID();

          // Save UUID to Backend
          try {
            await fetch('/api/shooting_contact/update', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                castingId: castingId,
                poUuid: uuid
              })
            });
            // Update local data
            targetCasting.poUuid = uuid;
          } catch (e) {
            console.error("Failed to save PO UUID", e);
            // Continue anyway? Or stop? User said "save to sheet".
            // We should probably alert but continue or stop.
            // For now, log and continue.
          }

          const finalData = {
            date: document.getElementById('pdf-date').value,
            castName: document.getElementById('pdf-castname').value,
            project: document.getElementById('pdf-project').value,
            role: document.getElementById('pdf-role').value,
            shootDate: document.getElementById('pdf-shootdate').value,
            cost: document.getElementById('pdf-cost').value,
            note: document.getElementById('pdf-note').value,
            uuid: uuid
          };
          generatePDFFromData(finalData);
          modal.classList.add('hidden');
        });
      };



      // å­£ç¯€ã®æŒ¨æ‹¶ã‚’å–å¾—ã™ã‚‹é–¢æ•°
      function getSeasonalGreeting() {
        const month = new Date().getMonth() + 1;
        const greetings = {
          1: "åˆæ˜¥", 2: "æ™©å†¬", 3: "æ—©æ˜¥", 4: "é™½æ˜¥", 5: "æ–°ç·‘", 6: "åˆå¤",
          7: "ç››å¤", 8: "æ™©å¤", 9: "åˆç§‹", 10: "ç§‹å†·", 11: "æ™©ç§‹", 12: "åˆå†¬"
        };
        return greetings[month] || "æ™‚ä¸‹";
      }

      // 2. å®Ÿéš›ã®PDFç”Ÿæˆå‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’å¼•æ•°ã§å—ã‘å–ã‚‹ã‚ˆã†ã«å¤‰æ›´ï¼‰
      window.generatePDFFromData = async function (data) {
        // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        let costStr = data.cost;
        const numCost = Number(data.cost.replace(/[^0-9]/g, ''));
        if (numCost > 0 && !data.cost.includes('Â¥')) {
          costStr = `Â¥${numCost.toLocaleString()}`;
        }

        const tempDiv = document.createElement('div');
        tempDiv.style.width = '210mm';
        tempDiv.style.minHeight = '297mm';
        tempDiv.style.padding = '20mm';
        tempDiv.style.backgroundColor = 'white';
        tempDiv.style.color = 'black';
        tempDiv.style.fontFamily = '"Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif';
        tempDiv.style.position = 'fixed';
        tempDiv.style.top = '-9999px';
        tempDiv.style.left = '-9999px';
        tempDiv.style.zIndex = '-100';
        // â˜…ä¿®æ­£: ç·šãŒå…¥ã‚‹å•é¡Œã‚’é˜²ã
        tempDiv.style.textDecoration = 'none';

        const greeting = getSeasonalGreeting();

        tempDiv.innerHTML = `
          <div style="text-decoration: none !important; font-size: 14px; line-height: 1.6;">
            <h1 style="text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 30px;">GOKKOå€¶æ¥½éƒ¨å‡ºæ¼”ç™ºæ³¨æ›¸</h1>
            
            <div style="text-align: right; margin-bottom: 5px;">${data.date}</div>
            <div style="text-align: right; margin-bottom: 20px; font-size: 10px; color: #666;">No. ${data.uuid || ''}</div>
            
            <div style="font-size: 14px; margin-bottom: 20px;">
              <span style="font-size: 14px;">${data.castName} æ§˜</span>
            </div>

            <p style="margin-bottom: 5px;">ã”å¿«è«¾ã„ãŸã ãã¾ã—ãŸãƒ‰ãƒ©ãƒå‡ºæ¼”ã®ä»¶ã«ã¤ãã¾ã—ã¦ã€ä¸‹è¨˜ã®é€šã‚Šç™ºæ³¨ç”³ã—ä¸Šã’ã¾ã™ã€‚<br>
            å†…å®¹ã‚’ã”ç¢ºèªã„ãŸã ãã€ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰æ‹…å½“ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚</p>

            <div style="margin-bottom: 20px; padding: 10px; width: 100%;">
              <p style="font-weight: bold; margin-bottom: 5px;">ã€ç™ºæ³¨å…ƒã€‘</p>
              <p style="margin: 0;">ã€’135-0091</p>
              <p style="margin: 0;">æ±äº¬éƒ½æ¸¯åŒºå°å ´2-3-1ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ”ã‚¢ãŠå°å ´12F</p>
              <p style="margin: 0;">æ ªå¼ä¼šç¤¾GOKKO</p>
              <p style="margin: 0;">æ‹…å½“ï¼šGOKKOå€¶æ¥½éƒ¨ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°æ‹…å½“</p>
            </div>

            <div style="margin-bottom: 20px;">
              <p style="font-weight: bold; display: inline-block; margin-bottom: 10px;">ã€ãŠå–å¼•æ¡ä»¶ã€‘</p>
              <p style="margin: 2px 0;">æ”¯æ‰•æ¡ä»¶ï¼š æœˆæœ«ç· ã‚ç¿Œæœˆæœ«æ‰•ã„</p>
              <p style="margin: 2px 0;">æ”¯æ‰•æ–¹æ³•ï¼š ã”æŒ‡å®šã®éŠ€è¡Œå£åº§ã¸ãŠæŒ¯è¾¼ã¿</p>
              <p style="margin: 2px 0;">ç§˜å¯†ä¿æŒï¼š æœ¬ä»¶ã«é–¢ã‚ã‚‹è„šæœ¬å†…å®¹ã€æ’®å½±æƒ…å ±ã€å…±æ¼”è€…æƒ…å ±ç­‰ã¯ã€å…¬å¼è§£ç¦ã¾ã§ç¬¬ä¸‰è€…ã¸ã®æ¼æ´©ï¼ˆSNSå«ã‚€ï¼‰ã‚’ç¦æ­¢ã¨ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚</p>
              <p style="text-align: right; margin: 0;">ä»¥ä¸Š</p>
            </div>

            <div style="text-align: center; margin-bottom: 20px; font-weight: bold;">è¨˜</div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
              <tr style="border: 1px solid #000;">
                <th style="border: 1px solid #000; padding: 8px; background-color: #f0f0f0; width: 30%; text-align: center;">é …ç›®</th>
                <th style="border: 1px solid #000; padding: 8px; background-color: #f0f0f0; text-align: center;">å†…å®¹</th>
              </tr>
              <tr style="border: 1px solid #000;">
                <td style="border: 1px solid #000; padding: 8px; text-align: center;">æ¡ˆä»¶å</td>
                <td style="border: 1px solid #000; padding: 8px;">${data.project}</td>
              </tr>
              <tr style="border: 1px solid #000;">
                <td style="border: 1px solid #000; padding: 8px; text-align: center;">å½¹å</td>
                <td style="border: 1px solid #000; padding: 8px;">${data.role}</td>
              </tr>
              <tr style="border: 1px solid #000;">
                <td style="border: 1px solid #000; padding: 8px; text-align: center;">æ’®å½±æ—¥</td>
                <td style="border: 1px solid #000; padding: 8px;">${data.shootDate}</td>
              </tr>
              <tr style="border: 1px solid #000;">
                <td style="border: 1px solid #000; padding: 8px; text-align: center;">å‡ºæ¼”æ–™ï¼ˆé‡‘é¡ï¼‰</td>
                <td style="border: 1px solid #000; padding: 8px;">${costStr} ï¼ˆç¨åˆ¥ï¼‰</td>
              </tr>
            </table>

          </div>
        `;

        document.body.appendChild(tempDiv);
        showLoader(true);

        try {
          // html2canvas / jsPDF ã®ãƒ­ãƒ¼ãƒ‰ç¢ºèª
          if (typeof html2canvas === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
          if (typeof window.jspdf === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');

          const canvas = await html2canvas(tempDiv, { scale: 2 });
          const imgData = canvas.toDataURL('image/png');

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

          const fileName = `${data.shootDate.replace(/[\/-]/g, '')}_${data.project}_${data.castName}_ç™ºæ³¨æ›¸.pdf`;
          pdf.save(fileName);

          showMessage('ç™ºæ³¨æ›¸PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        } catch (e) {
          console.error(e);
          showMessage('PDFä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
        } finally {
          document.body.removeChild(tempDiv);
          showLoader(false);
        }
      };

      // æ—§é–¢æ•°ã‚’å‰Šé™¤ã¾ãŸã¯ä¸Šæ›¸ã
      window.createOrderDoc = window.openOrderDocModal;

      // ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ãƒ˜ãƒ«ãƒ‘ãƒ¼
      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = src;
          s.onload = resolve;
          s.onerror = reject;
          document.head.appendChild(s);
        });
      }

      window.openShootMailModal = openShootMailModal;
      window.openShootStatusModal = openShootStatusModal;

      function openShootMailModal(castingId) {

        // Try to find in shootingContactData first, then castingData
        let item = (window.shootingContactData || []).find(i => i.castingId === castingId);
        let isCastingItem = false;

        if (!item) {
          item = castingData.find(c => c.castingId === castingId);
          isCastingItem = true;
        }

        if (!item) { showMessage("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error"); return; }

        const modal = document.getElementById('shoot-mail-modal');
        if (!modal) return;

        // Store current item ID and status for auto-update
        modal.dataset.castingId = castingId;
        modal.dataset.currentStatus = item.status;
        // Store flag to know if we should update casting status or shooting status
        modal.dataset.isCastingItem = isCastingItem;

        let subject = "";
        let body = "";

        // Template Logic
        if (item.status === "é¦™ç›¤é€£çµ¡å¾…ã¡") {
          subject = `ã€é¦™ç›¤é€£çµ¡ã€‘${item.projectName}`;
          body = `${item.castName} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\næ ªå¼ä¼šç¤¾GOKKOã§ã™ã€‚\n\n${item.projectName} ã®é¦™ç›¤ã‚’ãŠé€ã‚Šã„ãŸã—ã¾ã™ã€‚\n\næ—¥æ™‚ï¼š${item.date} ${item.inTime || 'æœªå®š'}ã€œ${item.outTime || 'æœªå®š'}\nå ´æ‰€ï¼š${item.location || 'æœªå®š'}\n\nã”ç¢ºèªã®ã»ã©ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;
        } else if (item.status === "ç™ºæ³¨æ›¸é€ä¿¡å¾…ã¡") {
          // â˜…è¿½åŠ : ç™ºæ³¨æ›¸é€ä»˜ç”¨ã®ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
          subject = `ã€ç™ºæ³¨æ›¸é€ä»˜ã€‘${item.projectName}`;
          body = `${item.castName} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\næ ªå¼ä¼šç¤¾GOKKOã§ã™ã€‚\n\n${item.projectName} ã®ç™ºæ³¨æ›¸ã‚’ãŠé€ã‚Šã„ãŸã—ã¾ã™ã€‚\næ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã”ç¢ºèªã®ã»ã©ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚\n\nå¼•ãç¶šãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;
        } else if (item.status === "ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡") {
          subject = `ã€ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰ã€‘${item.projectName}`;
          body = `${item.castName} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\næ ªå¼ä¼šç¤¾GOKKOã§ã™ã€‚\n\n${item.projectName} ã®ãƒ¡ã‚¤ã‚­ãƒ³ã‚°æ˜ åƒãŒå®Œæˆã„ãŸã—ã¾ã—ãŸã€‚\nä»¥ä¸‹ã®URLã‚ˆã‚Šã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚\n\n${item.makingUrl || '(URL)'}\n\nã”ç¢ºèªã®ã»ã©ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;
        } else if (item.status === "æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡") {
          subject = `ã€æŠ•ç¨¿æ—¥é€£çµ¡ã€‘${item.projectName}`;
          body = `${item.castName} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\næ ªå¼ä¼šç¤¾GOKKOã§ã™ã€‚\n\n${item.projectName} ã®æŠ•ç¨¿æ—¥ãŒæ±ºå®šã„ãŸã—ã¾ã—ãŸã€‚\n\næŠ•ç¨¿æ—¥ï¼š${item.postDate || '(æ—¥ä»˜)'}\n\nã”ç¢ºèªã®ã»ã©ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;
        } else {
          // Default
          subject = `ã€é€£çµ¡ã€‘${item.projectName}`;
          body = `${item.castName} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\næ ªå¼ä¼šç¤¾GOKKOã§ã™ã€‚\n\nï¼ˆæœ¬æ–‡ï¼‰\n\nã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;
        }

        // Find email from castingData (Column U) - redundant if item is from castingData but safe
        const originalRec = castingData.find(c => c.castingId === castingId);
        // â˜…ä¿®æ­£: ã‚­ãƒ£ã‚¹ãƒˆDBã‹ã‚‰ã‚‚æ¤œç´¢ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const castInfo = castData.find(c => c.castId === (originalRec?.castId || item.castId));
        const castEmail = originalRec?.email || item.email || castInfo?.email || "";

        modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">ãƒ¡ãƒ¼ãƒ«ä½œæˆ</h3>
                <button class="text-gray-500 hover:text-gray-700" onclick="document.getElementById('shoot-mail-modal').classList.add('hidden')">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">é€ä¿¡å…ˆ (To)</label>
                    <div class="flex gap-2">
                        <input type="text" id="mail-to-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-50" value="${castEmail}" readonly>
                        <button class="mt-1 px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm" onclick="navigator.clipboard.writeText(document.getElementById('mail-to-input').value); showMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')">ã‚³ãƒ”ãƒ¼</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ä»¶å</label>
                    <input type="text" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${subject}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">æœ¬æ–‡</label>
                    <textarea class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 h-64">${body}</textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" onclick="document.getElementById('shoot-mail-modal').classList.add('hidden')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" onclick="copyToClipboardAndClose()">ã‚³ãƒ”ãƒ¼ã—ã¦é–‰ã˜ã‚‹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼‰</button>
            </div>
        </div>
      `;
        modal.classList.remove('hidden');
      };

      window.copyToClipboardAndClose = async function () {
        const modal = document.getElementById('shoot-mail-modal');
        const textarea = modal.querySelector('textarea');

        if (textarea) {
          textarea.select();
          document.execCommand('copy');
          showMessage("æœ¬æ–‡ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }

        // Auto Update Status
        const castingId = modal.dataset.castingId;
        const currentStatus = modal.dataset.currentStatus;
        const isCastingItem = modal.dataset.isCastingItem === "true";

        if (castingId && currentStatus) {
          let nextStatus = "";

          if (isCastingItem && ORDER_WAIT_STATUSES.includes(currentStatus)) {
            nextStatus = "æ‰“è¨ºä¸­";
          } else if (currentStatus === "é¦™ç›¤é€£çµ¡å¾…ã¡") {
            nextStatus = "ç™ºæ³¨æ›¸é€ä¿¡å¾…ã¡";
          } else if (currentStatus === "ç™ºæ³¨æ›¸é€ä¿¡å¾…ã¡") {
            nextStatus = "ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡";
          } else if (currentStatus === "ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡") {
            nextStatus = "æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡";
          } else if (currentStatus === "æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡") {
            nextStatus = "å®Œäº†";
          }

          if (nextStatus) {
            if (isCastingItem) {
              // Call Casting Status Update API
              await changeCastingStatus(castingId, nextStatus, "ãƒ¡ãƒ¼ãƒ«ä½œæˆã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°");
            } else {
              // Call Shooting Contact Update API
              await updateShootingContactStatus(castingId, nextStatus);
            }
          }
        }

        modal.classList.add('hidden');
      };

      function openShootStatusModal(castingId, currentStatus) {
        // Legacy manual update if needed, but "Copy" is now the primary driver.
        // Keeping this for manual override.
        let nextStatus = "";
        if (currentStatus === "é¦™ç›¤é€£çµ¡å¾…ã¡") nextStatus = "ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡";
        else if (currentStatus === "ãƒ¡ã‚¤ã‚­ãƒ³ã‚°å…±æœ‰å¾…ã¡") nextStatus = "æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡";
        else if (currentStatus === "æŠ•ç¨¿æ—¥é€£çµ¡å¾…ã¡") nextStatus = "å®Œäº†";

        if (!nextStatus) return;

        if (confirm(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${nextStatus}ã€ã«é€²ã‚ã¾ã™ã‹ï¼Ÿ`)) {
          updateShootingContactStatus(castingId, nextStatus);
        }
      }

      async function updateShootingContactStatus(castingId, newStatus) {
        try {
          const res = await fetch("/api/shooting_contact/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ castingId, status: newStatus })
          });
          if (res.ok) {
            showMessage(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${newStatus}ã€ã«æ›´æ–°ã—ã¾ã—ãŸ`);
            loadShootingContactPage(); // Reload to reflect changes
          } else {
            showMessage("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
          }
        } catch (e) {
          console.error(e);
          showMessage("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error");
        }
      }

      // Generic Update Function for Shooting Contact Fields
      window.updateShootingContactFields = async function (id, fields) {
        try {
          // Calculate cost if IN/OUT changed (Simple logic: just log for now, or implement if rate is known)
          // For now just save the fields

          const payload = {
            id: id,
            ...fields
          };

          // If cost is not manually set but IN/OUT are, we could try to auto-calc here
          // But we don't have hourly rate. So we skip auto-calc for now.

          const res = await fetch("/api/shooting_contact/status", { // Reusing status endpoint or create new?
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            throw new Error("Update failed");
          }
          // Optional: Show toast
        } catch (e) {
          console.error(e);
          showMessage("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
        }
      };

      // Sync Function (GAS Trigger)
      window.syncShootingSchedule = async function (btn, syncType = 'schedule') {
        let label = "é¦™ç›¤DB";
        if (syncType === 'making') label = "ãƒ¡ã‚¤ã‚­ãƒ³ã‚°DB";
        if (syncType === 'post_date') label = "æŠ•ç¨¿æ—¥DB";

        if (!confirm(`${label}ã‹ã‚‰æœ€æ–°æƒ…å ±ã‚’å–å¾—ã—ã¦åŒæœŸã—ã¾ã™ã‹ï¼Ÿ\n(GASã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™)`)) return;

        const originalContent = btn ? btn.innerHTML : `${label}ã¨åŒæœŸ`;
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> åŒæœŸä¸­...`;
        }

        const loading = document.getElementById("shoot-contact-loading");
        if (loading) loading.classList.remove('hidden');

        try {
          const res = await fetch(`/api/sync/gas?type=${syncType}`, { method: "POST" });
          if (res.ok) {
            const data = await res.json();
            const updatedCount = data.gas_response?.updatedRows ?? 0;
            showMessage(`åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆæ›´æ–°: ${updatedCount}ä»¶ï¼‰`, "success");

            await loadShootingContactPage();
          } else {
            const err = await res.json();
            showMessage(`åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.detail || 'Unknown error'}`, "error");
          }
        } catch (e) {
          console.error(e);
          showMessage("åŒæœŸãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error");
        } finally {
          if (loading) loading.classList.add('hidden');
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalContent;
          }
        }
      };



      // ========= New Cart UI (Drag & Drop) =========
      let cartProjects = []; // Array of { id, title, roles: [{ id, name, type, note, castIds: [] }] }

      function renderCartModal() {
        const modal = document.getElementById('cart-modal');
        if (!modal) return;

        // Initialize cartProjects if empty (first open)
        initCartProjects();

        renderNewCartModal(modal);
      }
      window.submitNewOrder = async function () {
        // 1. Auth Check
        const isAuth = await ensureAuth();
        if (!isAuth) {
          // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ›´æ–°ã«å¤±æ•—ã—ãŸå ´åˆã¯ã€æ˜ç¤ºçš„ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ã‚‰ã†
          alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚\nãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™ã®ã§ã€å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
          handleAuthClick(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼‰ã®æµã‚Œã§å‘¼ã¹ã°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã›ã‚“
          return;
        }

        // â– â– â–  è¿½åŠ : ç”»é¢æ›´æ–°å‰ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€€é¿ â– â– â– 
        const fileInput = document.getElementById('order-pdf-file');
        if (fileInput && fileInput.files.length > 0) {
          cartMeta.pdfFiles = fileInput.files;
          console.log("Files saved to memory:", cartMeta.pdfFiles.length);
        }
        // â– â– â–  è¿½åŠ ã“ã“ã¾ã§ â– â– â– 

        // Cleanup: å½¹åãªã©ãŒç©ºã®ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã‚’æƒé™¤
        cartProjects = cartProjects.map(p => {
          const validRoles = p.roles.filter(r => r.name.trim() && r.castIds.length > 0);
          return { ...p, roles: validRoles };
        }).filter(p => p.roles.length > 0);

        // ã‚«ãƒ¼ãƒˆç”»é¢ã‚’å†æç”»ï¼ˆæƒé™¤å¾Œã®çŠ¶æ…‹ã«ã™ã‚‹ãŸã‚ï¼‰
        renderCartModal();

        if (cartProjects.length === 0) {
          showMessage('æœ‰åŠ¹ãªã‚ªãƒ¼ãƒ€ãƒ¼ï¼ˆå½¹åã¨ã‚­ãƒ£ã‚¹ãƒˆãŒå…¥åŠ›ã•ã‚ŒãŸã‚‚ã®ï¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
          return;
        }

        // Validate
        for (const p of cartProjects) {
          if (!p.title.trim()) {
            showMessage('ä½œå“åãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚', 'error');
            return;
          }
        }

        // â˜…ã“ã“ã§ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        renderConfirmationModal();
      }

      function renderConfirmationModal() {
        const modal = document.getElementById('confirmation-modal');
        if (!modal) return;

        // ã€ä¿®æ­£ã€‘ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®å„ªå…ˆé †ä½ã‚’å¤‰æ›´
        // æ–°ã—ã„Drag&Dropã‚«ãƒ¼ãƒˆ(cartProjects)ãŒã‚ã‚‹å ´åˆã¯ãã“ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
        let mainProjectName = '';
        if (cartProjects && cartProjects.length > 0) {
          mainProjectName = cartProjects[0].title;
        } else if (cartMeta && cartMeta.projectNames && cartMeta.projectNames[0]) {
          // å¤ã„ãƒ•ãƒ­ãƒ¼ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          mainProjectName = cartMeta.projectNames[0];
        }

        const booked = currentUser?.email || '';

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä¿®æ­£
        if (!mainProjectName) {
          showMessage('ä½œå“åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
          return;
        }
        if (!booked) {
          // ensureAuthã§ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®ã¯ãšã ãŒå¿µã®ç‚º
          showMessage('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
          return;
        }

        modal.innerHTML = `
      <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
        <h3 class="text-xl font-bold mb-4">æœ€çµ‚ç¢ºèª</h3>
        <p class="text-sm text-gray-600 mb-4">ä½œå“åï¼š<span class="font-bold text-black">${mainProjectName}</span> ä»–</p>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">ã‚¤ãƒ³ãƒ†ã‚£ãƒã‚·ãƒ¼ã‚·ãƒ¼ãƒ³ã®æœ‰ç„¡</label>
            <div class="mt-2 flex space-x-4">
              <label class="inline-flex items-center">
                <input type="radio" name="intimacy" value="ã‚ã‚Š" class="form-radio">
                <span class="ml-2 font-bold text-red-600">ã‚ã‚Š</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="intimacy" value="ãªã—" class="form-radio" checked>
                <span class="ml-2">ãªã—</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="intimacy" value="æœªå®š" class="form-radio">
                <span class="ml-2">æœªå®š</span>
              </label>
            </div>
            <p class="text-xs text-gray-500 mt-1">â€»ã€Œã‚ã‚Šã€ã‚’é¸æŠã™ã‚‹ã¨ã€å‚™è€ƒæ¬„ã«è‡ªå‹•è¿½è¨˜ã•ã‚Œã¾ã™ã€‚</p>
          </div>
          <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
            <label class="flex items-start cursor-pointer">
              <input id="child-actor-check" type="checkbox"
                     class="mt-1 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
              <span class="ml-3 text-sm text-gray-700 leading-snug">
                <strong>æœªæˆå¹´è€…ï¼ˆ18æ­³æœªæº€ï¼‰</strong>ãŒå«ã¾ã‚Œã‚‹å ´åˆã€<br>
                åŠ´åƒåŸºæº–æ³•ï¼ˆæ·±å¤œåŠ´åƒã®ç¦æ­¢ãƒ»åŠ´åƒæ™‚é–“åˆ¶é™ãªã©ï¼‰ãŠã‚ˆã³é–¢é€£æ³•è¦ã‚’éµå®ˆã—ãŸæ’®å½±è¨ˆç”»ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚
              </span>
            </label>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button id="confirm-cancel" class="px-4 py-2 rounded-md border border-gray-300 hover:bg-gray-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="confirm-final" class="px-6 py-2 rounded-md bg-blue-600 text-white font-bold shadow hover:bg-blue-700">
            åŒæ„ã—ã¦é€ä¿¡
          </button>
        </div>
      </div>
    `;
        modal.classList.remove('hidden');

        // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        modal.querySelector('#confirm-cancel').addEventListener('click', closeConfirmationModal);

        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
        modal.querySelector('#confirm-final').addEventListener('click', async () => {
          const intimacyValue = modal.querySelector('input[name="intimacy"]:checked').value;
          const childActorConfirmed = modal.querySelector('#child-actor-check').checked;

          // å­å½¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ (cartå†…ã®å…¨ã‚­ãƒ£ã‚¹ãƒˆã‚’å¯¾è±¡)
          const hasChildActor = Object.values(cart).some(item =>
            item.cast && item.cast.age !== null && item.cast.age < 18
          );

          if (hasChildActor && !childActorConfirmed) {
            showMessage(
              'æœªæˆå¹´ã‚­ãƒ£ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚æ³•ä»¤éµå®ˆã®ç¢ºèªã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚',
              'error'
            );
            return;
          }

          // â˜…ã“ã“ã§å®Ÿéš›ã®é€ä¿¡å‡¦ç† (processNewOrderFromModal) ã‚’å‘¼ã¶
          await processNewOrderFromModal({
            intimacy: intimacyValue === 'ã‚ã‚Š',
            childConfirmed: childActorConfirmed
          });
        });
      }

      function closeConfirmationModal() {
        const modal = document.getElementById('confirmation-modal');
        if (modal) modal.classList.add('hidden');
      }

      // Progress Bar Functions
      function showProgressBar(message = "å‡¦ç†ä¸­...", percent = 0) {
        const modal = document.getElementById('progress-modal');
        if (modal) {
          modal.classList.remove('hidden');
          updateProgressBar(message, percent);
        }
      }

      function updateProgressBar(message, percent) {
        const titleEl = document.getElementById('progress-title');
        const msgEl = document.getElementById('progress-message');
        const barEl = document.getElementById('progress-bar-fill');
        const percentEl = document.getElementById('progress-percent');

        if (titleEl) titleEl.textContent = "å‡¦ç†ä¸­..."; // Or dynamic title
        if (msgEl) msgEl.textContent = message;
        if (barEl) barEl.style.width = `${percent}%`;
        if (percentEl) percentEl.textContent = `${percent}%`;
      }

      function hideProgressBar() {
        const modal = document.getElementById('progress-modal');
        if (modal) modal.classList.add('hidden');
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°
      async function processNewOrderFromModal(options) {
        const teamName = selectedShooting ? selectedShooting.team : (currentUser?.name || 'ä¸æ˜');
        const pageId = selectedShooting ? selectedShooting.pageId : '';
        const notionUrl = pageId ? `https://www.notion.so/${pageId.replace(/-/g, '')}` : '';

        // CCè¨­å®š
        let ccString = "";
        if (selectedShooting && window.internalCastMap) {
          const names = [];
          if (selectedShooting.cd) names.push(...selectedShooting.cd.split(/[,ã€]/).map(s => s.trim()));
          if (selectedShooting.fd) names.push(...selectedShooting.fd.split(/[,ã€]/).map(s => s.trim()));
          const ccIds = new Set();
          names.forEach(name => {
            if (window.internalCastMap.has(name)) ccIds.add(window.internalCastMap.get(name));
          });
          if (ccIds.size > 0) ccString = Array.from(ccIds).map(uid => `<@${uid}>`).join(' ');
        }

        // showLoader(true); // Disable global loader in favor of progress bar
        showProgressBar("å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...", 10);

        try {
          await processNewOrder({
            accountName: teamName,
            pageId: pageId,
            notionUrl: notionUrl,
            projects: cartProjects,
            ccString: ccString,
            slackThreadTs: isAdditionalOrderMode && additionalOrderContext ? additionalOrderContext.slackThreadTs : null,
            // â˜…è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
            intimacy: options.intimacy
          });

          updateProgressBar("å®Œäº†ã—ã¾ã—ãŸ", 100);
          await new Promise(r => setTimeout(r, 500)); // Show 100% briefly

          closeCartModal();
          closeConfirmationModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚é–‰ã˜ã‚‹

          // Reset
          cart = {};
          cartProjects = [];
          updateCartCount();
          displayAvailableCasts();

          showMessage('ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚', 'success');

          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åæ˜ ã®ãŸã‚å°‘ã—å¾…ã£ã¦å†èª­ã¿è¾¼ã¿
          setTimeout(() => loadAllData(), 2000);

        } catch (e) {
          console.error(e);
          if (e.status === 401 || e.result?.error?.code === 401) {
            // ensureAuthã§ã‚«ãƒãƒ¼ã—ã¦ã„ã‚‹ã¯ãšã ãŒå¿µã®ç‚º
            showMessage('èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
          } else {
            showMessage('ã‚ªãƒ¼ãƒ€ãƒ¼é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || 'Unknown error'), 'error');
          }
        } finally {
          // showLoader(false);
          hideProgressBar();
        }
      }

      // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰ã¨APIé€ä¿¡ã‚’è¡Œã†é–¢æ•°
      async function processNewOrder(data) {
        const shootDate = selectedShooting ? selectedShooting.date : (selectedDates[0] || '');
        const nowISO = new Date().toISOString();
        const updaterEmail = currentUser?.email || '';
        const internalEvents = [];
        const tempAssignments = {};

        // Collect all orders & Apply Intimacy Note & Conflict Check
        const allOrders = data.projects.flatMap(proj =>
          proj.roles.flatMap((role, rIdx) =>
            role.castIds.map((cid, cIdx) => {
              const cast = cart[cid]?.cast;
              const isInternal = cast?.isInternal;

              // â˜… ã‚¤ãƒ³ãƒ†ã‚£ãƒã‚·ãƒ¼ã‚·ãƒ¼ãƒ³ã‚ã‚Šã®å ´åˆã€å‚™è€ƒã«è¿½è¨˜
              let finalNote = role.note || '';
              if (data.intimacy) {
                finalNote = "ã€ã‚¤ãƒ³ãƒ†ã‚£ãƒã‚·ãƒ¼ã‚·ãƒ¼ãƒ³ã‚ã‚Šã€‘\n" + finalNote;
              }

              // â˜…â˜…â˜… è¿½åŠ : ç«¶åˆãƒã‚§ãƒƒã‚¯ (Conflict Check) for Drag & Drop Cart â˜…â˜…â˜…
              let conflictMsg = null;
              const targetEpoch = toEpochDay(shootDate);

              if (targetEpoch) {
                const conflict = castingData.find(c => {
                  // 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»NGãƒ»å®Œäº†ã¯ç„¡è¦–ï¼‰
                  if (['ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'NG', 'ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°å®Œäº†'].includes(c.status)) return false;

                  // 2. ã‚­ãƒ£ã‚¹ãƒˆIDãƒã‚§ãƒƒã‚¯
                  if (c.castId !== cid) return false;

                  // 3. æ—¥ä»˜é‡è¤‡ãƒã‚§ãƒƒã‚¯
                  const startEpoch = toEpochDay(c.startDate);
                  const endEpoch = toEpochDay(c.endDate);
                  if (startEpoch === null || endEpoch === null) return false;

                  // ç¯„å›²å¤–ãªã‚‰ç„¡è¦–
                  if (targetEpoch < startEpoch || targetEpoch > endEpoch) return false;

                  // 4. ã€Œè‡ªåˆ†è‡ªèº«ã®æ›´æ–°ã€ã‚’é™¤å¤–ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
                  const isSameAccount = (c.accountName || '').trim() === (data.accountName || '').trim();
                  const isSameProject = (c.projectName || '').trim() === (proj.title || '').trim();

                  if (isSameAccount && isSameProject) {
                    return false; // è‡ªåˆ†è‡ªèº«ã®è¿½åŠ ã‚ªãƒ¼ãƒ€ãƒ¼ãªã®ã§ç«¶åˆã§ã¯ãªã„
                  }

                  // ã“ã“ã¾ã§æ¥ãŸã‚‰ç«¶åˆ
                  return true;
                });

                if (conflict) {
                  const holder = conflict.accountName || 'ä»–ãƒãƒ¼ãƒ ';
                  conflictMsg = `â€»å…ˆã«ã€${holder}ã€‘ãŒã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ã„ã¾ã™ï¼ˆ${conflict.status}ï¼‰ã€‚`;
                  console.warn("ğŸš¨ Conflict Detected (D&D):", {
                    me: { account: data.accountName, project: proj.title, date: shootDate },
                    other: { account: conflict.accountName, project: conflict.projectName, status: conflict.status }
                  });
                }
              }
              // â˜…â˜…â˜… è¿½åŠ ã“ã“ã¾ã§ â˜…â˜…â˜…

              return {
                castingId: 'temp_' + Date.now() + '_' + Math.random(),
                roleName: role.name,
                castName: cast?.name || 'ä¸æ˜',
                rank: cIdx + 1,
                note: finalNote.trim(),
                projectName: proj.title,
                slack_user_id: isInternal ? cast.slackMentionId : null,
                castId: cid,
                cast: cast,
                type: role.type,
                conflictInfo: conflictMsg // â˜…è¿½åŠ : ã“ã‚Œã§Slacké€šçŸ¥ã«ã‚¢ãƒ©ãƒ¼ãƒˆãŒå«ã¾ã‚Œã¾ã™
              };
            })
          )
        );

        if (allOrders.length === 0) return;

        const uniqueProjectNames = [...new Set(data.projects.map(p => p.title))].join(' / ');

        // â˜…â˜…â˜… è¿½åŠ : ProjectIDã«åŸºã¥ãã‚¹ãƒ¬ãƒƒãƒ‰è‡ªå‹•å¼•ãå½“ã¦ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        let targetThreadTs = data.slackThreadTs || null;
        let isAdditional = !!targetThreadTs; // æ˜ç¤ºçš„ã«æ¸¡ã•ã‚ŒãŸå ´åˆã¯è¿½åŠ æ‰±ã„

        // ã‚¹ãƒ¬ãƒƒãƒ‰IDãŒæœªæŒ‡å®šã ãŒã€ProjectID (=PageID) ãŒã‚ã‚‹å ´åˆ -> éå»ãƒ­ã‚°ã‚’æ¤œç´¢
        // Note: processNewOrderFromModal passes 'pageId', not 'projectId'
        const searchProjectId = data.projectId || data.pageId;

        if (!targetThreadTs && searchProjectId) {
          // castingDataã‹ã‚‰ã€ŒåŒã˜ProjectIDã€ã‹ã¤ã€Œã‚¹ãƒ¬ãƒƒãƒ‰IDã‚’æŒã£ã¦ã„ã‚‹ã€ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã™
          const existingRecord = castingData.find(c =>
            c.projectId === searchProjectId && c.slackThreadTs
          );

          if (existingRecord) {
            console.log("Found existing thread for ProjectID:", searchProjectId, existingRecord.slackThreadTs);
            targetThreadTs = existingRecord.slackThreadTs;
            isAdditional = true; // è‡ªå‹•å¼•ãå½“ã¦æˆåŠŸ -> è¿½åŠ ã‚ªãƒ¼ãƒ€ãƒ¼æ‰±ã„
          }
        }
        // â˜…â˜…â˜… è¿½åŠ ã“ã“ã¾ã§ â˜…â˜…â˜…

        // 2. Send Slack Notification Payload
        const payload = {
          accountName: data.accountName,
          projectName: uniqueProjectNames,
          projectId: data.pageId,
          dateRanges: [shootDate],
          orders: allOrders.map(o => ({
            castingId: o.castingId,
            roleName: o.roleName,
            castName: o.castName,
            rank: o.rank,
            note: o.note,
            projectName: o.projectName,
            slack_user_id: o.slack_user_id,
            conflictInfo: o.conflictInfo
          })),
          orderType: "pattern_a",
          ccString: data.ccString || "",
          slackThreadTs: targetThreadTs, // â˜…å¤‰æ›´: è‡ªå‹•å–å¾—ã—ãŸIDã‚’ä½¿ç”¨
          isAdditionalOrder: isAdditional // â˜…è¿½åŠ : ãƒ•ãƒ©ã‚°ã‚’é€ä¿¡
        };

        // PDF Upload - Multiple Files Support
        // ã¾ãšé€€é¿ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã€ãªã‘ã‚Œã°DOMã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        let files = cartMeta.pdfFiles;

        if (!files || files.length === 0) {
          const fileInput = document.getElementById('order-pdf-file');
          files = fileInput?.files;
        }

        const formData = new FormData();
        formData.append('payload_str', JSON.stringify(payload));

        if (files && files.length > 0) {
          for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i], files[i].name);
          }
        }

        // Debug Log
        console.log("--- Sending Order ---", {
          threadTs: payload.slackThreadTs,
          conflictCheck: allOrders.map(o => o.conflictInfo).filter(Boolean)
        });

        let slackThreadTs = '';
        let slackPermalink = '';

        updateProgressBar("Slackã«é€šçŸ¥ã‚’é€ä¿¡ä¸­...", 30);

        try {
          const slackRes = await fetch('/api/notify/order_created', {
            method: 'POST',
            body: formData
          });

          if (!slackRes.ok) throw new Error('Slack notification failed');
          const slackData = await slackRes.json();

          // è¿½åŠ ã‚ªãƒ¼ãƒ€ãƒ¼ã®å ´åˆã¯å…ƒã®ã‚¹ãƒ¬ãƒƒãƒ‰IDã‚’ç¶­æŒã€æ–°è¦ãªã‚‰æ–°ã—ã„IDã‚’æ¡ç”¨
          slackThreadTs = data.slackThreadTs || slackData.ts;
          slackPermalink = slackData.permalink;
        } catch (e) {
          console.error("Slack notification error:", e);
        }

        updateProgressBar("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿ä¸­...", 60);

        // 3. Prepare Sheet Rows
        const newRows = [];
        const castGroups = new Map();
        allOrders.forEach(o => {
          if (!castGroups.has(o.castId)) castGroups.set(o.castId, []);
          castGroups.get(o.castId).push(o);
        });

        for (const [castId, orders] of castGroups) {
          const firstOrder = orders[0];
          const cast = firstOrder.cast;

          const mergedProjectName = [...new Set(orders.map(o => o.projectName))].join(' / ');
          const mergedRoleName = orders.map(o => o.roleName).join(' / ');
          const mergedType = [...new Set(orders.map(o => o.type))].join(' / ');
          const mergedNote = orders.map(o => o.note).filter(n => n).join(' / ');

          const minRank = Math.min(...orders.map(o => o.rank));
          const castingId = 'casting_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          const castPriority = getNextCastPriority(castId, shootDate, shootDate, tempAssignments);
          tempAssignments[`${castId}_${shootDate}_${shootDate}`] = castPriority;

          const initialStatus = cast.isInternal ? 'æ‰“è¨ºä¸­' : 'ã‚ªãƒ¼ãƒ€ãƒ¼å¾…ã¡';

          if (cast.isInternal) {
            internalEvents.push({
              accountName: data.accountName,
              projectName: mergedProjectName,
              roleName: mergedRoleName,
              mainSub: mergedType,
              castingId: castingId,
              status: initialStatus,
              start: shootDate,
              end: shootDate,
              email: cast.email,
            });
          }

          const structureData = orders.map(o => ({
            project: o.projectName,
            role: o.roleName,
            rank: o.rank,
            type: o.type,
            note: o.note
          }));
          const structureJson = JSON.stringify(structureData);

          newRows.push([
            castingId, data.accountName, mergedProjectName, mergedRoleName,
            cast.castId, cast.name, shootDate, shootDate, minRank.toString(),
            initialStatus, mergedNote, slackThreadTs, slackPermalink,
            mergedType, '', data.pageId, nowISO, updaterEmail, castPriority,
            cast.isInternal ? 'å†…éƒ¨' : 'å¤–éƒ¨', cast.email || '', '', structureJson
          ]);
        }

        // 4. Batch Append
        if (newRows.length > 0) {
          const appendResult = await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: 'ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ!A2',
            valueInputOption: 'USER_ENTERED',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: newRows }
          });

          const updatedRange = appendResult.result.updates.updatedRange;
          const match = updatedRange.match(/!A(\d+):/);
          if (match) {
            const startRow = parseInt(match[1], 10);
            const rowNumberByCastingId = new Map();
            for (let i = 0; i < newRows.length; i++) {
              if (newRows[i][0]) rowNumberByCastingId.set(newRows[i][0], startRow + i);
            }
            internalEvents.forEach(ev => {
              ev.rowNumber = rowNumberByCastingId.get(ev.castingId) || null;
            });
            await createInternalHoldEvents(internalEvents);
          }
        }
      }

      window.closeCartModal = function () {
        const modal = document.getElementById('cart-modal');
        if (!modal) return;

        // â˜…è¿½åŠ : ã‚«ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹æ™‚ã«ã€ä¿å­˜ã•ã‚Œã¦ã„ãŸPDFãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢ã™ã‚‹
        if (cartMeta && cartMeta.pdfFiles) {
          delete cartMeta.pdfFiles;
          console.log("PDF files cleared from memory.");
        }

        modal.classList.add('hidden');
        modal.innerHTML = '';
        // Reset state? Maybe keep it if user accidentally closes?
        // For now, let's keep it but maybe we should clear it on successful order.
      }

      function renderNewCartModal(modal) {
        const teamName = selectedShooting ? selectedShooting.team : (currentUser?.name || 'ä¸æ˜');
        const pageId = selectedShooting ? selectedShooting.pageId : 'æœªé¸æŠ';

        // Cast Pool (only those in cart but not assigned to any role yet?)
        // Or just list all in cart and allow dragging?
        // User said: "ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ãŸã‚­ãƒ£ã‚¹ãƒˆã®åå‰ãŒä¸‹ã«...ä¸¦ã‚“ã§ã„ã‚‹æƒ³å®š"
        // Let's list all casts in `cart`.
        // If assigned, maybe dim them or remove them?
        // "è¿½åŠ ã—ãŸäººã¯å‰Šé™¤ã‚‚å¯èƒ½" implies we move them.
        // Let's assume "Pool" contains unassigned casts.

        // Cast Pool: Show ALL casts in cart (User request: "æ¶ˆãˆãªã„ã‚ˆã†ã«ã—ã¦æ¬²ã—ã„")
        const allCartCastIds = Object.keys(cart);
        const poolCastIds = allCartCastIds; // No filtering

        modal.innerHTML = `
          <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b bg-gray-50">
              <div>
                <div class="text-sm text-gray-500">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå: <span class="font-bold text-gray-800">${teamName}</span></div>
                <div class="text-sm text-gray-500">PageID: <span class="font-mono text-gray-800">${pageId}</span></div>
              </div>
              <button onclick="closeCartModal()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>

            <!-- Body -->
            <div class="flex-grow flex overflow-hidden">
              <!-- Left: Cast Pool -->
              <div class="w-1/4 border-r bg-gray-50 flex flex-col">
                <div class="p-3 font-bold text-gray-700 border-b">ã‚­ãƒ£ã‚¹ãƒˆãƒ—ãƒ¼ãƒ«</div>
                <div id="cart-cast-pool" class="flex-grow overflow-y-auto p-2 space-y-2">
                  ${poolCastIds.map(cid => renderDraggableCast(cid)).join('')}
                  ${poolCastIds.length === 0 ? '<div class="text-xs text-gray-400 text-center mt-4">ã‚­ãƒ£ã‚¹ãƒˆãŒã„ã¾ã›ã‚“</div>' : ''}
                </div>
              </div>

              <!-- Right: Projects -->
              <div class="w-3/4 flex flex-col bg-white">
                <div id="cart-projects-container" class="flex-grow overflow-y-auto p-4 space-y-6">
                  ${cartProjects.map(p => renderCartProject(p)).join('')}
                </div>
                
                <!-- Add Project Button -->
                <div class="p-4 border-t bg-gray-50 flex justify-center">
                  <button onclick="addCartProject()" class="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-semibold">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    ä½œå“ã‚’è¿½åŠ 
                  </button>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t bg-white flex justify-between items-center">
              <div class="flex items-center gap-2">
                 <label class="text-sm font-bold text-gray-600">PDFæ·»ä»˜:</label>
                 <input type="file" id="order-pdf-file" accept="application/pdf" multiple class="text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
              </div>
              <div class="flex gap-3">
                <button onclick="closeCartModal()" class="px-4 py-2 rounded-md border border-gray-300">é–‰ã˜ã‚‹</button>
                <button onclick="submitNewOrder()" class="px-6 py-2 rounded-md bg-blue-600 text-white font-bold shadow hover:bg-blue-700">
                  ã‚ªãƒ¼ãƒ€ãƒ¼é€ä¿¡
                </button>
              </div>
            </div>
          </div>
        `;

        // Setup Drag & Drop
        setupDragAndDrop();
      }

      function renderDraggableCast(castId) {
        const c = cart[castId]?.cast;
        if (!c) return '';
        return `
          <div class="draggable-cast bg-white p-2 rounded shadow-sm border cursor-move flex items-center gap-2 hover:bg-blue-50 justify-between" draggable="true" data-cast-id="${castId}">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                ${c.imageUrl ? `<img src="${c.imageUrl}" class="w-full h-full object-cover">` : ''}
              </div>
              <div class="text-sm truncate font-medium">${c.name}</div>
            </div>
            <button onclick="removeCastFromCart('${castId}')" class="text-gray-400 hover:text-red-500 text-xs font-bold px-1" title="ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤">âœ•</button>
          </div>
        `;
      }

      window.removeCastFromCart = function (castId) {
        if (cart[castId]) {
          delete cart[castId];
          updateCartCount();
          renderCartModal(); // Re-render modal to update pool
        }
      };

      function renderCartProject(project) {
        return `
          <div class="border rounded-lg p-4 bg-gray-50 relative group" data-project-id="${project.id}">
            <div class="mb-3 flex items-center gap-2">
              <label class="text-sm font-bold text-gray-600 w-16">ä½œå“å</label>
              <input type="text" class="flex-grow border rounded px-2 py-1 text-sm font-bold" 
                     value="${project.title}" onchange="updateProjectTitle('${project.id}', this.value)" placeholder="ä½œå“åã‚’å…¥åŠ›">
              <button onclick="removeCartProject('${project.id}')" class="text-red-400 hover:text-red-600 p-1" title="ä½œå“ã‚’å‰Šé™¤">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </div>

            <div class="space-y-3 pl-4 border-l-2 border-gray-200">
              ${project.roles.map((role, idx) => renderCartRole(project.id, role, idx)).join('')}
            </div>

            <div class="mt-3 pl-4">
              <button onclick="addCartRole('${project.id}')" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                å½¹åã‚’è¿½åŠ 
              </button>
            </div>
          </div>
        `;
      }

      function renderCartRole(projectId, role, index) {
        const rankLabel = `ç¬¬${index + 1}å€™è£œ`; // Or just sequential? User said "å·¦ã‹ã‚‰é †ã«ç¬¬1å€™è£œã€ç¬¬2å€™è£œ" but UI is vertical list of roles?
        // Wait, "ä½œå“å...å½¹å...ã€‡ã€‡ / ã€‡ã€‡ / ã€‡ã€‡ï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§è¿½åŠ ã™ã‚‹å½¢ï¼‰"
        // Ah, one role can have multiple candidates (1st, 2nd...)?
        // "ãã®ã‚«ãƒ©ãƒ ã¯ç¬¬ï¼‘å€™è£œã¨ãªã£ã¦ã„ã¦ã€ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã•ã‚ŒãŸäººã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦è¿½åŠ ã§ãã‚‹ã€‚"
        // "å·¦ã‹ã‚‰é †ã«ç¬¬1å€™è£œã€ç¬¬2å€™è£œã¨ã—ã¦ä¿å­˜ã™ã‚‹ã€‚"
        // So: Role Row -> [Candidate 1] [Candidate 2] ...

        return `
          <div class="bg-white border rounded p-3 shadow-sm" data-role-id="${role.id}">
            <div class="flex items-center gap-2 mb-2">
              <input type="text" class="border rounded px-2 py-1 text-sm w-1/3" 
                     value="${role.name}" onchange="updateRoleName('${projectId}', '${role.id}', this.value)" placeholder="å½¹å">
              
              <select class="border rounded px-2 py-1 text-sm w-24" onchange="updateRoleType('${projectId}', '${role.id}', this.value)">
                <option value="ãƒ¡ã‚¤ãƒ³" ${role.type === 'ãƒ¡ã‚¤ãƒ³' ? 'selected' : ''}>ãƒ¡ã‚¤ãƒ³</option>
                <option value="ãã®ä»–" ${role.type === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option>
              </select>

              <input type="text" class="flex-grow border rounded px-2 py-1 text-sm" 
                     value="${role.note}" onchange="updateRoleNote('${projectId}', '${role.id}', this.value)" placeholder="å‚™è€ƒ">

              <button onclick="removeCartRole('${projectId}', '${role.id}')" class="text-gray-400 hover:text-red-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>

            <!-- Drop Zone for Candidates -->
            <div class="role-drop-zone min-h-[50px] bg-gray-50 border-2 border-dashed border-gray-200 rounded flex items-center gap-2 p-2 overflow-x-auto"
                 data-project-id="${projectId}" data-role-id="${role.id}">
              ${role.castIds.map((cid, cIdx) => `
                <div class="relative group bg-white border rounded px-2 py-1 flex items-center gap-2 shadow-sm min-w-[100px]">
                  <span class="text-xs font-bold text-gray-500 mr-1">${cIdx + 1}</span>
                  <span class="text-sm truncate max-w-[100px]">${cart[cid]?.cast?.name}</span>
                  <button onclick="removeCastFromRole('${projectId}', '${role.id}', '${cid}')" class="ml-auto text-gray-400 hover:text-red-500">
                    &times;
                  </button>
                </div>
              `).join('')}
              <div class="text-xs text-gray-400 italic flex-shrink-0">ã“ã“ã¸ãƒ‰ãƒ©ãƒƒã‚°</div>
            </div>
</content>
      </div>
    `;
      }

      // --- State Updaters ---
      window.addCartProject = function () {
        const newProj = {
          id: 'proj_' + Date.now(),
          title: '',
          roles: []
        };
        // Default 3 roles
        for (let i = 0; i < 3; i++) {
          newProj.roles.push({
            id: 'role_' + Date.now() + '_' + i,
            name: '',
            type: 'ãã®ä»–',
            note: '',
            castIds: []
          });
        }
        cartProjects.push(newProj);
        renderCartModal();
      };

      // Initialize cartProjects with default state if empty
      function initCartProjects() {
        if (cartProjects.length === 0) {
          for (let i = 0; i < 2; i++) {
            window.addCartProject(); // Use window.addCartProject to ensure it's called correctly
          }
        }
      }
      window.removeCartProject = function (pid) {
        cartProjects = cartProjects.filter(p => p.id !== pid);
        renderCartModal();
      };
      window.updateProjectTitle = function (pid, val) {
        const p = cartProjects.find(p => p.id === pid); if (p) p.title = val;
      };
      window.addCartRole = function (pid) {
        const p = cartProjects.find(p => p.id === pid);
        if (p) {
          p.roles.push({ id: 'role_' + Date.now(), name: '', type: 'ãã®ä»–', note: '', castIds: [] });
          renderCartModal();
        }
      };
      window.removeCartRole = function (pid, rid) {
        const p = cartProjects.find(p => p.id === pid);
        if (p) {
          p.roles = p.roles.filter(r => r.id !== rid);
          renderCartModal();
        }
      };
      window.updateRoleName = function (pid, rid, val) {
        const r = findRole(pid, rid); if (r) r.name = val;
      };
      window.updateRoleType = function (pid, rid, val) {
        const r = findRole(pid, rid); if (r) r.type = val;
      };
      window.updateRoleNote = function (pid, rid, val) {
        const r = findRole(pid, rid); if (r) r.note = val;
      };
      window.removeCastFromRole = function (pid, rid, cid) {
        const r = findRole(pid, rid);
        if (r) {
          r.castIds = r.castIds.filter(id => id !== cid);
          renderCartModal();
        }
      };

      function findRole(pid, rid) {
        const p = cartProjects.find(p => p.id === pid);
        return p ? p.roles.find(r => r.id === rid) : null;
      }

      // --- Drag & Drop Handlers ---
      function setupDragAndDrop() {
        const draggables = document.querySelectorAll('.draggable-cast');
        const dropZones = document.querySelectorAll('.role-drop-zone');

        draggables.forEach(d => {
          d.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', d.dataset.castId);
            d.classList.add('opacity-50');
          });
          d.addEventListener('dragend', e => {
            d.classList.remove('opacity-50');
          });
        });

        dropZones.forEach(z => {
          z.addEventListener('dragover', e => {
            e.preventDefault(); // Allow drop
            z.classList.add('bg-blue-50', 'border-blue-300');
          });
          z.addEventListener('dragleave', e => {
            z.classList.remove('bg-blue-50', 'border-blue-300');
          });
          z.addEventListener('drop', e => {
            e.preventDefault();
            z.classList.remove('bg-blue-50', 'border-blue-300');
            const castId = e.dataTransfer.getData('text/plain');
            const pid = z.dataset.projectId;
            const rid = z.dataset.roleId;

            if (castId && pid && rid) {
              const role = findRole(pid, rid);
              if (role && !role.castIds.includes(castId)) {
                role.castIds.push(castId);
                renderCartModal();
              }
            }
          });
        });
      }



      // C-2: æ–°è¦å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«
      async function openNewExternalCastModal() {
        const modal = document.getElementById('new-external-cast-modal');
        if (!modal) return;

        modal.innerHTML = `
          < div class="bg-white rounded-lg shadow-xl max-w-md w-full p-5" >
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-bold">æ–°è¦å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ </h3>
          <button id="new-cast-close" class="text-gray-600 hover:text-gray-800">&times;</button>
        </div>
        <div class="space-y-3">
          <div>
            <label class="text-sm text-gray-700">åå‰ï¼ˆå¿…é ˆï¼‰</label>
            <input id="new-cast-name" type="text" class="mt-1 w-full p-2 border rounded-md" />
          </div>
          <div>
            <label class="text-sm text-gray-700">æ€§åˆ¥</label>
            <select id="new-cast-gender" class="mt-1 w-full p-2 border rounded-md">
              <option value="">æœªé¸æŠ</option>
              <option value="ç”·æ€§">ç”·æ€§</option>
              <option value="å¥³æ€§">å¥³æ€§</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-gray-700">æ‰€å±</label>
            <input id="new-cast-agency" type="text" class="mt-1 w-full p-2 border rounded-md" placeholder="ä¾‹ï¼šãƒ•ãƒªãƒ¼ / ã€‡ã€‡ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³" />
          </div>
          <div>
            <label class="text-sm text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input id="new-cast-email" type="email" class="mt-1 w-full p-2 border rounded-md" />
          </div>
          <div>
            <label class="text-sm text-gray-700">å‚™è€ƒ</label>
            <textarea id="new-cast-notes" class="mt-1 w-full p-2 border rounded-md" rows="2"></textarea>
          </div>
        </div>
        <div class="mt-4 flex justify-end gap-3">
          <button id="new-cast-cancel" class="px-4 py-2 rounded-md border border-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="new-cast-save" class="px-4 py-2 rounded-md bg-blue-600 text-white font-semibold">ä¿å­˜</button>
        </div>
      </div > `;

        modal.classList.remove('hidden');

        modal.querySelector('#new-cast-close')?.addEventListener('click', () => closeNewExternalCastModal());
        modal.querySelector('#new-cast-cancel')?.addEventListener('click', () => closeNewExternalCastModal());
        modal.querySelector('#new-cast-save')?.addEventListener('click', async () => {
          await saveNewExternalCast();
        });
      }

      function closeNewExternalCastModal() {
        const modal = document.getElementById('new-external-cast-modal');
        if (!modal) return;
        modal.classList.add('hidden');
        modal.innerHTML = '';
      }

      async function saveNewExternalCast() {
        const name = document.getElementById('new-cast-name').value.trim();
        if (!name) {
          showMessage('åå‰ã¯å¿…é ˆã§ã™ã€‚', 'error');
          return;
        }
        const gender = document.getElementById('new-cast-gender').value;
        const agency = document.getElementById('new-cast-agency').value.trim() || 'å¤–éƒ¨';
        const email = document.getElementById('new-cast-email').value.trim();
        const notes = document.getElementById('new-cast-notes').value.trim();

        // æ–°è¦ castId ã¯ç°¡æ˜“ã« "ext_" + timestamp ã§ç”Ÿæˆ
        const castId = 'ext_' + Date.now();

        try {
          showLoader(true);
          // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ "ã‚­ãƒ£ã‚¹ãƒˆãƒªã‚¹ãƒˆ" ã« 1 è¡Œè¿½åŠ 
          await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: 'ã‚­ãƒ£ã‚¹ãƒˆãƒªã‚¹ãƒˆ!A2',
            valueInputOption: 'USER_ENTERED',
            insertDataOption: 'INSERT_ROWS',
            resource: {
              values: [[
                castId,      // A: ã‚­ãƒ£ã‚¹ãƒˆID
                name,        // B: åå‰
                gender,      // C: æ€§åˆ¥
                '',          // D: ç”Ÿå¹´æœˆæ—¥ï¼ˆæœªå…¥åŠ›ï¼‰
                agency,      // E: äº‹å‹™æ‰€
                '',          // F: ç”»åƒURL
                0,           // G: å‡ºæ¼”å›æ•°
                email,       // H: ãƒ¡ãƒ¼ãƒ«
                notes,       // I: å‚™è€ƒ
                'å¤–éƒ¨',      // J: å†…éƒ¨/å¤–éƒ¨ãƒ•ãƒ©ã‚°
                ''           // K: Slackãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ID
              ]]
            }
          });

          // ãƒ­ãƒ¼ã‚«ãƒ«ã® castData ã«ã‚‚è¿½åŠ 
          const newCast = {
            castId, name, gender, dateOfBirth: '', age: null,
            agency, imageUrl: '', appearanceCount: 0, email, notes,
            castType: 'å¤–éƒ¨',
            isInternal: false,
            internalType: 'å¤–éƒ¨',
            slackMentionId: '',
          };
          castData.push(newCast);

          // B: ä½œæˆã¨åŒæ™‚ã«ã‚«ãƒ¼ãƒˆã¸è¿½åŠ 
          addToCart(newCast.castId);

          closeNewExternalCastModal();
          showMessage('å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚');
          displayAvailableCasts();
        } catch (e) {
          console.error(e);
          showMessage('å¤–éƒ¨ã‚­ãƒ£ã‚¹ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        } finally {
          showLoader(false);
        }
      }

      // ========= Cart Step1 / Step2 =========
      function renderCartStep1(modal) {
        modal.innerHTML = `
          < div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6" >
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold">STEP1ï¼šã‚ªãƒ¼ãƒ€ãƒ¼æƒ…å ±ã®å…¥åŠ›</h3>
          <button id="cart-step1-close" class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåï¼ˆå¿…é ˆï¼‰</label>
          <input type="text" id="cart-account" class="w-full border rounded px-3 py-2" placeholder="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå" value="${cartMeta.account || ''}">
        </div>
        <div class="grid grid-cols-1 gap-3 mb-4">
          <div>
            <label class="text-sm font-medium text-gray-700 mb-1">ä½œå“å1ï¼ˆå¿…é ˆï¼‰</label>
            <input type="text" id="cart-project-1" class="w-full border rounded px-3 py-2" placeholder="ä½œå“å1" value="${cartMeta.projectNames?.[0] || ''}">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700 mb-1">ä½œå“å2ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="cart-project-2" class="w-full border rounded px-3 py-2" placeholder="ä½œå“å2" value="${cartMeta.projectNames?.[1] || ''}">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700 mb-1">ä½œå“å3ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="cart-project-3" class="w-full border rounded px-3 py-2" placeholder="ä½œå“å3" value="${cartMeta.projectNames?.[2] || ''}">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Notion URL (ä»»æ„)</label>
            <input type="text" id="cart-notion" class="w-full border rounded px-3 py-2" placeholder="https://www.notion.so/..." value="${cartMeta.notionUrl || ''}">
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-1">PDFãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ (ä»»æ„)</label>
            <input type="file" id="cart-pdf-file" accept="application/pdf" multiple class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            <p class="text-xs text-gray-500 mt-1">â€»Slacké€šçŸ¥ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚</p>
          </div>
          <div class="flex justify-end">
            <button id="cart-step1-next" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">æ¬¡ã¸</button>
          </div>
        </div>
      </div >
          `;
        modal.classList.remove('hidden');

        // Restore file input if exists in memory (Note: file input value cannot be set programmatically for security, so we just keep the object in cartMeta)
        // If user re-selects, we update.

        modal.querySelector('#cart-step1-close')?.addEventListener('click', () => closeCartModal());

        modal.querySelector('#cart-step1-next').addEventListener('click', () => {
          const acc = document.getElementById('cart-account').value.trim();
          const p1 = document.getElementById('cart-project-1').value.trim();
          const p2 = document.getElementById('cart-project-2').value.trim();
          const p3 = document.getElementById('cart-project-3').value.trim();
          const not = document.getElementById('cart-notion').value.trim();
          const fileInput = document.getElementById('cart-pdf-file');

          if (!acc) { alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã¯å¿…é ˆã§ã™'); return; }
          if (!p1 && !p2 && !p3) { alert('ä½œå“åã¯å°‘ãªãã¨ã‚‚1ã¤å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

          cartMeta.account = acc;
          cartMeta.projectNames = [p1, p2, p3];
          cartMeta.notionUrl = not;

          if (fileInput.files.length > 0) {
            cartMeta.pdfFiles = fileInput.files;
          }

          // A-1: çµ„ã¿åˆã‚ã›ä½œå“åã‚’ç”Ÿæˆ
          const baseTitles = cartMeta.projectNames
            .map(t => (t || '').trim())
            .filter(t => t);

          const comboTitles = [];
          // 2ä½œå“ã®çµ„ã¿åˆã‚ã›
          if (baseTitles.length > 1) {
            for (let i = 0; i < baseTitles.length; i++) {
              for (let j = i + 1; j < baseTitles.length; j++) {
                comboTitles.push(`${baseTitles[i]}/${baseTitles[j]}`);
              }
            }
          }
          // 3ä½œå“ã™ã¹ã¦ã®çµ„ã¿åˆã‚ã›
          if (baseTitles.length === 3) {
            comboTitles.push(`${baseTitles[0]}/${baseTitles[1]}/${baseTitles[2]}`);
          }
          cartMeta.combinedProjectNames = comboTitles;

          cartStep = 2;
          renderCartModal();
        });
      }


      function renderCartStep2(modal) {
        const items = Object.values(cart);

        // A-2.1: å˜ä½“ä½œå“ã¨çµ„ã¿åˆã‚ã›ä½œå“ã‚’å€™è£œãƒªã‚¹ãƒˆåŒ–
        const baseTitles = (cartMeta.projectNames || []).map(t => t.trim()).filter(t => t);
        const comboTitles = cartMeta.combinedProjectNames || [];
        const allTitles = [...baseTitles, ...comboTitles];

        const projectOptions = allTitles
          .map(p => `<option value="${p}">${p}</option>`)
          .join('');

        modal.innerHTML = `
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full p-6">
        <h3 class="text-xl font-bold mb-4">STEP2ï¼šã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã®ç´ä»˜ã‘</h3>
        <div class="max-h-[70vh] overflow-y-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="bg-gray-100">
                <th class="px-4 py-2 text-left">ã‚­ãƒ£ã‚¹ãƒˆå</th>
                <th class="px-4 py-2 text-left">ä½œå“å</th>
                <th class="px-4 py-2 text-left">åŒºåˆ†</th>
                <th class="px-4 py-2 text-left">å½¹å</th>
                <th class="px-4 py-2 text-left">å€™è£œé †ä½</th>
                <th class="py-2 px-3 text-left">å‚™è€ƒ</th>
                <th class="py-2 px-3 text-center">å‰Šé™¤</th>
              </tr>
            </thead>
            <tbody>
              ${items.map((item, i) => `
                <tr class="border-b" data-cart-item-id="${item.cast.castId}">
                  <td class="px-4 py-2 font-bold">${item.cast.name}</td>
                  <td class="py-2 px-3">
                    <select class="cart-item-project w-full p-1 border rounded">
                      <option value="">ä½œå“ã‚’é¸æŠ</option>
                      ${projectOptions}
                    </select>
                  </td>
                  <td class="px-4 py-2">
                    <select class="cart-item-mainsub border rounded px-2 py-1" data-idx="${i}">
                        <option value="ãã®ä»–" ${item.mainSub === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option>
                        <option value="ãƒ¡ã‚¤ãƒ³" ${item.mainSub === 'ãƒ¡ã‚¤ãƒ³' ? 'selected' : ''}>ãƒ¡ã‚¤ãƒ³</option>
                    </select>
                  </td>
                  <td class="py-2 px-3">
                    <input type="text" class="cart-item-role w-full p-1 border rounded"
                           value="${item.roleName || ''}" placeholder="å½¹åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šå¥³1ï¼‰">
                  </td>
                  <td class="py-2 px-3">
                    <input type="number" class="cart-item-rank w-20 p-1 border rounded"
                           value="${item.rank || 1}" min="1">
                  </td>
                  <td class="py-2 px-3">
                    <input type="text" class="cart-item-note w-full p-1 border rounded"
                           value="${item.note || ''}" placeholder="å‚™è€ƒ">
                  </td>
                  <td class="py-2 px-3 text-center">
                    <button class="cart-item-remove text-red-500 hover:text-red-700">
                      &times;
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="mt-6 flex justify-between">
          <button id="cart-step2-back"
                  class="px-4 py-2 border rounded">æˆ»ã‚‹</button>
          <button id="cart-step2-confirm"
                  class="px-4 py-2 bg-blue-600 text-white rounded">
            å†…å®¹ã‚’ç¢ºèªã—ã¦ç¢ºå®šã¸
          </button>
        </div>
      </div>
    `;

        modal.classList.remove('hidden');

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        modal.querySelector('#cart-step2-back')
          .addEventListener('click', () => {
            cartStep = 1;
            renderCartModal();
          });

        modal.querySelector('#cart-step2-confirm')
          .addEventListener('click', () => {
            // æœ€çµ‚ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            renderConfirmationModal();
          });

        modal.querySelectorAll('[data-cart-item-id]').forEach(row => {
          const castId = row.dataset.cartItemId;
          const item = cart[castId];
          if (!item) return;

          const projectEl = row.querySelector('.cart-item-project');
          const roleEl = row.querySelector('.cart-item-role');
          const rankEl = row.querySelector('.cart-item-rank');
          const noteEl = row.querySelector('.cart-item-note');
          const removeEl = row.querySelector('.cart-item-remove');

          // åˆæœŸå€¤è¨­å®š
          if (projectEl) {
            // item.projectName ãŒã‚ã‚Œã°ãã‚Œã‚’é¸æŠã€ãªã‘ã‚Œã°åŸºæœ¬ä½œå“ã®å…ˆé ­
            projectEl.value = item.projectName || baseTitles[0] || '';
            // åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã«ã‚‚ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ›´æ–°
            if (roleEl) {
              roleEl.placeholder = (projectEl.value || '').includes('/')
                ? "å½¹åã‚’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥åŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹ï¼šå¥³1/å‹é”ï¼‰"
                : "å½¹åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šå¥³1ï¼‰";
            }
          }

          // ã‚¤ãƒ™ãƒ³ãƒˆ
          projectEl.addEventListener('change', e => {
            item.projectName = e.target.value;
            // A-2.3: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ›´æ–°
            if (roleEl) {
              roleEl.placeholder = (e.target.value || '').includes('/')
                ? "å½¹åã‚’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥åŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹ï¼šå¥³1/å‹é”ï¼‰"
                : "å½¹åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šå¥³1ï¼‰";
            }
          });

          // â˜…è¿½åŠ : ãƒ¡ã‚¤ãƒ³/ãã®ä»–ã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã¦ä¿å­˜ã™ã‚‹
          const mainSubEl = row.querySelector('.cart-item-mainsub');
          if (mainSubEl) {
            mainSubEl.addEventListener('change', e => {
              item.mainSub = e.target.value;
            });
          }
          // â˜…è¿½åŠ ã“ã“ã¾ã§

          roleEl.addEventListener('input', e => {
            item.roleName = e.target.value;
          });
          rankEl.addEventListener('input', e => {
            item.rank = parseInt(e.target.value, 10) || 1;
          });
          noteEl.addEventListener('input', e => {
            item.note = e.target.value;
          });
          removeEl.addEventListener('click', () => {
            delete cart[castId];
            updateCartCount();
            renderCartModal();
            displayAvailableCasts();
          });
        });
      }
      // ========= Events =========
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (btn.id === 'nav-cart') return; // cartã¯åˆ¥å‡¦ç†
          const viewId = btn.id.replace('nav-', '') + '-view';
          switchView(viewId);

          if (viewId === 'status-view') {
            await renderCastingStatusView(true);
          } else if (viewId === 'management-view') {
            if (isAdmin) {
              // ç®¡ç†ç”»é¢ã‚’é–‹ã„ãŸã‚‰ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ’®å½±é€£çµ¡ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
              showShootContactPage();
            } else {
              document.getElementById('management-view').innerHTML = '<p class="text-gray-600">ç®¡ç†è€…æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
          }
        });
      });

      document.getElementById('shooting-contact-btn')?.addEventListener('click', showShootContactPage);

      // (1790è¡Œç›®ä»˜è¿‘ã® nav-cart ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯æ®‹ã™)
      // (1790è¡Œç›®ä»˜è¿‘ã® nav-cart ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯æ®‹ã™)
      document.getElementById('nav-cart')?.addEventListener('click', e => {
        e.preventDefault();

        // æ’®å½±ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã®åˆ†å²
        if (!selectedShooting) {
          document.getElementById('no-shooting-popup').classList.remove('hidden');
          return;
        }

        const modal = document.getElementById('cart-modal');
        if (!modal) return;

        if (!cartMeta.projectNames[0]) {
          cartStep = 1;
        } else {
          cartStep = 2;
        }
        modal.classList.remove('hidden');
        renderCartModal();
      });

      // No Shooting Popup Events
      document.getElementById('btn-popup-back')?.addEventListener('click', () => {
        document.getElementById('no-shooting-popup').classList.add('hidden');
      });

      document.getElementById('btn-order-external')?.addEventListener('click', () => {
        openSpecialOrderModal('external');
      });

      document.getElementById('btn-order-internal')?.addEventListener('click', () => {
        openSpecialOrderModal('internal');
      });

      // Special Order Logic
      let currentSpecialOrderType = 'external';

      function openSpecialOrderModal(type) {
        document.getElementById('no-shooting-popup').classList.add('hidden');
        const modal = document.getElementById('special-order-modal');
        modal.classList.remove('hidden');
        currentSpecialOrderType = type;

        document.getElementById('special-order-title').textContent = type === 'external' ? 'å¤–éƒ¨æ¡ˆä»¶ã‚ªãƒ¼ãƒ€ãƒ¼' : 'ç¤¾å†…ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ¼ãƒ€ãƒ¼';

        // Handle Dates
        const dateListEl = document.getElementById('special-order-date-list');
        const datesJsonEl = document.getElementById('special-order-dates-json');

        // Use selectedDates if available, otherwise default to today
        let targetDates = selectedDates.length > 0 ? [...selectedDates] : [new Date().toISOString().split('T')[0]];
        targetDates.sort();

        dateListEl.textContent = targetDates.join(', ');
        datesJsonEl.value = JSON.stringify(targetDates);

        // Cast List
        const castListEl = document.getElementById('special-order-cast-list');
        const castNames = Object.values(cart).map(c => c.cast?.name || c.castName || 'ä¸æ˜').join(', ');
        castListEl.textContent = castNames || 'ã‚­ãƒ£ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“';
      }

      document.getElementById('btn-special-cancel')?.addEventListener('click', () => {
        document.getElementById('special-order-modal').classList.add('hidden');
      });

      document.getElementById('btn-special-submit')?.addEventListener('click', async () => {
        const title = document.getElementById('special-order-name').value;
        const datesJson = document.getElementById('special-order-dates-json').value;
        const start = document.getElementById('special-order-start').value;
        const end = document.getElementById('special-order-end').value;
        const castIds = Object.keys(cart);

        if (!title || !datesJson || !start || !end) {
          alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        if (castIds.length === 0) {
          alert('ã‚­ãƒ£ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚«ãƒ¼ãƒˆã«ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        const dates = JSON.parse(datesJson);
        const userEmail = currentUser?.email || 'unknown@example.com';

        showProgressBar("å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...", 10);

        try {
          const payload = {
            orderType: currentSpecialOrderType,
            title: title,
            dates: dates, // Changed from date to dates
            startTime: start,
            endTime: end,
            castIds: castIds,
            ordererEmail: userEmail
          };

          updateProgressBar("ã‚ªãƒ¼ãƒ€ãƒ¼é€ä¿¡ä¸­...", 50);

          const res = await fetch('/api/notify/special_order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) throw new Error('Order failed');

          // â˜…è¿½åŠ : ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²
          const data = await res.json();

          if (data.calendar_events && data.calendar_events.length > 0) {
            updateProgressBar("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²ä¸­...", 80);
            console.log("Creating calendar events:", data.calendar_events);
            // æ—¢å­˜ã®é–¢æ•°ã‚’ä½¿ã£ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²ï¼†ã‚·ãƒ¼ãƒˆæ›¸ãæˆ»ã—
            await createInternalHoldEvents(data.calendar_events);
          }

          updateProgressBar("å®Œäº†ã—ã¾ã—ãŸ", 100);
          await new Promise(r => setTimeout(r, 500));

          document.getElementById('special-order-modal').classList.add('hidden');
          cart = {};
          updateCartCount();
          displayAvailableCasts();
          showMessage('ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');

          // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã—ã¦è¡¨ç¤ºæ›´æ–°
          setTimeout(() => {
            // â˜…ã‚‚ã—ã‚¿ãƒ–ãŒcastingãªã‚‰specialã«åˆ‡ã‚Šæ›¿ãˆã¦ã‚ã’ã‚‹
            if (window.currentStatusTab !== 'special') {
              window.currentStatusTab = 'special';
              switchView('status-view');
            }
            renderCastingStatusView(true);
          }, 1500);

        } catch (e) {
          console.error(e);
          showMessage('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        } finally {
          hideProgressBar();
        }
      });

      document.getElementById('authorize_button')?.addEventListener('click', handleAuthClick);
      document.getElementById('signout_button')?.addEventListener('click', handleSignoutClick);

      document.getElementById('prev-month')?.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
      document.getElementById('next-month')?.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });

      document.getElementById('calendar-grid')?.addEventListener('click', e => {
        const cell = e.target.closest('.calendar-day'); if (!cell?.dataset.date) return;
        const date = cell.dataset.date;
        const idx = selectedDates.indexOf(date);
        if (idx > -1) selectedDates.splice(idx, 1); else selectedDates.push(date);
        selectedDates.sort();
        renderCalendar(); updateSelectedPeriodDisplay();
        renderShootingList(); // Show existing shootings for selected date
        displayAvailableCasts();
      });

      document.body.addEventListener('input', e => { if (e.target.closest('#cast-filters-container')) displayAvailableCasts(); });

      document.body.addEventListener('click', e => {
        const btn = e.target.closest('.add-to-cart-btn'); if (!btn) return;
        addToCart(btn.getAttribute('data-cast-id'));
      });

      // D-2: ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('view-mode-comfort')?.addEventListener('click', () => {
        if (viewMode === 'comfort') return;
        viewMode = 'comfort';
        displayAvailableCasts();
      });
      document.getElementById('view-mode-dense')?.addEventListener('click', () => {
        if (viewMode === 'dense') return;
        viewMode = 'dense';
        displayAvailableCasts();
      });

      // Load GAPI & GIS
      const gapiScript = document.createElement('script'); gapiScript.src = 'https://apis.google.com/js/api.js'; gapiScript.async = true; gapiScript.defer = true; gapiScript.onload = gapiLoaded;
      const gisScript = document.createElement('script'); gisScript.src = 'https://accounts.google.com/gsi/client'; gisScript.async = true; gisScript.defer = true; gisScript.onload = gisLoaded;

      document.head.appendChild(gapiScript);
      document.head.appendChild(gisScript); // â˜…ã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸ
    });

  </script>
</body>

</html>